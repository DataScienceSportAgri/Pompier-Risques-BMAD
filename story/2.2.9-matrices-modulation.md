# Story 2.2.9 : Trois matrices de modulation (gravité, croisée, voisins)

**Status:** Draft  
**Epic:** Epic 2 - Système de Simulation et Prédiction  
**Story Number:** 2.2.9

---

## Story

**As a** système de simulation,  
**I want** appliquer trois matrices de modulation (gravité microzone, types croisés, voisins) dans calcul intensités,  
**so that** les corrélations spatiales et temporelles sont prises en compte dans prédiction J+1.

---

## Acceptance Criteria

1. Matrice gravité microzone: Même type, même microzone, historique 7 jours avec décroissance exponentielle
2. Matrice types croisés: Autres types, même microzone, corrélations spécifiques (ex: incendie→accidents ×1.3)
3. Matrice voisins: 8 zones alentours (radius 1), pondération grave ×1.0, moyen ×0.5, bénin ×0.2, modulée par variabilité locale
4. Intégration dans formule: `λ_calibrated(τ,g) = λ_base(τ,g) × facteur_statique × facteur_gravité × facteur_croisé × facteur_voisins × facteur_long`
5. Normalisation: `Z(t) = Σ_{τ,g} λ_calibrated(τ,g)`
6. Caps: Min ×0.1, Max ×3.0
7. Tests unitaires validant calculs matrices, intégration formule, normalisation, caps

---

## Integration Verification

IV1: Vérifier que les trois matrices sont calculées correctement (historique, corrélations, voisins)  
IV2: Vérifier que l'intégration dans formule intensités calibrées fonctionne (pas d'erreurs, valeurs cohérentes)  
IV3: Vérifier que la normalisation et les caps sont appliqués correctement

---

## Tasks / Subtasks

- [ ] Implémenter matrice gravité microzone (même type, même microzone, historique 7 jours, décroissance exponentielle)
- [ ] Implémenter matrice types croisés (autres types, même microzone, corrélations spécifiques)
- [ ] Implémenter matrice voisins (8 zones radius 1, pondération grave×1.0, moyen×0.5, bénin×0.2, variabilité locale)
- [ ] Implémenter intégration dans formule intensités calibrées
- [ ] Implémenter normalisation (`Z(t) = Σ_{τ,g} λ_calibrated(τ,g)`)
- [ ] Implémenter caps (Min ×0.1, Max ×3.0)
- [ ] Tests : calculs matrices, intégration formule, normalisation, caps

---

## Dev Notes

### Architecture Context

- **Trois matrices de modulation** : Gravité microzone, types croisés, voisins (FR16)
- **Matrice gravité** : Même type, même microzone, historique 7 jours, décroissance exponentielle
- **Matrice types croisés** : Autres types, même microzone, corrélations (ex: incendie→accidents ×1.3)
- **Matrice voisins** : 8 zones radius 1, pondération grave×1.0, moyen×0.5, bénin×0.2, variabilité locale
- **Intégration formule** : `λ_calibrated = λ_base × facteur_statique × facteur_gravité × facteur_croisé × facteur_voisins × facteur_long`
- **Normalisation** : `Z(t) = Σ_{τ,g} λ_calibrated(τ,g)`
- **Caps** : Min ×0.1, Max ×3.0

### Source Tree

```
src/core/generation/
└── intensity_calculator.py  # Calcul intensités calibrées avec matrices

src/core/state/
└── simulation_state.py      # Historique pour matrice gravité
```

### Dependencies

- Vecteurs : Story 2.2.1 (historique pour matrice gravité)
- Voisins : Données adjacents (en dur dans code)
- Patterns : Story 2.2.2 (facteur_long)

### Formule intensités calibrées

```python
# Calcul facteurs
facteur_gravite = calcul_matrice_gravite(microzone, type, historique_7j)
facteur_croise = calcul_matrice_croisee(microzone, type, autres_types)
facteur_voisins = calcul_matrice_voisins(microzone, voisins, variabilite)

# Intensité calibrée
lambda_calibrated = (
    lambda_base *
    facteur_statique *
    facteur_gravite *
    facteur_croise *
    facteur_voisins *
    facteur_long
)

# Normalisation
Z = sum(lambda_calibrated pour tous types et gravités)

# Caps
lambda_calibrated = max(0.1 * lambda_base, min(3.0 * lambda_base, lambda_calibrated))
```

### Testing Standards

- Tests unitaires : Calculs matrices, intégration formule, normalisation, caps
- Tests de validation : Valeurs cohérentes, pas d'erreurs
- Framework : pytest
- Emplacement : `tests/core/generation/test_intensity_calculator.py`

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 28 Jan 2026 | 1.0 | Création story | PM |
