# Story 2.4.3 : Simulation et visualisation (Lancer, Stop, minimal UI)

**Status:** Draft  
**Epic:** Epic 2 - SystÃ¨me de Simulation et PrÃ©diction  
**Story Number:** 2.4.3

---

## Story

**As a** utilisateur,  
**I want** lancer la simulation et voir la progression en temps rÃ©el,  
**so that** je peux suivre l'Ã©volution des risques.

---

## Acceptance Criteria

1. **UI minimale** : [Lancer] et [Stop] fonctionnels ; progression (Jours X/Total, Run X/50, 1 jour = 0.33 s).
2. **ScÃ©nario et VariabilitÃ©** : Les sÃ©lecteurs **ScÃ©nario** (Pessimiste / Standard / Optimiste) et **VariabilitÃ©** (Faible / Moyenne / Forte) sont transmis au clic [Lancer] Ã  `SimulationService.run_one(..., scenario_ui=..., variabilite_ui=...)` (Story 2.4.2.1).
3. **1 run affichÃ©** : **un run** est simulÃ© et affichÃ© Ã  l'Ã©cran (0.33 s/jour) ; les **49 autres runs** sont faits **en calcul seul** (sans affichage, **peuvent Ãªtre lancÃ©s en parallÃ¨le** pour Ã©conomiser espace disque) pour gÃ©nÃ©rer les donnÃ©es ML.
4. **Barre progression 49 runs** : Barre de progression avec pourcentage pour les 49 runs silencieux (multiprocessing sans bloquer UI Streamlit).
5. [Lancer] dÃ©marre ; [Stop] interrompt et sauvegarde l'Ã©tat (**Ã©tat d'urgence** / safe state pour inspection : fichiers crÃ©Ã©s, partie du run).
6. Carte Paris mise Ã  jour en temps rÃ©el ; Ã©vÃ©nements (codes couleur) ; prioritÃ© Feu > Agression > Accident.
7. Colonne gauche : liste Ã©vÃ©nements/incidents (chronologique, gris quand passÃ©, emojis). Colonne droite : rectangles arrondissements (taille fixe, pastel, 3 totaux, emojis).
8. **Graphiques dÃ©taillÃ©s** (clic arrondissement â†’ Ã©volution temporelle) : **Phase 2** uniquement ; MVP = pas de fenÃªtre au clic.
9. Tests manuels : simulation, progression, Lancer/Stop, visualisations, scÃ©nario/variabilitÃ© transmis au lancement.

---

## Integration Verification

IV1: La simulation se lance et s'exÃ©cute correctement (Lancer/Stop, pas d'erreurs).  
IV2: Progression mise Ã  jour en temps rÃ©el ; visualisations cohÃ©rentes (carte, listes, rectangles).

---

## Tasks / Subtasks

- [ ] Brancher sÃ©lecteurs ScÃ©nario et VariabilitÃ© au clic [Lancer] â†’ `SimulationService.run_one(..., scenario_ui=scenario, variabilite_ui=variabilite)` (Story 2.4.2.1)
- [ ] ImplÃ©menter bouton [Lancer] (dÃ©marrage simulation)
- [ ] ImplÃ©menter bouton [Stop] (arrÃªt + sauvegarde Ã©tat d'urgence)
- [ ] ImplÃ©menter affichage progression (Jours X/Total avec %, Run X/50)
- [ ] ImplÃ©menter mise Ã  jour carte Paris en temps rÃ©el (100 microzones)
- [ ] ImplÃ©menter codes couleur Ã©vÃ©nements (prioritÃ© Feu > Agression > Accident)
- [ ] ImplÃ©menter colonne gauche : liste Ã©vÃ©nements/incidents (chronologique, gris passÃ©, emojis)
- [ ] ImplÃ©menter colonne droite : rectangles arrondissements (taille fixe, pastel, 3 totaux, emojis)
- [ ] ImplÃ©menter gestion 50 runs (1 affichÃ© + 49 silencieux en parallÃ¨le avec multiprocessing)
- [ ] ImplÃ©menter multiprocessing sans bloquer UI Streamlit (thread sÃ©parÃ©)
- [ ] ImplÃ©menter barre progression 49 runs silencieux (avec pourcentage)
- [ ] ImplÃ©menter vitesse simulation (1 jour = 0.33 s)
- [ ] ImplÃ©menter Stop (fait derniÃ¨re itÃ©ration journaliÃ¨re puis arrÃªte)
- [ ] ImplÃ©menter sauvegarde Ã©tat d'urgence (pickle format standardisÃ©) lors Stop
- [ ] Tests manuels : simulation, progression, Lancer/Stop, visualisations

---

## Dev Notes

### Architecture Context

- **UI minimale** : Boutons Lancer/Stop + progression en temps rÃ©el (FR18)
- **1 run affichÃ©** : Un run simulÃ© et affichÃ© (0.33 s/jour), 49 autres en calcul seul (FR23)
- **ParallÃ©lisation** : 49 runs peuvent Ãªtre lancÃ©s en parallÃ¨le (multiprocessing) pour Ã©conomiser espace disque
- **Thread sÃ©parÃ©** : Mise Ã  jour temps rÃ©el via thread sÃ©parÃ© (non-bloquant pour UI Streamlit)
- **Stop** : Fait la derniÃ¨re itÃ©ration journaliÃ¨re puis arrÃªte (pas d'arrÃªt brutal)
- **Ã‰tat d'urgence** : Sauvegarde automatique lors Stop (FR18)
- **Carte** : Mise Ã  jour temps rÃ©el avec 100 microzones, Ã©vÃ©nements (FR27)
- **Codes couleur** : Feu (Jaune/Orange/Rouge), Accident (Beige/Marron), Agression (Gris) (FR20)
- **PrioritÃ© affichage** : Grave â†’ Feu > Agression > Accident (FR20)
- **Liste Ã©vÃ©nements** : Chronologique, gris quand passÃ©, emojis (FR25)
- **Rectangles arrondissements** : Taille fixe, pastel, 3 totaux, emojis (FR26)
- **Graphiques dÃ©taillÃ©s** : Phase 2 uniquement (FR21)

### Source Tree

```
src/adapters/ui/
â””â”€â”€ streamlit_app.py         # Application Streamlit (Story 2.4.1)

src/services/
â””â”€â”€ simulation_service.py     # Service simulation (Story 2.2.x)

data/intermediate/
â””â”€â”€ run_XXX/
    â””â”€â”€ safe_state.pkl       # Ã‰tat d'urgence sauvegardÃ©
```

### Dependencies

- Layout Streamlit : Story 2.4.1 (structure de base)
- ParamÃ¨tres ScÃ©nario et VariabilitÃ© : Story 2.4.2.1 (backend + config + trace ; UI transmet valeurs au LANCEMENT)
- SimulationService : Story 2.2.x (gÃ©nÃ©ration, Golden Hour, etc.)
- Orchestration : Story 2.4.2 (main.py)
- Sauvegarde : Story 2.4.5 (sauvegarde/reprise)

### Emojis (FR20, FR25, FR26)

- Incendie : ğŸ”¥ (flamme)
- Agression : ğŸ”ª (couteau)
- Accident : ğŸš— (voiture, taille variable selon gravitÃ©)
- Ã‰vÃ©nement positif : ğŸŒ¹ (rose verte)

### Vitesse simulation

- 1 jour = 0.33 s (cible indicative, NFR2)
- Progression affichÃ©e : Jours X/Total (avec %), Run X/50

### Testing Standards

- Tests manuels : Simulation, progression, Lancer/Stop, visualisations, multiprocessing
- Tests d'intÃ©gration : Mise Ã  jour carte en temps rÃ©el, sauvegarde Ã©tat, thread sÃ©parÃ©
- Tests performance : Validation 0.33 s/jour (benchmarks automatisÃ©s)
- Framework : Tests manuels (pas d'automatisation pour UI Streamlit en MVP)
- Emplacement : Tests manuels documentÃ©s

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 28 Jan 2026 | 1.0 | CrÃ©ation story | PM |
| 28 Jan 2026 | 1.1 | Ajout multiprocessing 49 runs, thread sÃ©parÃ©, barre progression, Stop derniÃ¨re itÃ©ration | PM |
