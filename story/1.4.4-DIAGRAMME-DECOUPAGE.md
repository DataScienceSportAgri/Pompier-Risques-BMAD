# Diagramme de Découpage Story 1.4.4

**Date :** 29 Janvier 2026  
**Auteur :** BMad Orchestrator

---

## Vue d'Ensemble : 6 Stories Testables

```
┌─────────────────────────────────────────────────────────────────┐
│                    STORY 1.4.4 ORIGINALE                        │
│         (Trop large - 8 épics, complexité élevée)               │
└─────────────────────────────────────────────────────────────────┘
                              │
                              │ DÉCOUPE EN
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                   6 STORIES TESTABLES                            │
└─────────────────────────────────────────────────────────────────┘
```

---

## Architecture des Dépendances

```
┌─────────────────────────────────────────────────────────────┐
│  STORY 1.4.4.1 : Matrices Fixes (Pré-calcul)                 │
│  ───────────────────────────────────────────────────────────  │
│  • Intra-type (3×3)                                           │
│  • Inter-type                                                 │
│  • Voisin (8 microzones)                                      │
│  • Saisonnalité                                                │
│  • Trafic (règles)                                             │
│  • Alcool/Nuit (probabilités base)                            │
│                                                                │
│  Dépendances :                                                │
│  ├─ Story 1.2 (distances microzones)                         │
│  └─ Story 1.3 (vecteurs statiques)                           │
└─────────────────────────────────────────────────────────────┘
                            │
                            │ Utilise
                            ▼
┌─────────────────────────────────────────────────────────────┐
│  STORY 1.4.4.2 : Évolution Variables d'État                 │
│  ───────────────────────────────────────────────────────────  │
│  • evoluer_trafic_J1()                                       │
│  • evoluer_incidents_nuit_J1()                               │
│  • evoluer_incidents_alcool_J1()                             │
│                                                                │
│  Dépendances :                                                │
│  ├─ Story 1.4.4.1 (matrices fixes)                           │
│  └─ Story 2.1.2 (structure simulation)                        │
└─────────────────────────────────────────────────────────────┘
                            │
                            │ Utilise
                            ▼
┌─────────────────────────────────────────────────────────────┐
│  STORY 1.4.4.3 : Application Matrices Fixes                  │
│  ───────────────────────────────────────────────────────────  │
│  • Application intra-type                                    │
│  • Application inter-type                                    │
│  • Application voisin                                        │
│  • Application saisonnalité                                   │
│  • calculer_probabilite_incidents_J1() (sans variables)     │
│                                                                │
│  Dépendances :                                                │
│  └─ Story 1.4.4.1 (matrices fixes)                          │
└─────────────────────────────────────────────────────────────┘
                            │
                            │ Combine avec
                            ▼
┌─────────────────────────────────────────────────────────────┐
│  STORY 1.4.4.4 : Intégration Variables d'État                │
│  ───────────────────────────────────────────────────────────  │
│  • Intégration trafic                                        │
│  • Intégration incidents nuit                                │
│  • Intégration incidents alcool                              │
│  • Mise à jour calcul probabilités                           │
│                                                                │
│  Dépendances :                                                │
│  ├─ Story 1.4.4.2 (évolution variables)                     │
│  └─ Story 1.4.4.3 (application matrices)                   │
└─────────────────────────────────────────────────────────────┘
                            │
                            │ Complète avec
                            ▼
┌─────────────────────────────────────────────────────────────┐
│  STORY 1.4.4.5 : Détection Patterns Dynamiques               │
│  ───────────────────────────────────────────────────────────  │
│  • Détection 4j → 7j                                         │
│  • Détection 60j                                             │
│  • Gestion cycle de vie                                      │
│  • Limitation 3 patterns max                                 │
│                                                                │
│  Dépendances :                                                │
│  └─ Story 2.1.2 (structure simulation)                      │
│                                                                │
│  ⚠️ Peut être développée en PARALLÈLE avec 1.4.4.3          │
└─────────────────────────────────────────────────────────────┘
                            │
                            │ Utilise
                            ▼
┌─────────────────────────────────────────────────────────────┐
│  STORY 1.4.4.6 : Application Patterns                        │
│  ───────────────────────────────────────────────────────────  │
│  • Application pattern 7j                                    │
│  • Application pattern 60j                                  │
│  • Intégration dans calcul probabilités                      │
│                                                                │
│  Dépendances :                                                │
│  ├─ Story 1.4.4.5 (détection patterns)                       │
│  └─ Story 1.4.4.4 (intégration variables)                  │
└─────────────────────────────────────────────────────────────┘
```

---

## Flux de Données J→J+1 (Vue Complète)

```
JOUR J (État Actuel)
│
├─ Vecteurs incidents [grave, moyen, bénin] × 3 types
├─ Variables d'état : trafic, incidents_nuit, incidents_alcool
└─ Patterns actifs (si existants)
    │
    │
    ▼
┌─────────────────────────────────────────────────────────┐
│ ÉTAPE 1 : Évolution Variables d'État (Story 1.4.4.2)   │
│                                                          │
│  trafic_J1 = evoluer_trafic_J1(trafic_J, incidents_J)  │
│  incidents_nuit_J1 = evoluer_nuit_J1(...)              │
│  incidents_alcool_J1 = evoluer_alcool_J1(...)          │
└─────────────────────────────────────────────────────────┘
    │
    │
    ▼
┌─────────────────────────────────────────────────────────┐
│ ÉTAPE 2 : Calcul Probabilités (Stories 1.4.4.3 + 4)     │
│                                                          │
│  prob_base = vecteurs_statiques                          │
│  prob_intra = prob_base × matrice_intra_type            │
│  prob_inter = prob_intra + matrice_inter_type            │
│  prob_voisin = prob_inter × matrice_voisin               │
│  prob_trafic = prob_voisin × influence_trafic           │
│  prob_nuit = prob_trafic × influence_nuit                │
│  prob_alcool = prob_nuit × influence_alcool              │
│  prob_saison = prob_alcool × saisonnalité                │
└─────────────────────────────────────────────────────────┘
    │
    │
    ▼
┌─────────────────────────────────────────────────────────┐
│ ÉTAPE 3 : Détection Patterns (Story 1.4.4.5)            │
│                                                          │
│  patterns_actifs = detecter_patterns(historique_7j)     │
│  - Pattern 4j → 7j ?                                     │
│  - Pattern 60j ?                                         │
│  - Limiter à 3 max                                       │
└─────────────────────────────────────────────────────────┘
    │
    │
    ▼
┌─────────────────────────────────────────────────────────┐
│ ÉTAPE 4 : Application Patterns (Story 1.4.4.6)          │
│                                                          │
│  prob_pattern = prob_saison × amplitude_pattern          │
│  - Pattern 7j : +0.1 base, +0.15 pic jour 3             │
│  - Pattern 60j : +0.05 (1-20), -0.05 (21-40), +0.1 (41-60)│
└─────────────────────────────────────────────────────────┘
    │
    │
    ▼
┌─────────────────────────────────────────────────────────┐
│ ÉTAPE 5 : Génération Incidents (Story 2.2.1)             │
│                                                          │
│  nombre_incidents = Poisson(prob_pattern)               │
│  répartition_gravité = Multinomial(nombre, prob_gravités)│
│  déterminer_nuit_alcool(prob_nuit, prob_alcool)         │
└─────────────────────────────────────────────────────────┘
    │
    │
    ▼
JOUR J+1 (Nouvel État)
│
├─ Nouveaux vecteurs incidents
├─ Variables d'état évoluées
└─ Patterns mis à jour (cycle de vie)
```

---

## Matrice de Testabilité

| Story | Tests Unitaires | Tests Intégration | Tests E2E | Couverture Cible |
|-------|----------------|-------------------|-----------|------------------|
| 1.4.4.1 | ✅ Matrices | ✅ Chargement | ❌ | >90% |
| 1.4.4.2 | ✅ Évolution | ✅ Variables | ❌ | >90% |
| 1.4.4.3 | ✅ Application | ✅ Matrices | ❌ | >90% |
| 1.4.4.4 | ✅ Intégration | ✅ Variables+Matrices | ❌ | >90% |
| 1.4.4.5 | ✅ Détection | ✅ Patterns | ❌ | >90% |
| 1.4.4.6 | ✅ Application | ✅ Patterns+Probabilités | ❌ | >90% |
| **Toutes** | ✅ | ✅ | ✅ **Simulation J→J+1** | >85% |

---

## Timeline Suggérée

```
Semaine 1-2 : Story 1.4.4.1 (Matrices fixes)
              └─ Dépend de 1.2 et 1.3 (déjà faites)

Semaine 2-3 : Story 1.4.4.2 (Évolution variables)
              └─ Dépend de 1.4.4.1

Semaine 3-4 : Stories 1.4.4.3 et 1.4.4.5 (PARALLÈLE)
              ├─ 1.4.4.3 : Application matrices
              └─ 1.4.4.5 : Détection patterns

Semaine 4-5 : Story 1.4.4.4 (Intégration variables)
              └─ Dépend de 1.4.4.2 et 1.4.4.3

Semaine 5-6 : Story 1.4.4.6 (Application patterns)
              └─ Dépend de 1.4.4.4 et 1.4.4.5

Semaine 6 : Tests E2E et intégration complète
```

**Durée totale estimée :** 6 semaines (vs 8-10 semaines pour story monolithique)

---

## Points d'Attention

### ⚠️ Risques Identifiés

1. **Dépendances entre stories** : Respecter l'ordre d'implémentation
2. **Interface entre modules** : Définir clairement les contrats (types, formats)
3. **Tests de non-régression** : Vérifier après chaque story
4. **Performance** : Vérifier que le découpage n'impacte pas les performances

### ✅ Mitigations

1. **Contrats clairs** : Définir interfaces (types Python, formats pickle) dès Story 1.4.4.1
2. **Tests automatiques** : CI/CD avec tests après chaque story
3. **Documentation** : Mettre à jour `matrices-correlation-system.md` à chaque story
4. **Benchmarks** : Mesurer performance avant/après chaque story

---

**Document créé le :** 29 Janvier 2026  
**Version :** 1.0  
**Auteur :** BMad Orchestrator
