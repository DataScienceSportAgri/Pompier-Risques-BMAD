# Story 2.4.3.5 : GÃ©olocalisation casernes et hÃ´pitaux sur la carte (Ã©mojis + option afficher/cacher)

**Status:** Draft  
**Epic:** Epic 2 - SystÃ¨me de Simulation et PrÃ©diction  
**Story Number:** 2.4.3.5

---

## Story

**As a** utilisateur,  
**I want** voir les casernes de pompiers et les hÃ´pitaux gÃ©olocalisÃ©s sur la carte avec des Ã©mojis distincts, avec une option pour les afficher ou les cacher,  
**so that** je visualise rapidement l'implantation des ressources (casernes, hÃ´pitaux) sur le territoire parisien.

---

## Acceptance Criteria

### A. DonnÃ©es et affichage

1. **Source des donnÃ©es** : Charger les positions depuis `data/source_data/locations_casernes_hopitaux.pkl` (DataFrame avec colonnes `nom`, `type`, `microzone` â€” Story 1.2, prÃ©-calcul distances).
2. **GÃ©olocalisation** : Les positions sont dÃ©rivÃ©es des centroÃ¯des des microzones associÃ©es (mapping `microzone` â†’ gÃ©omÃ©trie dans `microzones.pkl`).
3. **Marqueurs Ã©mojis** : 
   - **Casernes** : Ã©moji ğŸš’ (camion de pompiers)
   - **HÃ´pitaux** : Ã©moji ğŸ¥ (hÃ´pital)
4. **Tooltip** : Au survol d'un marqueur, afficher le **nom** du lieu (ex. Â« Caserne de la rue du Commerce Â», Â« HÃ´pital Laennec Â»).

### B. Option afficher/cacher

5. **Widget Streamlit** : Une **checkbox** (ou toggle) dans `web_app.py` permettant d'**afficher** ou **cacher** les marqueurs casernes et hÃ´pitaux.
6. **Comportement** : Par dÃ©faut, les marqueurs sont **cachÃ©s** (ou affichÃ©s â€” choix Ã  valider selon prÃ©fÃ©rence UX).
7. **Placement** : Le widget est intÃ©grÃ© dans le bandeau ou la zone de contrÃ´les (Ã  proximitÃ© de la carte, selon specs UI â€” ex. dans le bandeau haut ou un expander Â« Options carte Â»).

### C. Technique et non-rÃ©gression

8. **IntÃ©gration** : Les marqueurs sont ajoutÃ©s dans `build_map_paris()` (ou fonction dÃ©diÃ©e appelÃ©e depuis celle-ci) selon le paramÃ¨tre `show_casernes_hopitaux: bool`.
9. **RÃ©silience** : Si le fichier `locations_casernes_hopitaux.pkl` est absent ou invalide, la carte s'affiche sans marqueurs et sans erreur (log warning).
10. **Tests manuels** : Affichage/cachage des marqueurs, tooltips, pas de rÃ©gression sur le reste de l'interface (carte, simulation, ML).

---

## Integration Verification

IV1: Les casernes et hÃ´pitaux apparaissent sur la carte avec les Ã©mojis ğŸš’ et ğŸ¥ lorsque l'option est activÃ©e.  
IV2: L'option permet de cacher/afficher les marqueurs sans recharger la page.  
IV3: Au survol d'un marqueur, le nom du lieu s'affiche (tooltip).  
IV4: Pas de rÃ©gression sur l'affichage de la carte (microzones, Ã©vÃ©nements, etc.).

---

## Tasks / Subtasks

- [ ] Charger `locations_casernes_hopitaux.pkl` (nom, type, microzone)
- [ ] ImplÃ©menter dÃ©rivation lat/lon depuis centroÃ¯de microzone (microzones.pkl)
- [ ] ImplÃ©menter ajout marqueurs Folium avec DivIcon (Ã©moji ğŸš’ casernes, ğŸ¥ hÃ´pitaux)
- [ ] ImplÃ©menter tooltip au survol (nom du lieu)
- [ ] ImplÃ©menter checkbox Streamlit Â« Afficher casernes et hÃ´pitaux Â»
- [ ] Passer le paramÃ¨tre show_casernes_hopitaux Ã  build_map_paris (ou Ã©quivalent)
- [ ] GÃ©rer l'absence du fichier locations (log warning, carte sans marqueurs)
- [ ] Tests manuels : afficher/cacher, tooltips, non-rÃ©gression

---

## Dev Notes

### Architecture Context

- **DonnÃ©es** : `locations_casernes_hopitaux.pkl` produit par Story 1.2 (script `precompute_distances.py`).
- **Structure** : DataFrame avec colonnes `nom`, `type` (`caserne` | `hopital`), `microzone` (ID microzone).
- **Position** : Pas de lat/lon direct dans le pickle â€” utiliser le centroÃ¯de de la microzone (`microzones.pkl`) pour placer le marqueur.
- **Carte** : Story 2.4.1, 2.4.3 â€” `build_map_paris()` dans `web_app.py`, marqueurs ajoutÃ©s via `folium.Marker` + `folium.DivIcon` (comme pour les Ã©vÃ©nements).

### Source Tree

```
src/ui/
â””â”€â”€ web_app.py               # Checkbox, build_map_paris (marqueurs casernes/hÃ´pitaux)

data/source_data/
â”œâ”€â”€ locations_casernes_hopitaux.pkl
â””â”€â”€ microzones.pkl
```

### DÃ©pendances

- Folium : `folium.Marker`, `folium.DivIcon` (pattern identique Ã  `_add_event_markers`)
- PathResolver : `PathResolver.data_source("locations_casernes_hopitaux.pkl")`, `PathResolver.data_source("microzones.pkl")`
- Story 1.2 : DonnÃ©es prÃ©-calculÃ©es
- Story 2.4.1, 2.4.3 : Carte Paris, microzones, Ã©vÃ©nements

### ImplÃ©mentation suggÃ©rÃ©e

```python
def _add_casernes_hopitaux_markers(
    m: folium.Map,
    microzones: gpd.GeoDataFrame,
    df_locations: pd.DataFrame,
) -> None:
    """Ajoute les marqueurs casernes (ğŸš’) et hÃ´pitaux (ğŸ¥) sur la carte."""
    for _, row in df_locations.iterrows():
        mz_id = row.get("microzone")
        lat, lon = _centroid_from_microzone(microzones, mz_id)
        if lat is None:
            continue
        emoji = "ğŸš’" if row.get("type") == "caserne" else "ğŸ¥"
        icon = folium.DivIcon(html=f'<div style="font-size:1.2rem;">{emoji}</div>', ...)
        folium.Marker([lat, lon], icon=icon, tooltip=row.get("nom", "")).add_to(m)
```

- **Checkbox** : `st.checkbox("ğŸ—ºï¸ Afficher casernes et hÃ´pitaux", value=False)` dans le bandeau ou un expander.

### Gestion erreurs

- Fichier absent : `logger.warning("locations_casernes_hopitaux.pkl non trouvÃ©")` â†’ ne pas ajouter de marqueurs.
- Microzone inconnue : ignorer la ligne (skip) sans erreur.

### Testing Standards

- Tests manuels : afficher/cacher, tooltips, cohÃ©rence positions
- Non-rÃ©gression : carte, simulation, ML inchangÃ©s
- Framework : Tests manuels
- Emplacement : Tests manuels documentÃ©s

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 03 Feb 2026 | 1.0 | CrÃ©ation story | PM |
