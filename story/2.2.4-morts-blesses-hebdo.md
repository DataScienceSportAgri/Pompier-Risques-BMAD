# Story 2.2.4 : Morts et blessés graves hebdomadaires (Étape 4)

**Status:** Draft  
**Epic:** Epic 2 - Système de Simulation et Prédiction  
**Story Number:** 2.2.4

---

## Story

**As a** système de simulation,  
**I want** calculer morts et blessés graves hebdomadaires par arrondissement (Golden Hour, agrégation microzones),  
**so that** les features hebdo incluent ces données critiques.

---

## Acceptance Criteria

1. **Morts** par type (accident, incendie, agression) : **30 % aléatoire, 70 % Golden Hour** (la personne peut mourir malgré le respect de la Golden Hour).
2. **Blessés graves** par type : **60 % aléatoire, 40 % Golden Hour** (gravité pouvant être inhérente à l'accident, pas seulement à la réponse pompiers). Utilisation Golden Hour (2.2.3).
3. **Agrégation microzones → arrondissements** (limites dans pré-calculs Epic 1) ; totaux hebdomadaires.
4. **Alertes** (par arrondissement, sur **800 jours agrégés sur plusieurs runs**) : **au moins 1 mort**, **moins de 500 morts**. Si 0 mort ou ≥ 500 morts → **message d'alerte uniquement** (pas d'action automatique).
5. Tests unitaires : formules, agrégation, seuils.

---

## Integration Verification

IV1: Golden Hour **avant** cette story ; morts/blessés cohérents avec vecteurs.  
IV2: Agrégation correcte (somme, pas moyenne).

---

## Tasks / Subtasks

- [ ] Implémenter calcul morts par type (30% aléatoire, 70% Golden Hour)
- [ ] Implémenter calcul blessés graves par type (60% aléatoire, 40% Golden Hour)
- [ ] Implémenter utilisation Golden Hour (Story 2.2.3) pour calcul casualties
- [ ] Implémenter agrégation microzones → arrondissements (limites pré-calculs Epic 1)
- [ ] Implémenter totaux hebdomadaires par arrondissement
- [ ] Implémenter système alertes (800 jours agrégés, 1-500 morts)
- [ ] Implémenter message alerte (0 mort ou ≥ 500 morts)
- [ ] Tests : formules (30/70, 60/40), agrégation, seuils alertes

---

## Dev Notes

### Architecture Context

- **Morts** : 30% aléatoire, 70% Golden Hour (FR4)
- **Blessés graves** : 60% aléatoire, 40% Golden Hour (FR4)
- **Golden Hour** : Utilisation résultats Story 2.2.3 (si temps_total > 60 min → casualties × 1.3)
- **Agrégation** : Microzones → arrondissements (limites pré-calculs Epic 1, Story 1.2)
- **Totaux hebdomadaires** : Agrégation par semaine pour features (Story 2.2.5)
- **Alertes** : Par arrondissement, sur 800 jours agrégés, 1-500 morts (NFR5)

### Source Tree

```
src/services/
└── casualty_calculator.py   # Calcul morts et blessés graves

src/core/golden_hour/
└── golden_hour.py           # Utilisation résultats Golden Hour (Story 2.2.3)

data/source_data/
└── limites_microzone_arrondissement.pkl  # Limites agrégation (Epic 1)
```

### Dependencies

- Golden Hour : Story 2.2.3 (résultats temps_total, casualties)
- Limites microzones : Epic 1, Story 1.2 (agrégation)
- Vecteurs : Story 2.2.1 (pour connaître incidents)

### Formules

```python
# Morts par type
morts = 0.3 * morts_aleatoires + 0.7 * morts_golden_hour

# Blessés graves par type
blesses_graves = 0.6 * blesses_aleatoires + 0.4 * blesses_golden_hour

# Golden Hour : si temps_total > 60 min → casualties × 1.3
if temps_total > 60:
    casualties *= 1.3
```

### Testing Standards

- Tests unitaires : Formules (30/70, 60/40), agrégation, seuils
- Tests de validation : Alertes (0 mort ou ≥ 500 morts sur 800 jours)
- Framework : pytest
- Emplacement : `tests/services/test_casualty_calculator.py`

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 28 Jan 2026 | 1.0 | Création story | PM |
