# Story 2.2.4 : Morts et blessés graves hebdomadaires (Étape 4)

**Status:** Draft  
**Epic:** Epic 2 - Système de Simulation et Prédiction  
**Story Number:** 2.2.4

---

## Story

**As a** système de simulation,  
**I want** calculer morts et blessés graves hebdomadaires par arrondissement (Golden Hour, agrégation microzones),  
**so that** les features hebdo incluent ces données critiques.

---

## Acceptance Criteria

1. **Morts** par type (accident, incendie, agression) : Calcul à partir de **vecteurs normaux** (Story 2.2.1) + **événements** (Story 2.2.7). **30 % aléatoire, 70 % Golden Hour** (la personne peut mourir malgré le respect de la Golden Hour). Utilisation Golden Hour (Story 2.2.3) avec **tirage au sort** selon probabilité (pas de multiplication par 1.3).
2. **Blessés graves** par type : Calcul à partir de **vecteurs normaux** + **événements**. **60 % aléatoire, 40 % Golden Hour** (gravité pouvant être inhérente à l'accident, pas seulement à la réponse pompiers). Utilisation Golden Hour (Story 2.2.3) avec **tirage au sort** selon probabilité.
3. **Agrégation microzones → arrondissements** (limites dans pré-calculs Epic 1) ; totaux hebdomadaires.
4. **Alertes** (par arrondissement, sur **800 jours agrégés sur plusieurs runs**) : **au moins 1 mort**, **moins de 500 morts**. Si 0 mort ou ≥ 500 morts → **message d'alerte uniquement** (pas d'action automatique).
5. Tests unitaires : formules, agrégation, seuils.

---

## Integration Verification

IV1: Golden Hour **avant** cette story ; morts/blessés cohérents avec vecteurs.  
IV2: Agrégation correcte (somme, pas moyenne).

---

## Tasks / Subtasks

- [x] Implémenter calcul morts par type à partir vecteurs normaux + événements (30% aléatoire, 70% Golden Hour)
- [x] Implémenter calcul blessés graves par type à partir vecteurs normaux + événements (60% aléatoire, 40% Golden Hour)
- [x] Implémenter utilisation Golden Hour (Story 2.2.3) avec tirage au sort selon probabilité (pas ×1.3)
- [x] Implémenter agrégation microzones → arrondissements (limites pré-calculs Epic 1)
- [x] Implémenter totaux hebdomadaires par arrondissement
- [x] Implémenter système alertes (800 jours agrégés, 1-500 morts)
- [x] Implémenter message alerte (0 mort ou ≥ 500 morts)
- [x] Tests : formules (30/70, 60/40), agrégation, seuils alertes

---

## Dev Notes

### Architecture Context

- **Morts** : 30% aléatoire, 70% Golden Hour (FR4). Calcul à partir de **vecteurs normaux** (Story 2.2.1) + **événements** (Story 2.2.7).
- **Blessés graves** : 60% aléatoire, 40% Golden Hour (FR4). Calcul à partir de **vecteurs normaux** + **événements**.
- **Golden Hour** : Utilisation résultats Story 2.2.3 avec **tirage au sort** selon probabilité (pas de multiplication par 1.3). Probabilité augmente avec dépassement Golden Hour.
- **Agrégation** : Microzones → arrondissements (limites pré-calculs Epic 1, Story 1.2)
- **Totaux hebdomadaires** : Agrégation par semaine pour features (Story 2.2.5)
- **Alertes** : Par arrondissement, sur 800 jours agrégés, 1-500 morts (NFR5)

### Source Tree

```
src/services/
└── casualty_calculator.py   # Calcul morts et blessés graves

src/core/golden_hour/
└── golden_hour.py           # Utilisation résultats Golden Hour (Story 2.2.3)

data/source_data/
└── limites_microzone_arrondissement.pkl  # Limites agrégation (Epic 1)
```

### Dependencies

- Golden Hour : Story 2.2.3 (résultats temps_total, casualties)
- Limites microzones : Epic 1, Story 1.2 (agrégation)
- Vecteurs : Story 2.2.1 (pour connaître incidents)

### Formules

```python
# Morts par type (vecteurs normaux + événements)
morts_vecteurs = calcul_morts_vecteurs(vecteurs_jour_j)
morts_evenements = calcul_morts_evenements(evenements_jour_j)
morts_totaux = morts_vecteurs + morts_evenements

# Tirage au sort selon Golden Hour (Story 2.2.3)
prob_mort = golden_hour.get_probabilite_mort(temps_total)
if random() < prob_mort:
    morts_final = 0.3 * morts_aleatoires + 0.7 * morts_totaux
else:
    morts_final = 0.3 * morts_aleatoires

# Même logique pour blessés graves
```

### Testing Standards

- Tests unitaires : Formules (30/70, 60/40), agrégation, seuils
- Tests de validation : Alertes (0 mort ou ≥ 500 morts sur 800 jours)
- Framework : pytest
- Emplacement : `tests/services/test_casualty_calculator.py`

---

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (via Cursor)

### Completion Notes
- ✅ Calcul morts par type : `_calculer_morts_vecteurs()` et `_calculer_morts_evenements()` avec 30% aléatoire, 70% Golden Hour
- ✅ Calcul blessés graves par type : `_calculer_blesses_graves_vecteurs()` avec 60% aléatoire, 40% Golden Hour
- ✅ Utilisation Golden Hour : Intégration `golden_hour_calculator.calculer_golden_hour()` avec tirage au sort selon probabilité (pas ×1.3)
- ✅ Agrégation microzones → arrondissements : `_agreger_microzones_arrondissements()` utilise limites pré-calculées
- ✅ Totaux hebdomadaires : `calculer_casualties_semaine()` agrège 7 jours par arrondissement
- ✅ Système alertes : `verifier_alertes()` avec 800 jours agrégés, seuils 1-500 morts
- ✅ Message alerte : Retourne message si 0 mort ou ≥ 500 morts sur 800 jours
- ✅ Tests unitaires complets : Formules (30/70, 60/40), agrégation, seuils alertes

### File List
**Nouveaux fichiers créés :**
- `src/services/__init__.py` - Module services
- `src/services/casualty_calculator.py` - Calculateur de morts et blessés graves
- `tests/services/__init__.py` - Tests module
- `tests/services/test_casualty_calculator.py` - Tests CasualtyCalculator

### Debug Log References
- Calcul morts : Combinaison 30% aléatoire + 70% Golden Hour avec tirage au sort par incident grave
- Calcul blessés graves : Combinaison 60% aléatoire + 40% Golden Hour avec tirage au sort par incident grave/moyen
- Agrégation : Somme (pas moyenne) des casualties par arrondissement

### Status
Ready for Review

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 28 Jan 2026 | 1.0 | Création story | PM |
| 28 Jan 2026 | 1.1 | Clarification : vecteurs normaux + événements, Golden Hour avec tirage au sort | PM |
| 29 Jan 2026 | 1.2 | Implémentation complète - Calcul morts et blessés graves hebdomadaires | Dev (James) |
