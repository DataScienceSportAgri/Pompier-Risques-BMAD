# Story 2.1.3 : Validation configuration avec Pydantic

**Status:** Draft  
**Epic:** Epic 2 - Système de Simulation et Prédiction  
**Story Number:** 2.1.3

---

## Story

**As a** développeur,  
**I want** valider la configuration avec un schéma Pydantic,  
**so that** les erreurs de configuration sont détectées au démarrage avant l'exécution.

---

## Acceptance Criteria

1. Schéma Pydantic pour validation configuration YAML (`config/config.yaml`).
2. Validation structure : Sections requises (simulation, ml, ui, etc.).
3. Validation valeurs : Types, plages de valeurs, contraintes.
4. Validation chemins : Existence fichiers/dossiers référencés.
5. Validation cohérence : Scénarios, paramètres, dépendances entre sections.
6. Messages d'erreur clairs et explicites pour chaque type d'erreur.
7. Tests unitaires : Validation structure, valeurs, chemins, cohérence.

---

## Integration Verification

IV1: Erreurs de configuration détectées au démarrage (avant simulation).  
IV2: Messages d'erreur clairs et actionnables.

---

## Tasks / Subtasks

- [x] Créer schéma Pydantic pour configuration (structure, types, plages)
- [x] Implémenter validation structure (sections requises)
- [x] Implémenter validation valeurs (types, plages)
- [x] Implémenter validation chemins (existence fichiers/dossiers)
- [x] Implémenter validation cohérence (scénarios, paramètres)
- [x] Implémenter messages d'erreur clairs
- [ ] Intégrer validation dans main.py (Story 2.4.2) - À faire dans story 2.4.2
- [x] Tests : validation structure, valeurs, chemins, cohérence

---

## Dev Notes

### Architecture Context

- **Validation config** : Détection erreurs au démarrage (Architecture v2, config-validation.md)
- **Pydantic** : Bibliothèque validation données Python (types, contraintes)
- **Schéma** : Définit structure exacte config.yaml (sections, types, plages)
- **Intégration** : Utilisé dans main.py (Story 2.4.2) et scripts pré-calculs (Epic 1)

### Source Tree

```
src/core/config/
└── config_validator.py      # Validation config avec Pydantic

config/
└── config.yaml              # Fichier config (Story 1.1)
```

### Dependencies

- Pydantic : Bibliothèque validation
- Config : Story 1.1 (fichier config.yaml)

### Exemple schéma Pydantic

```python
from pydantic import BaseModel, Field, validator
from pathlib import Path

class SimulationConfig(BaseModel):
    days: int = Field(ge=1, le=1000, default=365)
    runs: int = Field(ge=1, le=100, default=50)
    scenario: str = Field(regex="^(pessimiste|moyen|optimiste)$")
    
    @validator('scenario')
    def validate_scenario(cls, v):
        return v

class Config(BaseModel):
    simulation: SimulationConfig
    ml: MLConfig
    ui: UIConfig
    # ...
    
    @validator('*', pre=True)
    def validate_paths(cls, v, field):
        if 'path' in field.name:
            if not Path(v).exists():
                raise ValueError(f"Chemin introuvable: {v}")
        return v
```

### Testing Standards

- Tests unitaires : Validation structure, valeurs, chemins, cohérence
- Tests de validation : Erreurs détectées correctement, messages clairs
- Framework : pytest
- Emplacement : `tests/core/config/`

---

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (via Cursor)

### Completion Notes
- ✅ Schéma Pydantic complet créé pour toutes les sections de config.yaml
- ✅ Validation structure : toutes les sections requises (paths, simulation, scenarios, microzones, golden_hour, ml, precompute)
- ✅ Validation valeurs : types, plages (ge/le/gt), regex (pattern) pour sources
- ✅ Validation chemins : existence et type (dossier) pour tous les chemins dans PathsConfig et PrecomputeVectorsStaticConfig
- ✅ Validation cohérence : source microzones cohérente entre sections (microzones.source vs precompute.microzones.source)
- ✅ Messages d'erreur clairs : amélioration des messages ValidationError avec chemins de champs et descriptions
- ✅ Adaptation Pydantic V2 : utilisation de field_validator et model_validator au lieu de validator
- ✅ Fonctions load_and_validate_config() et validate_config_dict() pour chargement YAML et validation
- ✅ Tests unitaires complets : validation structure, valeurs, chemins, cohérence, champs supplémentaires interdits

### File List
**Nouveaux fichiers créés :**
- `src/core/config/__init__.py`
- `src/core/config/config_validator.py` - Schémas Pydantic et validation complète
- `tests/core/config/__init__.py`
- `tests/core/config/test_config_validator.py` - Tests unitaires complets

**Fichiers modifiés :**
- Aucun (nouveau module)

### Debug Log References
- Adaptation nécessaire pour Pydantic V2 (field_validator, model_validator, pattern au lieu de regex)
- Module yaml requis pour load_and_validate_config() (déjà dans requirements.txt)

### Status
Ready for Review

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 28 Jan 2026 | 1.0 | Création story | PM |
| 29 Jan 2026 | 1.1 | Implémentation complète - Validation configuration avec Pydantic V2 | Dev (James) |
