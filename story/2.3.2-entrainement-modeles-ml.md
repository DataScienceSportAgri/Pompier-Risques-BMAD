# Story 2.3.2 : Entraînement modèles ML — régression et classification

**Status:** Draft  
**Epic:** Epic 2 - Système de Simulation et Prédiction  
**Story Number:** 2.3.2

---

## Story

**As a** système ML,  
**I want** entraîner 4 modèles ML (2 régression, 2 classification) sur données préparées,  
**so that** des prédictions peuvent être faites avec interprétabilité.

---

## Acceptance Criteria

1. **2 régression** : **Huber Regressor**, **Ridge** (pas de régression linéaire simple).
2. **2 classification** : **Logistic Regression**, **XGBoost** (ou 2 parmi LogReg, XGBoost, etc.).
3. Entraînement sur DataFrame final (90 features, labels ; nomenclature sem_m1..m4, voisins_moy)
4. Calcul métriques: MAE, RMSE, R² (régression), Accuracy, Precision, Recall, F1 (classification)
5. Hyperparamètres: Phase 2 (valeurs fixes au début)
6. Sauvegarde modèles avec métadonnées: Nom algorithme, numéro entraînement, paramètres génération données
7. Format sauvegarde: `{algo}_{numero_entrainement}_{params}.joblib` dans `models/regression/` ou `models/classification/`
8. Tests unitaires validant entraînement, métriques, sauvegarde

---

## Integration Verification

IV1: Vérifier que les modèles peuvent être entraînés sans erreur (données valides)  
IV2: Vérifier que les métriques sont calculées correctement (comparaison avec valeurs attendues)  
IV3: Vérifier que les modèles sauvegardés peuvent être rechargés et utilisés pour prédiction

---

## Tasks / Subtasks

- [x] Implémenter entraînement Huber Regressor (régression)
- [x] Implémenter entraînement Ridge (régression)
- [x] Implémenter entraînement Logistic Regression (classification)
- [x] Implémenter entraînement XGBoost (classification)
- [x] Implémenter calcul métriques régression (MAE, RMSE, R²)
- [x] Implémenter calcul métriques classification (Accuracy, Precision, Recall, F1)
- [x] Implémenter sauvegarde modèles avec métadonnées (joblib)
- [x] Implémenter format sauvegarde (`{algo}_{numero}_{params}.joblib`)
- [x] Tests : entraînement, métriques, sauvegarde

---

## Dev Agent Record

### Agent Model Used
(Cursor / Agent dev)

### Completion Notes
- ✅ MLTrainer dans ml_service.py : entraînement 2 régression (Huber Regressor, Ridge) + 2 classification (Logistic Regression, XGBoost)
- ✅ Métriques régression : MAE, RMSE, R² ; classification : Accuracy, Precision, Recall, F1 (macro)
- ✅ Sauvegarde joblib : data/models/regression/{algo}_{numero}_{params}.joblib et data/models/classification/...
- ✅ Métadonnées : algo, numero_entrainement, params, metrics, feature_columns
- ✅ load_model / predict_regression / predict_classification pour rechargement et prédiction
- ✅ XGBoost optionnel (HAS_XGBOOST) si dépendance absente
- ✅ Tests : test_ml_trainer.py (entraînement, métriques, sauvegarde, chargement, prédiction)

### File List
**Fichiers modifiés :**
- `src/services/ml_service.py` - Ajout MLTrainer, métriques, sauvegarde/chargement joblib
- `src/services/__init__.py` - Export MLTrainer
- `requirements.txt` - Ajout joblib, xgboost
- `story/2.3.2-entrainement-modeles-ml.md` - Tasks cochées, Dev Agent Record, 90 features

**Nouveaux fichiers créés :**
- `tests/services/test_ml_trainer.py` - Tests unitaires MLTrainer (entraînement, métriques, sauvegarde)

---

## Dev Notes

### Architecture Context

- **Modèles ML** : 2 régression (Huber Regressor, Ridge) + 2 classification (LogReg, XGBoost) (FR7, FR19)
- **Features** : 90 features (central sem_m1..m4 + voisins_moy sem_m1) (Story 2.3.1)
- **Labels** : Score (régression) ou Classes (classification) (Story 2.2.6)
- **Entraînement** : Une fois les 50 runs terminés (FR23)
- **Métriques** : MAE, RMSE, R² (régression), Accuracy, Precision, Recall, F1 (classification) (NFR9)
- **Sauvegarde** : Format `{algo}_{numero}_{params}.joblib` dans `models/regression/` ou `models/classification/` (FR9)

### Source Tree

```
src/services/
└── ml_service.py            # Entraînement et prédiction ML

data/models/
├── regression/
│   ├── huber_regressor_001_params.joblib
│   └── ridge_001_params.joblib
└── classification/
    ├── logistic_regression_001_params.joblib
    └── xgboost_001_params.joblib
```

### Dependencies

- scikit-learn : Huber Regressor, Ridge, Logistic Regression
- XGBoost : XGBoost classifier
- joblib : Sauvegarde modèles
- Features/labels : Story 2.3.1

### Testing Standards

- Tests unitaires : Entraînement, métriques, sauvegarde
- Tests ML : Métriques (MAE, RMSE, R², Accuracy, F1) + **matrices de confusion pour classification** + tests de prédiction automatiques (prédiction vs réalité)
- Framework : pytest
- Emplacement : `tests/services/test_ml_trainer.py`

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 28 Jan 2026 | 1.0 | Création story | PM |
| 29 Jan 2026 | 1.1 | Implémentation MLTrainer, métriques, joblib, tests ; 144 features | Dev |
| 29 Jan 2026 | 1.2 | Passage à 90 features (nomenclature sem_m1..m4, voisins_moy) | Dev |
