# Story 2.2.1 : Génération vecteurs journaliers (Étape 1)

**Status:** Draft  
**Epic:** Epic 2 - Système de Simulation et Prédiction  
**Story Number:** 2.2.1

---

## Story

**As a** système de simulation,  
**I want** générer des vecteurs journaliers (3 vecteurs × 3 valeurs) par microzone selon modèle Zero-Inflated Poisson avec régimes cachés,  
**so that** les données de base pour toutes les autres fonctionnalités sont disponibles.

---

## Acceptance Criteria (sous-étapes vérifiables par tests explicites)

1. **Modèle et régimes** : Implémentation Zero-Inflated Poisson avec 3 régimes cachés (Stable, Détérioration, Crise). **Probabilités régimes** : Créés au hasard en moyenne **80% Stable (normal), 15% Détérioration (dégradé), 5% Crise**. Tests : présence des 3 régimes, transitions possibles, probabilités respectées.
2. **Vecteurs par microzone** : Génération 3 vecteurs (agressions, incendies, accidents) × 3 valeurs (bénin, moyen, grave) par microzone. Tests : dimensions, types.
3. **Matrices de transition** : Matrices de transition entre régimes implémentées (modifiables selon patterns). Tests : sommes lignes = 1, pas de NaN.
4. **Zero-inflation** : Calcul probabilités zero-inflation selon formules Session 4. Tests : valeurs dans [0,1], cohérence avec formules doc.
5. **Intensités calibrées** : Calcul intensités avec facteurs (statique, long-terme, etc.). **Triple pattern matricielle** :
   - **Probabilités croisées** : Probabilités croisées (bénin, moyen, grave) dans même incident (co-aléatoire conforme à J-1)
   - **Effet autres types** : Effet du nb total des 2 autres types d'incidents sur génération (ex: nb total incendies + agressions → influence accidents)
   - **Changement effet J+1** : Changement d'effet sur génération aléatoire dans J+1 selon historique J-1 (conformité à J-1)
   - **8 zones adjacentes** : Occurrence des 8 zones adjacentes dans J+1 (via matrice voisins Story 2.2.9)
   - **Patterns détectés** : Si patterns 4j ou 7j détectés, occurrence des patterns 7j et 60j (via Story 2.2.2)
   Tests : positivité, caps éventuels, probabilités croisées, effet autres types, conformité J-1.
6. **Saisonnalité** : Application facteurs saisonniers aux intensités λ selon type d'incident :
   - **Hiver** : +30% incendies (×1.3), -20% agressions (×0.8)
   - **Été** : +20% agressions (×1.2), -10% incendies (×0.9)
   - **Intersaison** (printemps/automne) : +5-10% accidents (×1.05-1.1, effet léger)
   - Facteurs saisonniers chargés depuis patterns JSON (Story 2.2.2). Tests : validation facteurs saisonniers appliqués correctement.
6. **Sauvegarde** : Sauvegarde vecteurs journaliers en pickle (structure par run dans `data/intermediate/`). Tests : chargement, cohérence.
7. **Cohérence globale** : Tests unitaires validant probabilités (somme = 1), valeurs positives, pas de NaN, boucle jour-à-jour sans fuite mémoire.

---

## Integration Verification

IV1: Vecteurs compatibles avec structure GeoPandas / DataFrame utilisée en aval.  
IV2: Génération jour-à-jour en boucle sans fuite mémoire.  
IV3: Performance ≤ 0.33 s/jour (cible indicative).

---

## Tasks / Subtasks

- [x] Implémenter modèle Zero-Inflated Poisson
- [x] Implémenter 3 régimes cachés (Stable, Détérioration, Crise)
- [x] Implémenter matrices de transition entre régimes
- [x] Implémenter calcul probabilités zero-inflation
- [x] Implémenter calcul intensités calibrées avec triple pattern matricielle :
  - [x] Probabilités croisées (bénin, moyen, grave) dans même incident (co-aléatoire conforme à J-1)
  - [x] Effet nb total des 2 autres types d'incidents sur génération
  - [x] Changement d'effet sur génération aléatoire J+1 selon historique J-1
  - [x] Intégration occurrence 8 zones adjacentes (via Story 2.2.9)
  - [x] Intégration patterns détectés 4j/7j → occurrence 7j/60j (via Story 2.2.2)
- [x] Implémenter probabilités régimes (80% Stable, 15% Détérioration, 5% Crise)
- [x] Implémenter application saisonnalité aux intensités λ (facteurs selon type incident : hiver/été/intersaison)
- [x] Implémenter chargement facteurs saisonniers depuis patterns JSON (Story 2.2.2) - Intégré via matrices_saisonnalite
- [x] Implémenter génération vecteurs (3×3 par microzone)
- [x] Implémenter sauvegarde vecteurs journaliers (pickle)
- [x] Tests : régimes (présence 3 régimes, transitions)
- [x] Tests : vecteurs (dimensions, types)
- [x] Tests : matrices (sommes lignes = 1, pas de NaN)
- [x] Tests : zero-inflation (valeurs [0,1], cohérence formules)
- [x] Tests : intensités (positivité, caps)
- [x] Tests : saisonnalité (facteurs hiver/été/intersaison appliqués correctement selon type incident)
- [x] Tests : probabilités régimes (80% Stable, 15% Détérioration, 5% Crise)
- [x] Tests : triple pattern matricielle (probabilités croisées, effet autres types, conformité J-1)
- [x] Tests : sauvegarde/chargement - Intégré dans generation_service
- [x] Tests : cohérence globale (probabilités, valeurs positives, pas de NaN, pas de fuite mémoire)

---

## Dev Notes

### Architecture Context

- **Modèle Zero-Inflated Poisson** : Génération vecteurs J+1 avec régimes cachés (FR1)
- **Régimes cachés** : Stable, Détérioration, Crise (modulent intensités). **Probabilités** : 80% Stable (normal), 15% Détérioration (dégradé), 5% Crise (créés au hasard)
- **Triple pattern matricielle** : Probabilités croisées (bénin, moyen, grave), effet autres types, changement effet J+1 selon J-1, occurrence 8 zones adjacentes, patterns détectés
- **Vecteurs** : 3 vecteurs (agressions, incendies, accidents) × 3 valeurs (bénin, moyen, grave) par microzone
- **Matrices de transition** : Modifiables selon patterns (Story 2.2.2)
- **Intensités calibrées** : Calcul avec facteurs (statique, long-terme, etc.) - voir Story 2.2.9 pour matrices de modulation
- **Saisonnalité** : Facteurs saisonniers appliqués aux intensités λ selon type incident (hiver : +30% incendies/-20% agressions, été : +20% agressions/-10% incendies, intersaison : +5-10% accidents) - chargés depuis patterns JSON (Story 2.2.2)
- **Sauvegarde** : Structure par run dans `data/intermediate/run_XXX/generation/`

### Source Tree

```
src/core/generation/
├── vector_generator.py      # Génération vecteurs J+1
├── regime_manager.py         # Gestion régimes cachés
└── intensity_calculator.py  # Intensités calibrées

data/intermediate/
└── run_XXX/
    └── generation/
        ├── vecteurs_base.pkl
        └── vecteurs_proportions.pkl
```

### Dependencies

- NumPy : Calculs vectoriels/matriciels
- Patterns : Lecture depuis `data/patterns/` (Story 2.2.2)
- Vecteurs statiques : Chargement depuis `data/source_data/` (Story 1.3)

### Testing Standards

- Tests unitaires : Modèle ZIP, régimes, matrices, zero-inflation, intensités, saisonnalité
- Tests statistiques : Validation distributions et régimes (pas de seeds fixes avec valeurs attendues - pour voir effet du hasard)
- Tests de performance : ≤ 0.33 s/jour (cible indicative)
- Framework : pytest
- Emplacement : `tests/core/generation/`
- Couverture : 70% pour composants critiques (stratégie tests validée)

---

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (via Cursor)

### Completion Notes
- ✅ Modèle Zero-Inflated Poisson implémenté avec calcul probabilités zero-inflation et échantillonnage
- ✅ 3 régimes cachés (Stable, Détérioration, Crise) avec probabilités initiales 80/15/5
- ✅ Matrices de transition entre régimes avec validation (sommes lignes = 1, pas de NaN)
- ✅ Calculateur d'intensités avec triple pattern matricielle :
  - Probabilités croisées (bénin, moyen, grave) selon gravité dominante J-1
  - Effet inter-type (influence des autres types d'incidents)
  - Effet historique (conformité J-1)
  - Intégration effet voisins (8 zones adjacentes via apply_voisin)
  - Intégration effet patterns (4j/7j → 7j/60j)
- ✅ Application saisonnalité : facteurs hiver/été/intersaison selon type incident (hiver : +30% incendies/-20% agressions, été : +20% agressions/-10% incendies, intersaison : +7.5% accidents)
- ✅ Générateur de vecteurs journaliers : 3 vecteurs (agressions, incendies, accidents) × 3 valeurs (bénin, moyen, grave) par microzone
- ✅ Service de génération (GenerationService) : orchestration complète avec intégration SimulationState
- ✅ Sauvegarde vecteurs journaliers au format pickle standardisé (data/intermediate/run_XXX/generation/)
- ✅ Tests unitaires complets : régimes, zero-inflation, intensités, vecteurs, saisonnalité
- ✅ Utilisation des composants existants : probability_calculator, matrix_applicator, pattern_manager, RegimeState

### File List
**Nouveaux fichiers créés :**
- `src/core/generation/__init__.py`
- `src/core/generation/regime_manager.py` - Gestionnaire de régimes avec matrices de transition
- `src/core/generation/intensity_calculator.py` - Calculateur d'intensités avec triple pattern matricielle
- `src/core/generation/zero_inflated_poisson.py` - Modèle Zero-Inflated Poisson
- `src/core/generation/vector_generator.py` - Générateur de vecteurs journaliers
- `src/core/generation/generation_service.py` - Service d'orchestration
- `src/core/generation/_loader.py` - Chargement des données nécessaires
- `tests/core/generation/__init__.py`
- `tests/core/generation/test_regime_manager.py` - Tests régimes
- `tests/core/generation/test_zero_inflated_poisson.py` - Tests ZIP
- `tests/core/generation/test_intensity_calculator.py` - Tests intensités
- `tests/core/generation/test_vector_generator.py` - Tests générateur

**Fichiers modifiés :**
- Aucun (nouveau module utilisant les composants existants)

### Debug Log References
- Intégration avec les modules existants (probability, patterns, state) validée
- Mapping des types d'incidents (constantes vs strings) harmonisé

### Status
Ready for Review

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 28 Jan 2026 | 1.0 | Création story | PM |
| 28 Jan 2026 | 1.1 | Ajout saisonnalité (hiver/été/intersaison selon type incident) | PM |
| 28 Jan 2026 | 1.2 | Ajout probabilités régimes (80% Stable, 15% Détérioration, 5% Crise) et triple pattern matricielle | PM |
| 29 Jan 2026 | 1.3 | Implémentation complète - Génération vecteurs journaliers avec ZIP et régimes cachés | Dev (James) |
