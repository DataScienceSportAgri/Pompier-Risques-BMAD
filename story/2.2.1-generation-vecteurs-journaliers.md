# Story 2.2.1 : Génération vecteurs journaliers (Étape 1)

**Status:** Draft  
**Epic:** Epic 2 - Système de Simulation et Prédiction  
**Story Number:** 2.2.1

---

## Story

**As a** système de simulation,  
**I want** générer des vecteurs journaliers (3 vecteurs × 3 valeurs) par microzone selon modèle Zero-Inflated Poisson avec régimes cachés,  
**so that** les données de base pour toutes les autres fonctionnalités sont disponibles.

---

## Acceptance Criteria (sous-étapes vérifiables par tests explicites)

1. **Modèle et régimes** : Implémentation Zero-Inflated Poisson avec 3 régimes cachés (Stable, Détérioration, Crise). Tests : présence des 3 régimes, transitions possibles.
2. **Vecteurs par microzone** : Génération 3 vecteurs (agressions, incendies, accidents) × 3 valeurs (bénin, moyen, grave) par microzone. Tests : dimensions, types.
3. **Matrices de transition** : Matrices de transition entre régimes implémentées (modifiables selon patterns). Tests : sommes lignes = 1, pas de NaN.
4. **Zero-inflation** : Calcul probabilités zero-inflation selon formules Session 4. Tests : valeurs dans [0,1], cohérence avec formules doc.
5. **Intensités calibrées** : Calcul intensités avec facteurs (statique, long-terme, etc.). Tests : positivité, caps éventuels.
6. **Sauvegarde** : Sauvegarde vecteurs journaliers en pickle (structure par run dans `data/intermediate/`). Tests : chargement, cohérence.
7. **Cohérence globale** : Tests unitaires validant probabilités (somme = 1), valeurs positives, pas de NaN, boucle jour-à-jour sans fuite mémoire.

---

## Integration Verification

IV1: Vecteurs compatibles avec structure GeoPandas / DataFrame utilisée en aval.  
IV2: Génération jour-à-jour en boucle sans fuite mémoire.  
IV3: Performance ≤ 0.33 s/jour (cible indicative).

---

## Tasks / Subtasks

- [ ] Implémenter modèle Zero-Inflated Poisson
- [ ] Implémenter 3 régimes cachés (Stable, Détérioration, Crise)
- [ ] Implémenter matrices de transition entre régimes
- [ ] Implémenter calcul probabilités zero-inflation
- [ ] Implémenter calcul intensités calibrées
- [ ] Implémenter génération vecteurs (3×3 par microzone)
- [ ] Implémenter sauvegarde vecteurs journaliers (pickle)
- [ ] Tests : régimes (présence 3 régimes, transitions)
- [ ] Tests : vecteurs (dimensions, types)
- [ ] Tests : matrices (sommes lignes = 1, pas de NaN)
- [ ] Tests : zero-inflation (valeurs [0,1], cohérence formules)
- [ ] Tests : intensités (positivité, caps)
- [ ] Tests : sauvegarde/chargement
- [ ] Tests : cohérence globale (probabilités, valeurs positives, pas de NaN, pas de fuite mémoire)

---

## Dev Notes

### Architecture Context

- **Modèle Zero-Inflated Poisson** : Génération vecteurs J+1 avec régimes cachés (FR1)
- **Régimes cachés** : Stable, Détérioration, Crise (modulent intensités)
- **Vecteurs** : 3 vecteurs (agressions, incendies, accidents) × 3 valeurs (bénin, moyen, grave) par microzone
- **Matrices de transition** : Modifiables selon patterns (Story 2.2.2)
- **Intensités calibrées** : Calcul avec facteurs (statique, long-terme, etc.) - voir Story 2.2.9 pour matrices de modulation
- **Sauvegarde** : Structure par run dans `data/intermediate/run_XXX/generation/`

### Source Tree

```
src/core/generation/
├── vector_generator.py      # Génération vecteurs J+1
├── regime_manager.py         # Gestion régimes cachés
└── intensity_calculator.py  # Intensités calibrées

data/intermediate/
└── run_XXX/
    └── generation/
        ├── vecteurs_base.pkl
        └── vecteurs_proportions.pkl
```

### Dependencies

- NumPy : Calculs vectoriels/matriciels
- Patterns : Lecture depuis `data/patterns/` (Story 2.2.2)
- Vecteurs statiques : Chargement depuis `data/source_data/` (Story 1.3)

### Testing Standards

- Tests unitaires : Modèle ZIP, régimes, matrices, zero-inflation, intensités
- Tests statistiques : Validation distributions et régimes (pas de seeds fixes avec valeurs attendues - pour voir effet du hasard)
- Tests de performance : ≤ 0.33 s/jour (cible indicative)
- Framework : pytest
- Emplacement : `tests/core/generation/`
- Couverture : 70% pour composants critiques (stratégie tests validée)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 28 Jan 2026 | 1.0 | Création story | PM |
