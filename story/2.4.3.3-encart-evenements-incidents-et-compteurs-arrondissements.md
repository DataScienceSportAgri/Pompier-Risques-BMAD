# Story 2.4.3.3 : Encart Ã©vÃ©nements/incidents (rectangles dynamiques, tooltips) et compteurs arrondissements (totaux + tooltip nuit/alcool)

**Status:** Draft  
**Epic:** Epic 2 - SystÃ¨me de Simulation et PrÃ©diction  
**Story Number:** 2.4.3.3

---

## Story

**As a** utilisateur,  
**I want** voir dans lâ€™encart Ã  gauche de la carte uniquement les Ã©vÃ©nements et incidents graves actifs (sous forme de rectangles, avec nom du type et caractÃ©ristiques au survol), et dans les encarts arrondissements Ã  droite trois compteurs par type dâ€™incident (avec Ã©mojis) qui Ã©voluent dynamiquement, ainsi quâ€™un encart au survol dâ€™un arrondissement avec les sous-totaux bÃ©nins/moyens/graves et les indicateurs nuit/alcool,  
**so that** je comprends en temps rÃ©el quels Ã©vÃ©nements sont en cours, leurs dÃ©tails, et la rÃ©partition des incidents par arrondissement avec le dÃ©tail par gravitÃ© et contexte (nuit, alcool).

---

## Contexte

- **Encart gauche** (Story 2.4.1, 2.4.3) : colonne Â« Ã‰vÃ©nements Â» avec rectangles. Actuellement des rectangles **placeholder** fixes (ex. Â« Accident Â», Â« Evenements Â», Â« Fin de sport Â», Â« â€” Â») sont affichÃ©s en permanence.
- **Objectif encart gauche** : supprimer tous ces rectangles prÃ©alables ; nâ€™afficher que des **rectangles pour les Ã©vÃ©nements/incidents actifs** (Ã©vÃ©nements graves + Ã©vÃ©nements positifs + Ã©ventuellement incidents graves issus des vecteurs). Un rectangle **apparaÃ®t** quand lâ€™Ã©vÃ©nement devient actif et **disparaÃ®t** quand il est terminÃ©. Pour savoir si un Ã©vÃ©nement est actif : utiliser une propriÃ©tÃ© ou une mÃ©thode sur lâ€™objet (ex. `is_active(jour_actuel)` ou `jour_actuel in [event.jour, event.jour + event.duration)` ) ; si absent, **crÃ©er** cette logique (ex. sur `Event` / `EventGrave` / `PositiveEvent`).
- **Colonne droite** (Story 2.4.3) : encarts Â« 20 arrondissements Â» avec rectangles pastel. Actuellement un seul libellÃ© par arrondissement (ex. Â« Paris 1er Â»). **Objectif** : trois compteurs par arrondissement (accident, agression, incendie) avec Ã©mojis, mis Ã  jour dynamiquement ; au survol de lâ€™arrondissement, afficher un encart (tooltip / popover) avec sous-totaux bÃ©nins/moyens/graves par type et indicateurs nuit/alcool.

---

## Acceptance Criteria

### A. Encart Ã©vÃ©nements (colonne gauche)

1. **Suppression des placeholders** : Tous les rectangles prÃ©existants dans lâ€™encart Â« Ã‰vÃ©nements Â» (gauche) sont supprimÃ©s. Aucun rectangle fixe Â« Accident Â», Â« Evenements Â», Â« Fin de sport Â», Â« â€” Â», etc.
2. **Rectangles uniquement pour les Ã©vÃ©nements/incidents actifs** : Les rectangles nâ€™apparaissent que pour les **Ã©vÃ©nements actifs** (graves ou positifs) et, si spÃ©cifiÃ©, les **incidents graves** du jour (vecteurs). Un Ã©vÃ©nement est **actif** si `jour_actuel` est dans lâ€™intervalle `[event.jour, event.jour + event.duration)` (pour les Ã©vÃ©nements avec `duration`) ; sinon dÃ©finir ou utiliser une propriÃ©tÃ©/mÃ©thode `is_active(jour_actuel)` (Ã  rechercher dans le modÃ¨le, sinon Ã  crÃ©er).
3. **Disparition Ã  la fin** : DÃ¨s quâ€™un Ã©vÃ©nement est **terminÃ©** (jour_actuel >= event.jour + event.duration ou Ã©quivalent), son rectangle **disparaÃ®t** de lâ€™encart.
4. **Contenu des rectangles** : Chaque rectangle affiche un **libellÃ© clair** : pour les **incidents graves** le **nom du type dâ€™incident** (ex. Â« Accident Â», Â« Agression Â», Â« Incendie Â») ; pour les **Ã©vÃ©nements positifs** un libellÃ© adaptÃ© (ex. Â« Fin travaux Â», Â« Nouvelle caserne Â», Â« AmÃ©lioration matÃ©riel Â»). Style : rectangle pastel (cohÃ©rent avec la charte existante).
5. **CaractÃ©ristiques au survol** : Au **passage de la souris** sur un rectangle (Ã©vÃ©nement ou incident), un **tooltip** (ou encart au survol) affiche les **caractÃ©ristiques** de lâ€™Ã©vÃ©nement/incident : pour un `EventGrave`, afficher les champs utiles (ex. `characteristics`, `casualties_base`, `duration`, type) ; pour un Ã©vÃ©nement positif, les champs pertinents. Format lisible (texte ou liste courte).

### B. Compteurs par arrondissement (colonne droite)

6. **Trois compteurs par arrondissement** : Dans lâ€™encart de chaque arrondissement (colonne droite), afficher **trois compteurs** mis Ã  jour dynamiquement (jour courant) :
   - **Accident** : Ã©moji **voiture + explosion** (ğŸš—ğŸ’¥ ou Ã©quivalent) + nombre total dâ€™accidents de lâ€™arrondissement pour le jour courant.
   - **Agression** : Ã©moji **couteau** (ğŸ”ª) + nombre total dâ€™agressions.
   - **Incendie** : Ã©moji **flamme** (ğŸ”¥) + nombre total dâ€™incendies.
   Les totaux sont dÃ©rivÃ©s des vecteurs du jour (`VectorsState`) agrÃ©gÃ©s par arrondissement (microzone_id â†’ arrondissement, puis somme des benin + moyen + grave par type).
7. **Encart au survol de lâ€™arrondissement** : Lorsque lâ€™utilisateur **passe la souris** sur lâ€™encart dâ€™un arrondissement, un **encart** (tooltip / popover) apparaÃ®t avec :
   - **Sous-totaux par type dâ€™incident** : pour chaque type (accident, agression, incendie), afficher les sous-totaux **bÃ©nins**, **moyens**, **graves** (ex. Â« Accident : 2 bÃ©nins, 1 moyen, 0 grave Â»).
   - **Indicateur nuit** : pour les incidents commis **la nuit** : afficher lâ€™Ã©moji **lune** (ğŸŒ™) + lâ€™Ã©moji du type dâ€™incident (ğŸš—ğŸ’¥, ğŸ”ª, ğŸ”¥) et le nombre ou la liste (ex. Â« ğŸŒ™ğŸš—ğŸ’¥ 1 Â»). Si le modÃ¨le de donnÃ©es nâ€™expose pas encore le flag Â« nuit Â» par incident, documenter en Dev Notes et afficher Â« â€” Â» ou prÃ©voir une extension du modÃ¨le (story dÃ©diÃ©e ou tÃ¢che).
   - **Indicateur alcool** : pour les incidents commis **avec alcool** : afficher lâ€™Ã©moji **verre dâ€™alcool** (ğŸ·) + lâ€™Ã©moji du type dâ€™incident et le nombre (ex. Â« ğŸ·ğŸ”ª 1 Â»). Si le modÃ¨le nâ€™expose pas le flag Â« alcool Â», mÃªme rÃ¨gle : documenter et afficher Â« â€” Â» ou prÃ©voir extension.

### C. Technique et non-rÃ©gression

8. **MÃ©thode Â« actif Â» / Â« terminÃ© Â»** : Si les objets `Event` / `EventGrave` / `PositiveEvent` nâ€™ont pas de propriÃ©tÃ© ou mÃ©thode pour savoir si lâ€™Ã©vÃ©nement est actif Ã  un jour donnÃ©, **ajouter** une mÃ©thode (ex. `is_active(jour: int) -> bool`) ou une fonction utilitaire utilisÃ©e par lâ€™UI. Sâ€™appuyer sur `event.jour` et `event.duration` (pour les Ã©vÃ©nements qui ont une durÃ©e).
9. **Source des donnÃ©es** : Encart gauche = `SimulationState.events_state` + Ã©ventuellement vecteurs du jour pour incidents graves. Colonne droite = `SimulationState.vectors_state` agrÃ©gÃ© par arrondissement (mapping microzone_id â†’ arrondissement Ã  dÃ©finir ou rÃ©utiliser depuis le code existant).
10. **Tests manuels** : VÃ©rifier apparition/disparition des rectangles, tooltips Ã©vÃ©nements, compteurs dynamiques, tooltip arrondissement avec sous-totaux ; si nuit/alcool non disponibles, vÃ©rifier que lâ€™affichage reste cohÃ©rent (ex. Â« â€” Â»).

---

## Integration Verification

IV1: Aucun rectangle placeholder dans lâ€™encart gauche ; seuls des rectangles dâ€™Ã©vÃ©nements/incidents actifs sont affichÃ©s, et ils disparaissent aprÃ¨s la fin de lâ€™Ã©vÃ©nement.  
IV2: Au survol dâ€™un rectangle Ã©vÃ©nement/incident, les caractÃ©ristiques sont visibles (tooltip).  
IV3: Chaque encart arrondissement affiche bien trois compteurs (ğŸš—ğŸ’¥, ğŸ”ª, ğŸ”¥) mis Ã  jour selon le jour courant.  
IV4: Au survol dâ€™un arrondissement, lâ€™encart affiche les sous-totaux bÃ©nins/moyens/graves par type et, si les donnÃ©es existent, les indicateurs ğŸŒ™ et ğŸ·.

---

## Tasks / Subtasks

- [x] Supprimer tous les rectangles placeholder de lâ€™encart Â« Ã‰vÃ©nements Â» (colonne gauche) dans `web_app.py`.
- [x] Ajouter ou utiliser une logique Â« Ã©vÃ©nement actif Â» : mÃ©thode `is_active(jour)` sur Event/EventGrave/PositiveEvent ou fonction utilitaire ; sâ€™appuyer sur `jour` et `duration`.
- [x] RÃ©cupÃ©rer les Ã©vÃ©nements actifs pour le jour courant depuis `EventsState` (et incidents graves du jour si inclus) et afficher un rectangle par Ã©vÃ©nement/incident actif (libellÃ© = type dâ€™incident pour incidents, libellÃ© Ã©vÃ©nement pour positifs).
- [x] ImplÃ©menter le tooltip au survol des rectangles (caractÃ©ristiques : characteristics, casualties_base, duration, type, etc.).
- [x] Pour la colonne arrondissements : calculer les totaux par arrondissement et par type (accident, agression, incendie) Ã  partir de `VectorsState` pour le jour courant (microzone_id â†’ arrondissement).
- [x] Afficher dans chaque encart arrondissement les trois compteurs avec Ã©mojis ğŸš—ğŸ’¥, ğŸ”ª, ğŸ”¥, mis Ã  jour dynamiquement.
- [x] ImplÃ©menter lâ€™encart au survol de lâ€™arrondissement : sous-totaux bÃ©nins/moyens/graves par type ; indicateurs ğŸŒ™ (nuit) et ğŸ· (alcool) si les donnÃ©es sont disponibles (sinon Â« â€” Â» ou extension documentÃ©e).
- [x] Tests manuels : apparition/disparition rectangles, tooltips, compteurs, survol arrondissement.

---

## Dev Notes

### Architecture Context

- **UI** : `src/ui/web_app.py` (Streamlit) â€” colonne gauche `col_events`, colonne droite `col_arr` (ou colonnes PrÃ©diction).
- **Ã‰tat** : `SimulationState` (Story 2.1.2) : `events_state` (EventsState), `vectors_state` (VectorsState). `EventGrave` a `jour`, `duration`, `characteristics`, `casualties_base`, `arrondissement` ; sous-classes `AccidentGrave`, `AgressionGrave`, `IncendieGrave` avec `get_type()` â†’ "accident_grave", "agression_grave", "incendie_grave".
- **VectorsState** : `Dict[microzone_id, Dict[jour, Dict[type_incident, Vector]]]` ; `Vector` a `benin`, `moyen`, `grave`. Pas de champs `nuit` / `alcool` dans Vector actuellement ; patterns alcool/nuit (Story 2.2.2) peuvent Ãªtre une source Ã  exposer plus tard pour lâ€™affichage ğŸŒ™/ğŸ·.
- **Mapping microzone_id â†’ arrondissement** : format `MZ_<arr>_<zone>` ; extraire lâ€™arrondissement depuis lâ€™identifiant (convention Ã  confirmer dans le code ou les donnÃ©es).

### Emojis (alignÃ©s Story 2.4.3 / FR20)

- Accident : ğŸš—ğŸ’¥ (voiture + explosion)
- Agression : ğŸ”ª (couteau)
- Incendie : ğŸ”¥ (flamme)
- Nuit : ğŸŒ™ (lune)
- Alcool : ğŸ· (verre)

### Source Tree

```
src/ui/
â””â”€â”€ web_app.py                    # Encart Ã©vÃ©nements (rectangles dynamiques, tooltips), compteurs arrondissements, tooltip survol

src/core/events/
â””â”€â”€ event.py / event_grave.py / positive_event.py   # MÃ©thode is_active(jour) si ajout
```

### Nuit / Alcool

Si les vecteurs ou Ã©vÃ©nements ne portent pas de flag Â« nuit Â» ou Â« alcool Â», options : (1) afficher Â« â€” Â» dans le tooltip arrondissement ; (2) documenter une extension (attributs ou table dÃ©rivÃ©e) dans une story ou tÃ¢che suivante ; (3) utiliser des patterns existants (ex. Story 2.2.2) pour dÃ©river des indicateurs agrÃ©gÃ©s si disponible.

### Dependencies

- Story 2.4.1 (layout, colonnes, bandeaux)
- Story 2.4.3 (simulation, visualisation, liste Ã©vÃ©nements/incidents, rectangles arrondissements)
- Story 2.1.2 (SimulationState, EventsState, VectorsState)
- Story 2.2.7 (Ã©vÃ©nements graves), 2.2.8 (Ã©vÃ©nements positifs)

---

## Dev Agent Record

### Completion Notes

- **Encart gauche** : Suppression des placeholders ; affichage uniquement des Ã©vÃ©nements actifs (graves + positifs via `get_active_events_for_day`) et des incidents graves issus des vecteurs (Vector.grave > 0). MÃ©thode `is_active(jour)` ajoutÃ©e sur Event (dÃ©faut : jour == self.jour), EventGrave (intervalle [jour, jour + duration)), PositiveEvent hÃ©rite du dÃ©faut. Tooltip via attribut HTML `title` sur chaque rectangle (caractÃ©ristiques, casualties_base, duration, type).
- **Colonne droite (arrondissements)** : Trois compteurs par arrondissement (ğŸš—ğŸ’¥ accident, ğŸ”ª agression, ğŸ”¥ incendie) Ã  partir de `get_totaux_par_arrondissement(state, jour)` ; mapping microzone_id â†’ arrondissement via `microzone_to_arrondissement(MZ_XX_YY â†’ XX)`. Tooltip au survol : sous-totaux bÃ©nins/moyens/graves par type ; ğŸŒ™ (nuit) et ğŸ· (alcool) affichÃ©s Â« â€” Â» (modÃ¨le Vector sans champs nuit/alcool, extension documentÃ©e en Dev Notes).
- **Fichiers modifiÃ©s** : `src/core/events/event.py`, `src/core/events/event_grave.py`, `src/core/state/events_state.py`, `src/ui/web_app.py`.

### File List

- `src/core/events/event.py` (modifiÃ© â€” is_active)
- `src/core/events/event_grave.py` (modifiÃ© â€” is_active)
- `src/core/state/events_state.py` (modifiÃ© â€” get_active_events_for_day)
- `src/ui/web_app.py` (modifiÃ© â€” encart Ã©vÃ©nements dynamique, compteurs arrondissements, tooltips)

---

## Change Log

| Date       | Version | Description                    | Author |
|------------|---------|--------------------------------|--------|
| 30 Jan 2026| 1.0     | CrÃ©ation story (aprÃ¨s 2.4.3.1) | PM     |
| 30 Jan 2026| 1.1     | RenumÃ©rotation 2.4.3.2 â†’ 2.4.3.3 (insertion story test Ã©quilibre) | PM     |
| 30 Jan 2026| 1.2     | ImplÃ©mentation encart Ã©vÃ©nements dynamiques, compteurs arrondissements, tooltips | Dev    |
