# Analyse des données existantes pour Story 2.2.9

## Matrices déjà disponibles dans `data/source_data/`

### 1. `matrices_correlation_intra_type.pkl`
- **Usage actuel** : Utilisé dans `matrix_applicator.py` via `apply_intra_type()`
- **Format** : `Dict[microzone_id, Dict[type_incident, np.ndarray 3x3]]`
- **Fonction** : Transition gravité (bénin, moyen, grave) selon gravité dominante J-1
- **Story 2.2.9** : Correspond partiellement à la "matrice gravité microzone" mais manque :
  - Historique 7 jours (actuellement seulement J-1)
  - Décroissance exponentielle

### 2. `matrices_correlation_inter_type.pkl`
- **Usage actuel** : Utilisé dans `matrix_applicator.py` via `apply_inter_type()`
- **Format** : `Dict[microzone_id, Dict[type_cible, Dict[type_source, List[float]]]]`
- **Fonction** : Influence croisée entre types d'incidents (ex: incendie→accidents)
- **Story 2.2.9** : Correspond à la "matrice types croisés" mais manque :
  - Effet nb total des 2 autres types (actuellement seulement par type source)
  - Changement d'effet J+1 selon historique J-1 (conformité J-1)

### 3. `matrices_voisin.pkl`
- **Usage actuel** : Utilisé dans `matrix_applicator.py` via `apply_voisin()` et dans `VectorGenerator._calculate_neighbor_effect()`
- **Format** : `Dict[microzone_id, {voisins: List[str], poids_influence: float, seuil_activation: int}]`
- **Fonction** : Effet spatial des 8 zones alentours (radius 1)
- **Story 2.2.9** : Correspond à la "matrice voisins" mais manque :
  - Pondération explicite grave×1.0, moyen×0.5, bénin×0.2 (actuellement dans `POIDS_VOISIN` mais pas modulable)
  - Modulation par variabilité locale (actuellement fixe)

### 4. `matrices_saisonnalite.pkl`
- **Usage actuel** : Utilisé dans `matrix_applicator.py` via `apply_saisonnalite()`
- **Format** : `Dict[microzone_id, Dict[type_incident, Dict[saison, float]]]`
- **Fonction** : Facteurs saisonniers (hiver, intersaison, été)
- **Story 2.2.9** : Correspond au "facteur_statique" dans la formule

## Code existant utilisant les matrices

### `src/core/probability/matrix_applicator.py`
- `apply_intra_type()` : Applique matrice intra-type
- `apply_inter_type()` : Applique matrice inter-type
- `apply_voisin()` : Applique matrice voisins (pondération grave×1.0, moyen×0.5, bénin×0.2)
- `apply_saisonnalite()` : Applique matrice saisonnalité

### `src/core/generation/intensity_calculator.py`
- `calculate_intensity()` : Calcule intensité avec effets inter-types et historiques simplifiés
- **Manque** : Intégration complète des matrices dans formule calibrée avec modulations dynamiques

### `src/core/generation/vector_generator.py`
- `_calculate_neighbor_effect()` : Utilise `apply_voisin()` pour calculer effet voisins
- **Manque** : Intégration complète dans formule intensité calibrée

## Ce qui doit être implémenté pour Story 2.2.9

### 1. Matrice gravité microzone (amélioration)
- ✅ Base : `matrices_correlation_intra_type.pkl` existe
- ❌ À ajouter : Historique 7 jours avec décroissance exponentielle
- ❌ À ajouter : Calcul depuis `VectorsState` (historique J-6 à J-1)

### 2. Matrice types croisés (amélioration)
- ✅ Base : `matrices_correlation_inter_type.pkl` existe
- ❌ À ajouter : Effet nb total des 2 autres types (somme des totaux)
- ❌ À ajouter : Changement d'effet J+1 selon historique J-1 (conformité)

### 3. Matrice voisins (amélioration)
- ✅ Base : `matrices_voisin.pkl` existe
- ✅ Pondération : Déjà dans `POIDS_VOISIN = (0.2, 0.5, 1.0)` (bénin, moyen, grave)
- ❌ À ajouter : Modulation par variabilité locale (actuellement fixe)

### 4. Modulations dynamiques (nouveau)
- ❌ Modulations par événements graves/positifs
- ❌ Modulations par incidents (accidents, incendies, agressions)
- ❌ Modulations par régimes (Stable/Détérioration/Crise)
- ❌ Modulations par patterns (4j, 7j, 60j)

### 5. Intégration formule calibrée (nouveau)
- ❌ Formule complète : `λ_calibrated = λ_base × facteur_statique × facteur_gravité × facteur_croisé × facteur_voisins × facteur_long`
- ❌ Normalisation : `Z(t) = Σ_{τ,g} λ_calibrated(τ,g)`
- ❌ Caps : Min ×0.1, Max ×3.0

## Recommandations

1. **Réutiliser les matrices existantes** : Les matrices dans `data/source_data/` sont déjà pré-calculées et peuvent être réutilisées
2. **Améliorer `IntensityCalculator`** : Intégrer les matrices existantes dans la formule calibrée complète
3. **Ajouter historique 7 jours** : Créer une méthode pour calculer l'historique avec décroissance exponentielle
4. **Implémenter modulations dynamiques** : Créer un système de modulation des facteurs selon événements, incidents, régimes, patterns
5. **Intégrer dans `VectorGenerator`** : Utiliser la formule calibrée complète dans la génération des vecteurs
