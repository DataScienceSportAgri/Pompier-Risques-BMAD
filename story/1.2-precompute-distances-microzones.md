# Story 1.2 : Pré-calcul des distances et 100 microzones

**Status:** Draft  
**Epic:** Epic 1 - Pré-calculs  
**Story Number:** 1.2

---

## Story

**As a** système de simulation,  
**I want** trajets caserne → microzone, microzone → hôpital, et découpage 100 microzones, pré-calculés et sauvegardés,  
**so that** Golden Hour (Epic 2) et la carte (100 microzones) s'appuient sur des données fixes.

---

## Acceptance Criteria

1. Sous-partie du script unique : calcul des distances et microzones traversées (caserne → microzone, microzone → hôpital).
2. **100 microzones** : découpage produit et sauvegardé (ex. géométries, centroïdes). Source à définir (IRIS, OSM, etc., cf. recommandations techniques).
3. **Casernes et hôpitaux** : positions à partir d'un **fichier trouvé sur internet** correspondant au mieux à la réalité (casernes pompier Paris, hôpitaux).
4. Sorties dans `data/source_data/` (pickle ; format choisi par l'implémentation). Limites microzone→arrondissement incluses (pour agrégation Epic 2).
5. Vérifications : matrices cohérentes (pas de NaN, dimensions attendues).

---

## Integration Verification

IV1: Fichiers lisibles par un script Python.  
IV2: Coûts mémoire / temps raisonnables sur machine standard.

---

## Tasks / Subtasks

- [ ] Identifier source données casernes/hôpitaux (fichier internet)
- [ ] Identifier source données microzones (IRIS, OSM, ou grille)
- [ ] Implémenter calcul distances caserne → microzone
- [ ] Implémenter calcul distances microzone → hôpital
- [ ] Implémenter découpage 100 microzones
- [ ] Calculer limites microzone → arrondissement
- [ ] Sauvegarder résultats en pickle (format choisi)
- [ ] Tests : vérifier matrices (pas de NaN, dimensions), cohérence géographique

---

## Dev Notes

### Architecture Context

- **100 microzones** : Découpage Paris en 100 microzones avec délimitation visible sur carte (FR27)
- **Sources possibles** (recommandations PRD) :
  - IRIS (Insee) : découpages statistiques Paris → agrégation pour viser ~100 zones
  - OpenStreetMap : découpage par quartiers / polygones ; scripts (ex. `osmnx`, `geopandas`) pour générer GeoJSON
  - Données Ville de Paris : découpages existants (îlots, secteurs) à filtrer/agréger
  - Grille : découpage géométrique des 20 arrondissements (ex. grid par arrondissement, puis fusion pour ~100)
- **Casernes/hôpitaux** : Fichier trouvé sur internet (positions réelles)
- **Format pickle** : Format au choix de l'implémentation

### Source Tree

```
scripts/
├── run_precompute.py
└── precompute_distances.py  # Module pour cette story

data/
└── source_data/
    ├── distances_caserne_microzone.pkl
    ├── distances_microzone_hopital.pkl
    ├── microzones.pkl  # ou .geojson
    └── limites_microzone_arrondissement.pkl
```

### Dependencies

- GeoPandas : Manipulation données géospatiales
- OSMnx (optionnel) : Si utilisation OSM pour microzones
- Pandas : Manipulation données tabulaires

### Testing Standards

- Tests unitaires : Vérifier calcul distances, découpage microzones, limites arrondissements
- Tests de validation : Matrices cohérentes (pas de NaN, dimensions attendues)
- Framework : pytest
- Emplacement : `tests/scripts/test_precompute_distances.py`

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 28 Jan 2026 | 1.0 | Création story | PM |
