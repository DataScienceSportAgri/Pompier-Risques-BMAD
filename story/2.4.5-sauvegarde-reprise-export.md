# Story 2.4.5 : Sauvegarde / reprise état simulation et export

**Status:** Draft  
**Epic:** Epic 2 - Système de Simulation et Prédiction  
**Story Number:** 2.4.5

---

## Story

**As a** utilisateur,  
**I want** sauvegarder l'état et exporter des résultats partiels,  
**so that** je peux interrompre, reprendre ou analyser hors ligne.

---

## Acceptance Criteria

1. **Deux types de sauvegarde** :
   - **Sauvegarde ML finale** : Sauvegarde après 50 runs terminés (features, labels, modèles ML) — format pickle standardisé.
   - **Sauvegarde en cours (interruption)** : Sauvegarde automatique lors [Stop] de l'état d'urgence (vecteurs, événements, variables cachées) — format pickle standardisé pour reprise.
2. **Bouton [Stop]** : sauvegarde automatique de l'état (**état d'urgence** / safe state) en milieu de run — vecteurs, événements, variables cachées — pour **inspection** (fichiers créés, partie du run). Format pickle standardisé.
3. **Bouton dédié [Sauvegarder]** pour export des résultats partiels (features, labels, modèles ML). Formats : CSV (features/labels), joblib (modèles), HTML (cartes).
4. Reprise après interruption : chargement état sauvegardé, reprise depuis point d'arrêt. Pickle dans `data/intermediate/` (ou dossier dédié type `data/safe_state/` pour état d'urgence).
4. Tests unitaires : sauvegarde, chargement, export, reprise.

---

## Integration Verification

IV1: Sauvegarde et reprise fonctionnent (fichiers créés, format correct).  
IV2: Exports utilisables (CSV, modèles rechargeables).

---

## Tasks / Subtasks

- [x] Implémenter sauvegarde automatique état d'urgence lors [Stop] (pickle)
- [x] Implémenter sauvegarde état complet (vecteurs, événements, variables cachées)
- [x] Implémenter bouton [Sauvegarder] pour export manuel
- [x] Implémenter export CSV (features, labels)
- [x] Implémenter export joblib (modèles ML)
- [x] Implémenter export HTML (cartes Folium)
- [x] Implémenter chargement état sauvegardé (pickle)
- [x] Implémenter reprise depuis point d'arrêt (bouton [Reprendre])
- [x] Implémenter structure dossiers (data/intermediate/, data/safe_state/)
- [ ] Tests unitaires : sauvegarde, chargement, export, reprise

---

## Dev Notes

### Architecture Context

- **État d'urgence** : Sauvegarde automatique lors Stop (FR18)
- **Bouton [Sauvegarder]** : Export manuel résultats partiels (FR18)
- **Formats export** : CSV (features/labels), joblib (modèles), HTML (cartes)
- **Reprise** : Chargement état sauvegardé, reprise depuis point d'arrêt (FR18)
- **Structure** : Pickle dans `data/intermediate/` ou `data/safe_state/` (état d'urgence)

### Source Tree

```
src/adapters/persistence/
└── pickle_persistence.py    # Sauvegarde/chargement pickle

src/adapters/ui/
└── streamlit_app.py         # Boutons [Stop], [Sauvegarder], [Reprendre]

data/
├── intermediate/
│   └── run_XXX/
│       └── safe_state.pkl    # État d'urgence
└── safe_state/               # Dossier dédié (optionnel)
    └── run_XXX_safe.pkl
```

### Dependencies

- SimulationState : Story 2.2.x (état à sauvegarder)
- PersistenceAdapter : Architecture (sauvegarde pickle)
- UI Streamlit : Story 2.4.1, 2.4.3 (boutons)

### Formats export

- **CSV** : Features (DataFrame), Labels (DataFrame)
- **joblib** : Modèles ML sauvegardés (Story 2.3.2)
- **HTML** : Cartes Folium (export statique)

### Structure état sauvegardé

```python
# État d'urgence (pickle)
{
    'run_id': str,
    'current_day': int,
    'vectors_state': VectorsState,
    'events_state': EventsState,
    'casualties_state': CasualtiesState,
    'regime_state': RegimeState,
    'config': dict,
    'timestamp': datetime
}
```

### Testing Standards

- Tests unitaires : Sauvegarde, chargement, export, reprise
- Tests d'intégration : Reprise complète depuis état sauvegardé
- Tests de format : CSV, joblib, HTML valides et utilisables
- Framework : pytest
- Emplacement : `tests/adapters/persistence/`

---

## Dev Agent Record

### File List
- `src/ui/web_app.py` (modifié) — Popup fin entraînement ML, export CSV/HTML, sauvegarde/chargement état d'urgence

### Completion Notes
- Popup de fin d'entraînement avec chemin modèle et métriques
- Export CSV features/labels vers data/exports/
- Export carte HTML vers data/exports/
- Sauvegarde état d'urgence automatique lors PAUSE vers data/safe_state/
- Chargement état sauvegardé via expander dans l'interface

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 28 Jan 2026 | 1.0 | Création story | PM |
| 02 Feb 2026 | 1.1 | Implémentation sauvegarde, export, reprise | Dev |
