# Story 2.1.2 : Structure SimulationState avec domaines spécialisés

**Status:** Draft  
**Epic:** Epic 2 - Système de Simulation et Prédiction  
**Story Number:** 2.1.2

---

## Story

**As a** développeur,  
**I want** créer la structure SimulationState avec domaines spécialisés (VectorsState, EventsState, CasualtiesState, RegimeState),  
**so that** l'état global de la simulation est bien organisé et sauvegardable.

---

## Acceptance Criteria

1. Classe `SimulationState` (Aggregate Root) avec structure refactorée v2.
2. **VectorsState** : Gestion vecteurs d'incidents par microzone (données journalières uniquement).
3. **EventsState** : Gestion événements graves et positifs (données journalières uniquement).
4. **CasualtiesState** : Gestion morts et blessés graves (agrégés par semaine, pas journaliers).
5. **RegimeState** : Gestion régimes cachés (Stable/Détérioration/Crise) par microzone.
6. **Séparation claire** : SimulationState contient UNIQUEMENT données journalières. Features (hebdomadaires) et labels (mensuels) sont calculés et stockés séparément.
7. **Sauvegardable** : Structure pickle-compatible pour sauvegarde/chargement état.
8. Tests unitaires : Création, sauvegarde/chargement, structure domaines.

---

## Integration Verification

IV1: SimulationState créable, sauvegardable et rechargeable (pickle).  
IV2: Structure n'interfère pas avec features/labels (séparation claire).

---

## Tasks / Subtasks

- [x] Créer classe `SimulationState` (Aggregate Root)
- [x] Créer classe `VectorsState` (vecteurs journaliers par microzone)
- [x] Créer classe `EventsState` (événements journaliers)
- [x] Créer classe `CasualtiesState` (morts/blessés agrégés par semaine)
- [x] Créer classe `RegimeState` (régimes par microzone)
- [x] Implémenter composition SimulationState (run_id, config, current_day, domaines)
- [x] Implémenter méthodes sauvegarde/chargement (pickle-compatible)
- [x] Tests : création, sauvegarde/chargement, structure domaines

---

## Dev Notes

### Architecture Context

- **SimulationState** : État global de la simulation (Aggregate Root composant des domaines spécialisés)
- **Structure refactorée v2** : Séparation claire entre données journalières (SimulationState) et données agrégées (features/labels)
- **Domaines spécialisés** :
  - VectorsState : Vecteurs journaliers par microzone
  - EventsState : Événements journaliers (graves et positifs)
  - CasualtiesState : Morts et blessés graves (agrégés par semaine)
  - RegimeState : Régimes cachés par microzone (Stable/Détérioration/Crise)
- **Sauvegardable** : Format pickle standardisé pour sauvegarde/chargement

### Source Tree

```
src/core/state/
├── simulation_state.py      # SimulationState (Aggregate Root)
├── vectors_state.py         # VectorsState
├── events_state.py          # EventsState
├── casualties_state.py      # CasualtiesState
└── regime_state.py          # RegimeState
```

### Structure SimulationState

```python
# src/core/state/simulation_state.py
from .vectors_state import VectorsState
from .events_state import EventsState
from .casualties_state import CasualtiesState
from .regime_state import RegimeState

class SimulationState:
    """État global de la simulation (Aggregate Root)."""
    
    def __init__(self, run_id: str, config: dict):
        self.run_id = run_id
        self.config = config
        self.current_day: int = 0
        
        # Domaines spécialisés (composition) - DONNÉES JOURNALIÈRES UNIQUEMENT
        self.vectors_state = VectorsState()          # Vecteurs journaliers
        self.events_state = EventsState()            # Événements journaliers
        self.casualties_state = CasualtiesState()     # Casualties (agrégés par semaine)
        self.regime_state = RegimeState()            # Régimes par microzone
    
    def save(self, path: str) -> None:
        """Sauvegarde état en pickle (format standardisé)."""
        pass
    
    @classmethod
    def load(cls, path: str) -> 'SimulationState':
        """Charge état depuis pickle."""
        pass
```

### Dependencies

- Python 3.12
- pickle : Sauvegarde/chargement (stdlib)

### Testing Standards

- Tests unitaires : Création, sauvegarde/chargement, structure domaines
- Tests de validation : Séparation claire données journalières vs agrégées
- Framework : pytest
- Emplacement : `tests/core/state/`

---

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (via Cursor)

### Completion Notes
- ✅ SimulationState refactoré avec structure v2 (Aggregate Root)
- ✅ VectorsState implémenté : gestion vecteurs journaliers par microzone (Dict[microzone_id, Dict[jour, Dict[type_incident, Vector]]])
- ✅ EventsState implémenté : gestion événements journaliers (graves et positifs) avec méthodes de filtrage
- ✅ CasualtiesState implémenté : gestion morts/blessés agrégés par semaine (pas journaliers, conformément à l'architecture)
- ✅ RegimeState implémenté : gestion régimes cachés (Stable/Détérioration/Crise) par microzone avec validation
- ✅ Composition SimulationState : tous les domaines intégrés (vectors_state, events_state, casualties_state, regime_state)
- ✅ Méthodes save/load implémentées avec pickle (gestion d'erreurs incluse)
- ✅ Séparation claire : SimulationState contient UNIQUEMENT données journalières (vectors, events). Casualties agrégés par semaine.
- ✅ Tests unitaires complets pour tous les domaines (création, sauvegarde/chargement, structure)
- ✅ Validation : sauvegarde/chargement pickle fonctionnel, séparation journalier vs agrégé respectée

### File List
**Nouveaux fichiers créés :**
- `src/core/state/vectors_state.py` - VectorsState (vecteurs journaliers par microzone)
- `src/core/state/events_state.py` - EventsState (événements journaliers)
- `src/core/state/casualties_state.py` - CasualtiesState (morts/blessés agrégés par semaine)
- `src/core/state/regime_state.py` - RegimeState (régimes par microzone)
- `tests/core/state/__init__.py`
- `tests/core/state/test_simulation_state.py` - Tests unitaires complets

**Fichiers modifiés :**
- `src/core/state/simulation_state.py` - Refactoré avec structure v2, ajout domaines spécialisés et méthodes save/load

### Debug Log References
Aucune erreur critique. Imports et sauvegarde/chargement pickle validés avec succès.

### Status
Ready for Review

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 28 Jan 2026 | 1.0 | Création story | PM |
| 29 Jan 2026 | 1.1 | Implémentation complète - Structure SimulationState avec domaines spécialisés | Dev (James) |
