# Story 1.4.4.4 : Intégration Variables d'État dans Calcul Probabilités

**Status:** Done  
**Epic:** Epic 2 - Système de Simulation et Prédiction  
**Story Number:** 1.4.4.4

---

## Story

**As a** système de simulation,  
**I want** intégrer les variables d'état dynamiques évoluées dans le calcul final des probabilités,  
**so that** les probabilités d'incidents reflètent l'état actuel du trafic, des incidents nuit et des incidents alcool.

---

## Contexte et Clarifications

Cette story fait partie du découpage de la story 1.4.4 (matrices de corrélation et patterns dynamiques). Suite aux clarifications de l'orchestrator et de l'architecte :

- **Variables d'état évoluées** : Les variables ont été évoluées J→J+1 dans Story 1.4.4.2.
- **Probabilités de base** : Les probabilités ont été modulées par les matrices fixes dans Story 1.4.4.3.
- **Intégration finale** : Cette story combine matrices fixes + variables d'état pour obtenir les probabilités finales (avant application patterns).

**Cette story complète le calcul des probabilités en intégrant les variables d'état dynamiques.**

---

## Acceptance Criteria

1. **Intégration trafic** : Influence du niveau de trafic sur les probabilités :
   - Condition : Si `trafic > 0.7` (trafic élevé)
   - Effet : +15% probabilités accidents et agressions
   - Application : Multiplication ou addition selon type d'incident

2. **Intégration incidents nuit** : Influence des incidents se produisant la nuit :
   - Condition : Si `incidents_nuit > seuil` (seuil = 2 événements/jour/microzone)
   - Effet : +10% probabilités incidents nuit
   - Application : Augmentation probabilités pour incidents de type nuit

3. **Intégration incidents alcool** : Influence des incidents causés par l'alcool :
   - Condition : Si `incidents_alcool > seuil` (seuil = 2 événements/jour/microzone)
   - Effet : +8% probabilités incidents alcool
   - Application : Augmentation probabilités pour incidents de type alcool

4. **Mise à jour `calculer_probabilite_incidents_J1()`** : Fonction complète avec variables d'état :
   - Entrée : Probabilités modulées (Story 1.4.4.3) + variables d'état évoluées (Story 1.4.4.2)
   - Sortie : Probabilités finales (avant application patterns)
   - Ordre : Matrices fixes → Variables d'état

5. **Tests** : Validation intégration trafic, incidents nuit, incidents alcool, combinaison complète.

---

## Integration Verification

IV1: Variables d'état évoluées disponibles depuis Story 1.4.4.2.  
IV2: Probabilités modulées disponibles depuis Story 1.4.4.3.  
IV3: Probabilités finales cohérentes (valeurs [0, 1], effets appliqués correctement).

---

## Tasks / Subtasks

- [x] Implémenter intégration trafic (+15% si trafic > 0.7)
- [x] Implémenter intégration incidents nuit (+10% si seuil dépassé)
- [x] Implémenter intégration incidents alcool (+8% si seuil dépassé)
- [x] Mettre à jour `calculer_probabilite_incidents_J1()` avec variables d'état
- [x] Définir seuils pour incidents nuit et alcool (2 événements/jour/microzone)
- [x] Tests : trafic élevé (augmentation probabilités accidents/agressions)
- [x] Tests : incidents nuit (augmentation si seuil dépassé)
- [x] Tests : incidents alcool (augmentation si seuil dépassé)
- [x] Tests : combinaison (toutes variables ensemble)
- [x] Tests : probabilités finales (cohérence, valeurs [0, 1])

---

## Dev Notes

### Architecture Context

- **Variables d'état évoluées** : Disponibles depuis `SimulationState.dynamic_state` (Story 1.4.4.2)
- **Probabilités modulées** : Résultat de Story 1.4.4.3 (application matrices fixes)
- **Intégration** : Combinaison des deux pour obtenir probabilités finales
- **Avant patterns** : Les patterns seront appliqués dans Story 1.4.4.6

### Source Tree

```
src/core/probability/
├── variables_etat_applicator.py  # apply_variables_etat, seuils (trafic, nuit, alcool)
├── probability_calculator.py     # calculer_probabilite_incidents_J1() + dynamic_state
└── ...

tests/core/probability/
└── test_integration_variables.py  # trafic, nuit, alcool, combinaison, IV3
```

### Flux de Calcul Complet

```
Probabilités modulées (Story 1.4.4.3)
    │
    ├─ Intégration trafic
    │  └─ Si trafic > 0.7 → +15% accidents/agressions
    │
    ├─ Intégration incidents nuit
    │  └─ Si incidents_nuit > 2 (total mz) → +10%
    │
    └─ Intégration incidents alcool
       └─ Si incidents_alcool > 2 (total mz) → +8%
           │
           ▼
Probabilités finales (avant patterns)
```

### Dependencies

- Story 1.4.4.2 (évolution variables d'état) : Variables évoluées disponibles
- Story 1.4.4.3 (application matrices) : Probabilités modulées disponibles
- Story 1.4.4.6 (application patterns) : Utilisera ces probabilités finales

### Testing Standards

- Tests unitaires : Vérifier intégration de chaque variable d'état
- Tests de validation : Seuils d'activation, effets appliqués, probabilités [0, 1]
- Tests d'intégration : Combinaison complète (matrices + variables)
- Framework : pytest
- Emplacement : `tests/core/probability/test_integration_variables.py`

---

## Dev Agent Record

### Agent Model Used
_Implémentation via variables_etat_applicator + probability_calculator_

### Debug Log References
_Aucun._

### Completion Notes List

- **Seuils** : 2 événements/jour/microzone pour nuit et alcool (total sur tous types). Trafic > 0.7.
- **variables_etat_applicator** : `apply_variables_etat(prob, mz, type, trafic, incidents_nuit, incidents_alcool)`. Trafic > 0.7 → ×1.15 pour agressions/accidents. Nuit > 2 → ×1.10. Alcool > 2 → ×1.08. Clamp [0,1].
- **calculer_probabilite_incidents_J1** : paramètre optionnel `dynamic_state` (keyword-only). Si fourni, applique variables d'état après matrices fixes. Compatible Story 2.1.2 / 1.4.4.2.
- **Tests** : `test_integration_variables.py` (trafic, nuit, alcool, combinaison, bornes, seuils = 2).

### File List

| Fichier | Modifié / Créé |
|---------|----------------|
| `src/core/probability/variables_etat_applicator.py` | Créé |
| `src/core/probability/probability_calculator.py` | Modifié (dynamic_state) |
| `src/core/probability/__init__.py` | Modifié (exports variables état) |
| `tests/core/probability/test_integration_variables.py` | Créé |

### Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 29 Jan 2026 | 1.0 | Création story suite au découpage 1.4.4 | PM |
| 29 Jan 2026 | 1.1 | Implémentation ; seuils nuit/alcool = 2 événements/jour/microzone | Dev |

---

## Références

- **Documentation découpage** : `story/1.4.4-DECOUPAGE-STORIES.md`
- **Diagramme découpage** : `story/1.4.4-DIAGRAMME-DECOUPAGE.md`
- **Documentation architecture** : `docs/architecture/impact-decoupage-1.4.4.md`
- **Story évolution variables** : `story/1.4.4.2-evolution-variables-etat.md`
- **Story application matrices** : `story/1.4.4.3-application-matrices-fixes.md`
