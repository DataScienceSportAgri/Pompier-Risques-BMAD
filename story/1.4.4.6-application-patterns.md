# Story 1.4.4.6 : Application Patterns dans Calcul Probabilités

**Status:** Done  
**Epic:** Epic 2 - Système de Simulation et Prédiction  
**Story Number:** 1.4.4.6

---

## Story

**As a** système de simulation,  
**I want** appliquer les patterns dynamiques détectés dans le calcul final des probabilités,  
**so that** les probabilités d'incidents reflètent les patterns temporels détectés dans l'historique.

---

## Contexte et Clarifications

Cette story fait partie du découpage de la story 1.4.4 (matrices de corrélation et patterns dynamiques). Suite aux clarifications de l'orchestrator et de l'architecte :

- **Patterns détectés** : Patterns actifs disponibles depuis Story 1.4.4.5.
- **Probabilités de base** : Probabilités modulées par matrices fixes et variables d'état (Stories 1.4.4.3 et 1.4.4.4).
- **Application finale** : Cette story applique les patterns pour obtenir les probabilités finales utilisées dans la génération.

**Cette story complète le calcul des probabilités en appliquant les patterns dynamiques.**

---

## Acceptance Criteria

1. **Application pattern 7j** : Modulation des probabilités selon le cycle de vie :
   - Amplitude base : +0.1 aux probabilités (jours 1-2, 4-7)
   - Amplitude pic : +0.15 aux probabilités (jour 3, pic du pattern)
   - Application : Multiplication ou addition selon jour actuel du pattern

2. **Application pattern 60j** : Modulation des probabilités selon les 3 phases :
   - Phase 1 (jours 1-20) : +0.05 aux probabilités
   - Phase 2 (jours 21-40) : -0.05 aux probabilités (diminution)
   - Phase 3 (jours 41-60) : +0.1 aux probabilités (augmentation)
   - Application : Selon jour actuel du pattern (1-60)

3. **Intégration dans `calculer_probabilite_incidents_J1()`** : Fonction complète avec patterns :
   - Entrée : Probabilités modulées (Stories 1.4.4.3 + 1.4.4.4) + patterns actifs (Story 1.4.4.5)
   - Sortie : Probabilités finales (utilisées dans génération Story 2.2.1)
   - Ordre : Matrices fixes → Variables d'état → Patterns

4. **Gestion plusieurs patterns** : Combinaison de plusieurs patterns actifs :
   - Si plusieurs patterns actifs : Combinaison des amplitudes (addition ou moyenne)
   - Limitation : Maximum 3 patterns (géré dans Story 1.4.4.5)

5. **Tests** : Validation application pattern 7j, pattern 60j, combinaison patterns, probabilités finales.

---

## Integration Verification

IV1: Patterns actifs disponibles depuis Story 1.4.4.5.  
IV2: Probabilités modulées disponibles depuis Stories 1.4.4.3 et 1.4.4.4.  
IV3: Probabilités finales cohérentes (valeurs [0, 1], effets patterns appliqués).

---

## Tasks / Subtasks

- [x] Implémenter application pattern 7j (amplitude base +0.1, pic +0.15 jour 3)
- [x] Implémenter application pattern 60j (3 phases : +0.05, -0.05, +0.1)
- [x] Implémenter gestion plusieurs patterns (combinaison amplitudes)
- [x] Mettre à jour `calculer_probabilite_incidents_J1()` avec application patterns
- [x] Tests : pattern 7j (amplitude base et pic appliqués)
- [x] Tests : pattern 60j (3 phases appliquées selon jour)
- [x] Tests : combinaison (patterns + matrices + variables d'état)
- [x] Tests : plusieurs patterns (combinaison correcte)
- [x] Tests : probabilités finales (cohérence, valeurs [0, 1])

---

## Dev Notes

### Architecture Context

- **Patterns actifs** : Disponibles depuis `SimulationState` (Story 1.4.4.5)
- **Probabilités modulées** : Résultat de Stories 1.4.4.3 et 1.4.4.4
- **Application** : Dernière étape avant génération (Story 2.2.1)
- **Amplitudes** : Facteurs d'augmentation/diminution selon type et phase du pattern

### Source Tree

```
src/core/probability/
├── pattern_applicator.py       # apply_patterns (7j, 60j, combinaison, agressions uniquement)
└── probability_calculator.py   # calculer_probabilite_incidents_J1 (matrices → variables → patterns)

tests/core/probability/
└── test_application_patterns.py
```

### Flux de Calcul Final

```
Probabilités modulées (Stories 1.4.4.3 + 1.4.4.4)
    │
    ├─ Patterns actifs disponibles (Story 1.4.4.5)
    │
    ├─ Application pattern 7j
    │  └─ Jour 1-2, 4-7 : +0.1
    │  └─ Jour 3 (pic) : +0.15
    │
    ├─ Application pattern 60j
    │  └─ Phase 1 (1-20) : +0.05
    │  └─ Phase 2 (21-40) : -0.05
    │  └─ Phase 3 (41-60) : +0.1
    │
    └─ Combinaison plusieurs patterns
       └─ Addition ou moyenne des amplitudes
           │
           ▼
Probabilités finales (utilisées dans génération)
```

### Dependencies

- Story 1.4.4.5 (détection patterns) : Patterns actifs disponibles
- Story 1.4.4.4 (intégration variables) : Probabilités modulées disponibles
- Story 2.2.1 (génération vecteurs) : Utilisera ces probabilités finales

### Testing Standards

- Tests unitaires : Vérifier application de chaque type de pattern
- Tests de validation : Amplitudes correctes, phases appliquées, probabilités [0, 1]
- Tests d'intégration : Combinaison complète (matrices + variables + patterns)
- Framework : pytest
- Emplacement : `tests/core/probability/test_application_patterns.py`

---

## Dev Agent Record

### Agent Model Used
_Implémentation via pattern_applicator + calculer_probabilite_incidents_J1(patterns_actifs)_

### Debug Log References
_Aucun._

### Completion Notes List

- **7j** : amplitude base +0.1 (jours 1–2, 4–7), pic +0.15 (jour 3, `jour_actuel` 0-based = 2).
- **60j** : phase 1 +0.05, phase 2 -0.05, phase 3 +0.1 ; `phase` dérivée de `jour_actuel`.
- **Combinaison** : addition des amplitudes de tous les patterns actifs pour la microzone, puis ajout au vecteur (p_b, p_m, p_g), clamp [0, 1].
- **Type** : application uniquement pour « agressions » ; incendies/accidents inchangés.
- **Ordre** : matrices fixes → variables d'état → patterns. Paramètre optionnel `patterns_actifs: Dict[mz, List[Pattern]]`.

### File List

| Fichier | Modifié / Créé |
|---------|----------------|
| `src/core/probability/pattern_applicator.py` | Créé |
| `src/core/probability/probability_calculator.py` | Modifié (patterns_actifs, apply_patterns) |
| `src/core/probability/__init__.py` | Modifié (export apply_patterns) |
| `tests/core/probability/test_application_patterns.py` | Créé |

### Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 29 Jan 2026 | 1.0 | Création story suite au découpage 1.4.4 | PM |
| 29 Jan 2026 | 1.1 | Implémentation ; pattern_applicator, intégration calculer_probabilite_incidents_J1 | Dev |

---

## Références

- **Documentation découpage** : `story/1.4.4-DECOUPAGE-STORIES.md`
- **Diagramme découpage** : `story/1.4.4-DIAGRAMME-DECOUPAGE.md`
- **Documentation architecture** : `docs/architecture/impact-decoupage-1.4.4.md`
- **Story détection patterns** : `story/1.4.4.5-detection-patterns-dynamiques.md`
- **Story génération vecteurs** : `story/2.2.1-generation-vecteurs-journaliers.md`
