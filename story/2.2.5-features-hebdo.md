# Story 2.2.5 : Features hebdomadaires — StateCalculator (Étape 5)

**Status:** Draft  
**Epic:** Epic 2 - Système de Simulation et Prédiction  
**Story Number:** 2.2.5

---

## Story

**As a** système de simulation,  
**I want** calculer 18 features hebdomadaires par arrondissement via StateCalculator,  
**so that** les modèles ML peuvent être entraînés sur ces features.

---

## Acceptance Criteria

1. Classe `StateCalculator` ; agrégation microzones → arrondissements avec **limites issues des pré-calculs** (Epic 1).
2. Calcul 6 features sommes incidents: (moyen + grave) et bénin par type (3 types × 2 = 6)
3. Calcul 6 features proportions: alcool et nuit par type (3 types × 2 = 6) — utilise agrégation hebdomadaire Story 2.2.2.
4. Calcul 3 features morts hebdomadaires par type (accident, incendie, agression) — utilise Story 2.2.4.
5. Calcul 3 features blessés graves hebdomadaires par type — utilise Story 2.2.4.
6. Total: 18 features par arrondissement par semaine
7. Sauvegarde features en DataFrame avec colonnes claires (arrondissement, semaine, feature_1, ..., feature_18)
8. Tests unitaires validant calculs, agrégation, format DataFrame

---

## Integration Verification

IV1: Vérifier que toutes dépendances sont disponibles (vecteurs, proportions, morts/blessés)  
IV2: Vérifier que les features sont dans format utilisable pour ML (pas de NaN, types numériques)  
IV3: Vérifier que l'agrégation hebdomadaire est cohérente (somme pour sommes, moyenne pour proportions?)

---

## Tasks / Subtasks

- [ ] Créer classe `StateCalculator`
- [ ] Implémenter agrégation microzones → arrondissements (limites pré-calculs Epic 1)
- [ ] Implémenter calcul 6 features sommes incidents (moyen+grave et bénin par type)
- [ ] Implémenter calcul 6 features proportions (alcool et nuit par type) - utilise Story 2.2.2
- [ ] Implémenter calcul 3 features morts hebdomadaires par type - utilise Story 2.2.4
- [ ] Implémenter calcul 3 features blessés graves hebdomadaires par type - utilise Story 2.2.4
- [ ] Implémenter agrégation hebdomadaire (somme pour sommes, moyenne pour proportions)
- [ ] Implémenter sauvegarde features en DataFrame (arrondissement, semaine, feature_1, ..., feature_18)
- [ ] Tests : calculs, agrégation, format DataFrame

---

## Dev Notes

### Architecture Context

- **18 features hebdomadaires** : Par arrondissement par semaine (FR5)
- **6 features sommes** : (moyen + grave) et bénin par type (agressions, incendies, accidents)
- **6 features proportions** : Alcool et nuit par type (agrégation hebdomadaire Story 2.2.2)
- **3 features morts** : Par type (accident, incendie, agression) - Story 2.2.4
- **3 features blessés graves** : Par type - Story 2.2.4
- **Agrégation** : Microzones → arrondissements (limites pré-calculs Epic 1)
- **Format** : DataFrame avec colonnes claires pour ML (Story 2.3.1)

### Source Tree

```
src/services/
└── feature_calculator.py   # StateCalculator - calcul 18 features

data/source_data/
└── limites_microzone_arrondissement.pkl  # Limites agrégation (Epic 1)

data/intermediate/
└── run_XXX/
    └── ml/
        └── features.pkl    # Features sauvegardées
```

### Dependencies

- Vecteurs : Story 2.2.1 (sommes incidents)
- Proportions : Story 2.2.2 (alcool/nuit)
- Morts/Blessés : Story 2.2.4 (casualties)
- Limites microzones : Epic 1, Story 1.2 (agrégation)

### Structure 18 features

1. **Sommes incidents (6)** :
   - Agressions (moyen+grave), Agressions bénin
   - Incendies (moyen+grave), Incendies bénin
   - Accidents (moyen+grave), Accidents bénin

2. **Proportions (6)** :
   - Agressions alcool, Agressions nuit
   - Incendies alcool, Incendies nuit
   - Accidents alcool, Accidents nuit

3. **Morts (3)** :
   - Morts accidents, Morts incendies, Morts agressions

4. **Blessés graves (3)** :
   - Blessés accidents, Blessés incendies, Blessés agressions

### Testing Standards

- Tests unitaires : Calculs, agrégation, format DataFrame
- Tests de validation : Format utilisable pour ML (pas de NaN, types numériques)
- Framework : pytest
- Emplacement : `tests/services/test_feature_calculator.py`

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 28 Jan 2026 | 1.0 | Création story | PM |
