# Story 2.2.5 : Features hebdomadaires — StateCalculator (Étape 5)

**Status:** Draft  
**Epic:** Epic 2 - Système de Simulation et Prédiction  
**Story Number:** 2.2.5

---

## Story

**As a** système de simulation,  
**I want** calculer 18 features hebdomadaires par arrondissement via StateCalculator,  
**so that** les modèles ML peuvent être entraînés sur ces features (144 features totales avec 4 semaines × 4 voisins).

---

## Acceptance Criteria

1. Classe `StateCalculator` ; agrégation microzones → arrondissements avec **limites issues des pré-calculs** (Epic 1).
2. Calcul 6 features sommes incidents: (moyen + grave) et bénin par type (3 types × 2 = 6)
3. Calcul 6 features proportions: alcool et nuit par type (3 types × 2 = 6) — utilise agrégation hebdomadaire Story 2.2.2.
4. Calcul 3 features morts hebdomadaires par type (accident, incendie, agression) — utilise Story 2.2.4.
5. Calcul 3 features blessés graves hebdomadaires par type — utilise Story 2.2.4.
6. Total: **18 features par arrondissement par semaine**
7. **Pour ML (Story 2.3.1)** : **144 features** = 1 central dernière semaine (18) + 1 central 3 semaines précédentes (3 × 18 = 54) + 4 voisins dernière semaine (4 × 18 = 72) = 18 + 54 + 72 = **144 features**. **Structure** : Central dernière semaine + Central 3 semaines précédentes + 4 voisins dernière semaine.
8. Sauvegarde features en DataFrame avec colonnes claires (arrondissement, semaine, feature_1, ..., feature_18)
9. Tests unitaires validant calculs, agrégation, format DataFrame

---

## Integration Verification

IV1: Vérifier que toutes dépendances sont disponibles (vecteurs, proportions, morts/blessés)  
IV2: Vérifier que les features sont dans format utilisable pour ML (pas de NaN, types numériques)  
IV3: Vérifier que l'agrégation hebdomadaire est cohérente (somme pour sommes, moyenne pour proportions?)

---

## Tasks / Subtasks

- [x] Créer classe `StateCalculator`
- [x] Implémenter agrégation microzones → arrondissements (limites pré-calculs Epic 1)
- [x] Implémenter calcul 6 features sommes incidents (moyen+grave et bénin par type)
- [x] Implémenter calcul 6 features proportions (alcool et nuit par type) - utilise Story 2.2.2
- [x] Implémenter calcul 3 features morts hebdomadaires par type - utilise Story 2.2.4
- [x] Implémenter calcul 3 features blessés graves hebdomadaires par type - utilise Story 2.2.4
- [x] Implémenter agrégation hebdomadaire (somme pour sommes, moyenne pour proportions)
- [x] Implémenter sauvegarde features en DataFrame (arrondissement, semaine, feature_1, ..., feature_18)
- [x] Tests : calculs, agrégation, format DataFrame

---

## Dev Notes

### Architecture Context

- **18 features hebdomadaires** : Par arrondissement par semaine (FR5)
- **6 features sommes** : (moyen + grave) et bénin par type (agressions, incendies, accidents)
- **6 features proportions** : Alcool et nuit par type (agrégation hebdomadaire Story 2.2.2)
- **3 features morts** : Par type (accident, incendie, agression) - Story 2.2.4
- **3 features blessés graves** : Par type - Story 2.2.4
- **Agrégation** : Microzones → arrondissements (limites pré-calculs Epic 1)
- **Format** : DataFrame avec colonnes claires pour ML (Story 2.3.1)
- **144 features pour ML** : 1 central (18, dernière semaine) + 4 voisins (18 × 4 semaines chacun = 72) + 1 central (18 × 3 semaines précédentes = 54) = 144. Les 4 semaines des voisins sont prises **avant** la dernière semaine.

### Source Tree

```
src/services/
└── feature_calculator.py   # StateCalculator - calcul 18 features

data/source_data/
└── limites_microzone_arrondissement.pkl  # Limites agrégation (Epic 1)

data/intermediate/
└── run_XXX/
    └── ml/
        └── features.pkl    # Features sauvegardées
```

### Dependencies

- Vecteurs : Story 2.2.1 (sommes incidents)
- Proportions : Story 2.2.2 (alcool/nuit)
- Morts/Blessés : Story 2.2.4 (casualties)
- Limites microzones : Epic 1, Story 1.2 (agrégation)

### Structure 18 features

1. **Sommes incidents (6)** :
   - Agressions (moyen+grave), Agressions bénin
   - Incendies (moyen+grave), Incendies bénin
   - Accidents (moyen+grave), Accidents bénin

2. **Proportions (6)** :
   - Agressions alcool, Agressions nuit
   - Incendies alcool, Incendies nuit
   - Accidents alcool, Accidents nuit

3. **Morts (3)** :
   - Morts accidents, Morts incendies, Morts agressions

4. **Blessés graves (3)** :
   - Blessés accidents, Blessés incendies, Blessés agressions

### Testing Standards

- Tests unitaires : Calculs, agrégation, format DataFrame
- Tests de validation : Format utilisable pour ML (pas de NaN, types numériques)
- Framework : pytest
- Emplacement : `tests/services/test_feature_calculator.py`

---

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (via Cursor)

### Completion Notes
- ✅ Classe StateCalculator : `StateCalculator` avec agrégation microzones → arrondissements
- ✅ Agrégation microzones → arrondissements : `_agreger_microzones_arrondissements()` utilise limites pré-calculées
- ✅ Calcul 6 features sommes incidents : `_calculer_sommes_incidents_semaine()` calcule (moyen+grave) et bénin par type
- ✅ Calcul 6 features proportions : `_calculer_proportions_alcool_nuit_semaine()` calcule alcool et nuit par type avec moyenne pondérée
- ✅ Calcul 3 features morts : Utilise `casualty_calculator.calculer_casualties_semaine()` (Story 2.2.4)
- ✅ Calcul 3 features blessés graves : Utilise `casualty_calculator.calculer_casualties_semaine()` (Story 2.2.4)
- ✅ Agrégation hebdomadaire : Somme pour sommes incidents, moyenne pondérée pour proportions
- ✅ Sauvegarde features : `save_features()` sauvegarde DataFrame en pickle standardisé dans `data/intermediate/run_XXX/ml/features.pkl`
- ✅ Format DataFrame : Colonnes claires (arrondissement, semaine, 18 features nommées)
- ✅ Tests unitaires complets : Calculs, agrégation, format DataFrame, validation format ML (pas de NaN, types numériques)

### File List
**Nouveaux fichiers créés :**
- `src/services/feature_calculator.py` - StateCalculator pour calcul 18 features hebdomadaires
- `tests/services/test_feature_calculator.py` - Tests StateCalculator

**Fichiers modifiés :**
- `src/services/__init__.py` - Ajout export StateCalculator

### Debug Log References
- Agrégation : Somme pour sommes incidents, moyenne pondérée pour proportions alcool/nuit
- Format ML : Vérification pas de NaN, types numériques, pas de valeurs infinies

### Status
Ready for Review

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 28 Jan 2026 | 1.0 | Création story | PM |
| 28 Jan 2026 | 1.1 | Clarification 144 features pour ML (4 semaines × 4 voisins + 1 central) | PM |
| 29 Jan 2026 | 1.2 | Implémentation complète - Calcul 18 features hebdomadaires par arrondissement | Dev (James) |
