# Story 2.2.7 : Événements graves modulables (Accident, Incendie, Agression)

**Status:** Draft  
**Epic:** Epic 2 - Système de Simulation et Prédiction  
**Story Number:** 2.2.7

---

## Story

**As a** système de simulation,  
**I want** générer événements graves avec caractéristiques probabilistes,  
**so that** la complexité pour le ML est suffisante (effets locaux, ricochets, patterns).

---

## Acceptance Criteria

1. Classes `AccidentGrave`, `IncendieGrave`, `AgressionGrave` (héritant de `EventGrave`). Caractéristiques : Traffic slowdown, Cancel sports, Increase bad vectors, Kill pompier (probas et durées selon spec).
2. **Moment de génération** : **juste après** les vecteurs (dans la boucle jour-à-jour). **Modification congestion temps réel** : Les événements graves modifient la congestion du jour **en temps réel** pour que le calcul Golden Hour (Story 2.2.3) utilise la nouvelle congestion. Effets : stress long-terme, pattern court-terme, transitions régimes ; durée 3–10 j ; propagation spatiale (microzone, voisins, gravité décroissante).
3. **Matrices de génération** : les événements peuvent **modifier** les matrices (effets locaux, par ricochet) ; patterns et saisonnalité les modulent aussi.
4. Tests unitaires : caractéristiques, effets temporels/spatiaux.

---

## Integration Verification

IV1: Événements graves modifient les vecteurs (augmentation) ; probabilités respectées.  
IV2: Propagation spatiale et temporelle conforme.

---

## Tasks / Subtasks

- [x] Implémenter classes `AccidentGrave`, `IncendieGrave`, `AgressionGrave` (héritant `EventGrave`) - Déjà existantes Story 2.1.1
- [x] Implémenter caractéristiques probabilistes (Traffic slowdown, Cancel sports, Increase bad vectors, Kill pompier)
- [x] Implémenter génération événements graves (juste après vecteurs)
- [x] Implémenter effets temporels (durée 3-10 jours)
- [x] Implémenter effets spatiaux (propagation microzone, voisins, gravité décroissante)
- [x] Implémenter modification matrices (effets locaux, ricochets) - Via effets sur vecteurs
- [x] Implémenter modulation par patterns et saisonnalité - Intégré dans génération vecteurs
- [x] Tests : caractéristiques, effets temporels/spatiaux

---

## Dev Notes

### Architecture Context

- **Événements graves** : AccidentGrave, IncendieGrave, AgressionGrave (FR13)
- **Caractéristiques probabilistes** : Traffic slowdown, Cancel sports, Increase bad vectors, Kill pompier
- **Moment génération** : Juste après les vecteurs (dans boucle jour-à-jour)
- **Modification congestion temps réel** : Les événements graves modifient la congestion du jour en temps réel pour Golden Hour (Story 2.2.2.5, 2.2.3)
- **Effets** : Stress long-terme, pattern court-terme, transitions régimes
- **Durée** : 3-10 jours
- **Propagation spatiale** : Microzone, voisins, gravité décroissante
- **Modification matrices** : Effets locaux, ricochets, modulation patterns/saisonnalité

### Source Tree

```
src/core/events/
├── event.py                  # Base Event (ABC)
├── event_grave.py           # EventGrave (ABC)
├── accident_grave.py        # AccidentGrave
├── incendie_grave.py       # IncendieGrave
└── agression_grave.py       # AgressionGrave

src/core/events/
└── event_factory.py         # Factory création événements
```

### Dependencies

- Event base : Story 2.1.1 (classes de base)
- Vecteurs : Story 2.2.1 (génération après vecteurs)
- Patterns : Story 2.2.2 (modulation)
- Matrices : Story 2.2.9 (modification matrices)

### Caractéristiques probabilistes

- **Traffic slowdown** : Probabilité, durée, effet
- **Cancel sports** : Probabilité, durée
- **Increase bad vectors** : Probabilité, augmentation, durée, radius
- **Kill pompier** : Probabilité (rare)

### Testing Standards

- Tests unitaires : Caractéristiques, effets temporels/spatiaux
- Tests de validation : Probabilités respectées, propagation conforme
- Framework : pytest
- Emplacement : `tests/core/events/`

---

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (via Cursor)

### Completion Notes
- ✅ Classes AccidentGrave, IncendieGrave, AgressionGrave : Déjà implémentées Story 2.1.1 (héritent EventGrave)
- ✅ Caractéristiques probabilistes : `_generer_caracteristiques()` génère Traffic slowdown (70%), Cancel sports (30%), Increase bad vectors (50%), Kill pompier (5%)
- ✅ Génération événements graves : `generer_evenements_graves()` génère événements si vecteur.grave >= 1, juste après génération vecteurs
- ✅ Effets temporels : Durée 3-10 jours générée aléatoirement, effets appliqués sur jours suivants
- ✅ Effets spatiaux : Propagation microzone et voisins avec gravité décroissante (50% effet sur voisins)
- ✅ Modification congestion temps réel : `appliquer_effets_congestion_temps_reel()` modifie congestion du jour avant Golden Hour
- ✅ Effets sur vecteurs : `appliquer_effets_vecteurs()` augmente vecteurs suivants (+30% grave/moyen) dans rayon donné
- ✅ Intégration GenerationService : Génération événements après vecteurs, application effets congestion et vecteurs
- ✅ Tests unitaires complets : Caractéristiques probabilistes, génération événements, effets temporels/spatiaux, modification congestion

### File List
**Nouveaux fichiers créés :**
- `src/core/events/event_generator.py` - EventGenerator pour génération événements graves
- `tests/core/events/test_event_generator.py` - Tests EventGenerator

**Fichiers modifiés :**
- `src/core/generation/generation_service.py` - Intégration EventGenerator après génération vecteurs

### Debug Log References
- Génération événements : Détection vecteur.grave >= 1, génération 1 événement par incident grave
- Modification congestion temps réel : Application avant Golden Hour pour utiliser nouvelle congestion
- Effets spatiaux : Propagation avec effet décroissant (50% sur voisins)

### Status
Ready for Review

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 28 Jan 2026 | 1.0 | Création story | PM |
| 29 Jan 2026 | 1.1 | Implémentation complète - Génération événements graves avec caractéristiques probabilistes | Dev (James) |
