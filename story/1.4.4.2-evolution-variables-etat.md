# Story 1.4.4.2 : Évolution Variables d'État Dynamiques

**Status:** Done  
**Epic:** Epic 2 - Système de Simulation et Prédiction  
**Story Number:** 1.4.4.2

---

## Story

**As a** système de simulation,  
**I want** faire évoluer les variables d'état dynamiques (trafic, incidents nuit, incidents alcool) de J vers J+1,  
**so that** ces variables peuvent influencer le calcul des probabilités d'incidents pour le jour suivant.

---

## Contexte et Clarifications

Cette story fait partie du découpage de la story 1.4.4 (matrices de corrélation et patterns dynamiques). Suite aux clarifications de l'orchestrator et de l'architecte :

- **Variables d'état dynamiques** : Ces variables évoluent J→J+1 pendant la simulation (runtime).
- **Matrices fixes** : Les matrices de transition pour le trafic sont pré-calculées (Story 1.4.4.1).
- **Intégration** : Les variables évoluées seront intégrées dans le calcul des probabilités (Story 1.4.4.4).

**Cette story se concentre uniquement sur l'évolution J→J+1 des variables d'état.**

---

## Acceptance Criteria

1. **Fonction `evoluer_trafic_J1()`** : Évolution du niveau de trafic (congestion) par microzone :
   - Mémoire : 60-70% de la valeur précédente (persistance)
   - Influence incidents : Accidents augmentent le trafic, incendies moyen/grave le diminuent
   - Aléatoire : 30-40% de variation aléatoire
   - Clamp : Valeur entre [0, 1]

2. **Fonction `evoluer_incidents_nuit_J1()`** : Évolution du nombre d'incidents se produisant la nuit par type et par microzone :
   - Mémoire : 60-70% de la valeur précédente
   - Corrélations inter-type : Influence des autres types d'incidents
   - Saisonnalité : +20% en été (plus d'incidents la nuit en été)

3. **Fonction `evoluer_incidents_alcool_J1()`** : Évolution du nombre d'incidents causés par l'alcool par type et par microzone :
   - Mémoire : 60-70% de la valeur précédente
   - Corrélations inter-type : Influence des autres types d'incidents
   - Saisonnalité : +50% pour accidents en été (plus d'accidents liés à l'alcool en été)

4. **Structure de données** : Variables d'état stockées dans `SimulationState.dynamic_state` (Story 2.1.2) :
   - `trafic: Dict[microzone_id, float]` (niveau congestion 0-1)
   - `incidents_nuit: Dict[microzone_id, Dict[type_incident, int]]`
   - `incidents_alcool: Dict[microzone_id, Dict[type_incident, int]]`

5. **Utilisation matrices fixes** : Utilise les matrices trafic et alcool/nuit pré-calculées (Story 1.4.4.1) pour les règles de transition.

6. **Tests** : Validation évolution, mémoire, corrélations, saisonnalité, bornes.

---

## Integration Verification

IV1: Variables d'état évoluent correctement J→J+1 sans erreur.  
IV2: Variables restent dans les bornes attendues (trafic [0,1], incidents ≥ 0).  
IV3: Intégration avec `SimulationState.dynamic_state` fonctionne.

---

## Tasks / Subtasks

- [x] Implémenter fonction `evoluer_trafic_J1()` (mémoire, influence incidents, aléatoire)
- [x] Implémenter fonction `evoluer_incidents_nuit_J1()` (mémoire, corrélations, saisonnalité)
- [x] Implémenter fonction `evoluer_incidents_alcool_J1()` (mémoire, corrélations, saisonnalité)
- [x] Intégrer dans `SimulationState.dynamic_state` (Story 2.1.2)
- [x] Charger matrices trafic et alcool/nuit depuis pré-calculs (Story 1.4.4.1)
- [x] Tests : évolution trafic (mémoire, influence accidents, clamp [0,1])
- [x] Tests : évolution incidents nuit (mémoire, corrélations, saisonnalité été)
- [x] Tests : évolution incidents alcool (mémoire, corrélations, saisonnalité été)
- [x] Tests : cohérence (variables restent dans bornes)
- [x] Tests : reproductibilité (seed fixe → résultats identiques)

---

## Dev Notes

### Architecture Context

- **Variables d'état dynamiques** : Évoluent J→J+1 pendant la simulation (runtime)
- **Mémoire** : 60-70% de persistance (les variables gardent une partie de leur valeur précédente)
- **Influence incidents** : Les incidents du jour J influencent les variables pour J+1
- **Saisonnalité** : Facteurs saisonniers appliqués (été = +20% nuit, +50% alcool accidents)
- **Matrices fixes** : Utilise matrices trafic et alcool/nuit pré-calculées (Story 1.4.4.1)

### Source Tree

```
src/core/evolution/
├── __init__.py              # evoluer_dynamic_state, exports
├── _loader.py               # load_matrices_for_evolution (trafic, alcool/nuit, inter-type)
├── trafic_evolution.py      # evoluer_trafic_J1()
├── nuit_evolution.py        # evoluer_incidents_nuit_J1()
└── alcool_evolution.py      # evoluer_incidents_alcool_J1()

src/core/state/
├── dynamic_state.py         # DynamicState (trafic, incidents_nuit, incidents_alcool)
└── simulation_state.py      # SimulationState (run_id, config, dynamic_state)

tests/core/evolution/
└── test_evolution.py        # tests évolution, bornes, reproductibilité, intégration
```

### Flux J→J+1

```
JOUR J
├─ trafic_J[microzone] = 0.6
├─ incidents_nuit_J[microzone][type] = 3
└─ incidents_alcool_J[microzone][type] = 2
    │
    │ ÉVOLUTION (Story 1.4.4.2)
    ▼
JOUR J+1
├─ trafic_J1 = evoluer_trafic_J1(trafic_J, incidents_J)
├─ incidents_nuit_J1 = evoluer_nuit_J1(incidents_nuit_J, ...)
└─ incidents_alcool_J1 = evoluer_alcool_J1(incidents_alcool_J, ...)
```

### Dependencies

- Story 1.4.4.1 (matrices fixes) : Charge matrices trafic et alcool/nuit
- Story 2.1.2 (structure simulation) : Utilise `SimulationState.dynamic_state`

### Testing Standards

- Tests unitaires : Vérifier chaque fonction d'évolution
- Tests de validation : Mémoire (60-70%), corrélations, saisonnalité, bornes
- Tests de reproductibilité : Seed fixe → résultats identiques
- Framework : pytest
- Emplacement : `tests/core/evolution/test_*.py`

---

## Dev Agent Record

### Agent Model Used
_Implémentation via src/core + tests_

### Debug Log References
_Aucun._

### Completion Notes List

- **Trafic** : `evoluer_trafic_J1` utilise `facteur_memoire` (matrices trafic), (1−mem)×U(0,1), influence accidents (+0.05) / incendies moyen·grave (−0.03), clamp [0,1].
- **Nuit** : `evoluer_incidents_nuit_J1` utilise mémoire 0.65, corrélations inter-type (scalarisation via moyenne [b,m,g]), saisonnalité +20% été, bruit gaussien puis arrondi.
- **Alcool** : `evoluer_incidents_alcool_J1` idem, +50% pour accidents en été.
- **DynamicState** : `trafic`, `incidents_nuit`, `incidents_alcool` ; `ensure_microzones`, `copy`.
- **SimulationState** : structure minimale avec `dynamic_state` (Story 2.1.2 partielle).
- **Loader** : `load_matrices_for_evolution(source_dir)` charge trafic, alcool/nuit, inter-type depuis pickle.
- **evoluer_dynamic_state** : met à jour `state` en place à partir des trois évolutions et des matrices.
- **Tests** : `tests/core/evolution/test_evolution.py` ; pas de `__init__.py` sous `tests/core` pour éviter conflit avec `src/core`. Insertion de `src` dans `sys.path` au début du fichier de test.

### File List

| Fichier | Modifié / Créé |
|---------|----------------|
| `src/core/__init__.py` | Créé |
| `src/core/state/__init__.py` | Créé |
| `src/core/state/dynamic_state.py` | Créé |
| `src/core/state/simulation_state.py` | Créé |
| `src/core/evolution/__init__.py` | Créé |
| `src/core/evolution/_loader.py` | Créé |
| `src/core/evolution/trafic_evolution.py` | Créé |
| `src/core/evolution/nuit_evolution.py` | Créé |
| `src/core/evolution/alcool_evolution.py` | Créé |
| `tests/core/conftest.py` | Créé |
| `tests/core/evolution/test_evolution.py` | Créé |

### Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 29 Jan 2026 | 1.0 | Création story suite au découpage 1.4.4 | PM |
| 29 Jan 2026 | 1.1 | Implémentation : evolution, DynamicState, SimulationState, loader, tests | Dev |

---

## Références

- **Documentation découpage** : `story/1.4.4-DECOUPAGE-STORIES.md`
- **Diagramme découpage** : `story/1.4.4-DIAGRAMME-DECOUPAGE.md`
- **Documentation architecture** : `docs/architecture/impact-decoupage-1.4.4.md`
- **Story matrices fixes** : `story/1.4.4.1-precompute-matrices-correlation.md`
- **Story structure simulation** : `story/2.1.2-simulation-state-structure.md`
