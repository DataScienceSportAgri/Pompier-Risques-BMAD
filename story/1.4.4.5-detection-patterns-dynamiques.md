# Story 1.4.4.5 : Détection et Gestion Patterns Dynamiques

**Status:** Done  
**Epic:** Epic 2 - Système de Simulation et Prédiction  
**Story Number:** 1.4.4.5

---

## Story

**As a** système de simulation,  
**I want** détecter et gérer le cycle de vie des patterns dynamiques (4j→7j, 60j),  
**so that** les patterns peuvent moduler les probabilités d'incidents selon l'historique récent.

---

## Contexte et Clarifications

Cette story fait partie du découpage de la story 1.4.4 (matrices de corrélation et patterns dynamiques). Suite aux clarifications de l'orchestrator et de l'architecte :

- **Détection patterns** : Analyse de l'historique pour détecter des patterns (4j→7j, 60j).
- **Gestion cycle de vie** : Patterns créés, gérés (pic, fin) et supprimés automatiquement.
- **Limitation** : Maximum 3 patterns actifs par microzone.
- **Indépendance** : Peut être développée en parallèle avec Story 1.4.4.3 (application matrices).

**Cette story se concentre uniquement sur la détection et la gestion des patterns, pas sur leur application.**

---

## Acceptance Criteria

1. **Détection pattern 4j → 7j** : Détection d'un pattern court-terme :
   - Condition : 1 agression par jour (n'importe quel niveau : bénin, moyen, grave) pendant 4 jours consécutifs
   - Action : Création d'un pattern 7j avec structure complète
   - Structure : Début, pic (jour 3), fin (jour 7), amplitude base (+0.1), amplitude pic (+0.15)

2. **Détection pattern 60j** : Détection d'un pattern long-terme :
   - Condition : Aucune agression pendant 7 jours consécutifs
   - Action : Création d'un pattern 60j avec 3 phases
   - Structure : Phase 1 (jours 1-20, +0.05), Phase 2 (jours 21-40, -0.05), Phase 3 (jours 41-60, +0.1)

3. **Gestion cycle de vie** : Gestion automatique des patterns actifs :
   - Début : Pattern créé à la détection
   - Pic : Jour 3 pour pattern 7j (amplitude maximale)
   - Fin : Pattern supprimé après durée (7 jours ou 60 jours)

4. **Limitation à 3 patterns max** : Maximum 3 patterns actifs par microzone :
   - Priorisation : Règle de priorité (pattern 7j > pattern 60j, ou autre règle)
   - Suppression : Suppression du pattern le moins prioritaire si limite atteinte

5. **Structure de données** : Patterns stockés dans `SimulationState` :
   - Format : `Dict[microzone_id, List[Pattern]]` (max 3 par microzone)
   - Chaque pattern : type (7j/60j), jour_début, jour_actuel, amplitude, phase (pour 60j)

6. **Tests** : Validation détection, création, cycle de vie, limitation, priorisation.

---

## Integration Verification

IV1: Patterns détectés correctement selon conditions (4j→7j, 60j).  
IV2: Cycle de vie géré automatiquement (début, pic, fin).  
IV3: Limitation à 3 patterns respectée par microzone.

---

## Tasks / Subtasks

- [x] Implémenter détection pattern 4j → 7j (1 agression/jour tout niveau, 4 jours consécutifs)
- [x] Implémenter détection pattern 60j (aucune agression 7 jours consécutifs)
- [x] Implémenter création structure pattern 7j (début, pic jour 3, fin, amplitudes)
- [x] Implémenter création structure pattern 60j (3 phases, amplitudes)
- [x] Implémenter gestion cycle de vie (début, pic, fin, suppression)
- [x] Implémenter limitation à 3 patterns max par microzone
- [x] Implémenter priorisation patterns (règle de priorité 7j > 60j)
- [x] Intégrer dans `SimulationState` (structure de données)
- [x] Tests : détection 4j (4 jours consécutifs)
- [x] Tests : détection 60j (7 jours sans agression)
- [x] Tests : création pattern 7j (structure, pic jour 3)
- [x] Tests : création pattern 60j (3 phases)
- [x] Tests : limitation (max 3 patterns)
- [x] Tests : priorisation (règles de priorité)
- [x] Tests : cycle de vie (début, pic, fin)

---

## Dev Notes

### Architecture Context

- **Détection** : Analyse historique (7 jours pour 4j→7j, 7 jours pour 60j)
- **Patterns dynamiques** : Créés pendant la simulation, pas pré-calculés
- **Cycle de vie** : Patterns actifs gérés automatiquement (création, pic, fin)
- **Limitation** : Maximum 3 patterns par microzone pour éviter explosion combinatoire

### Source Tree

```
src/core/patterns/
├── __init__.py
├── pattern_detector.py      # detect_pattern_4j, detect_pattern_60j, create_pattern_7j, create_pattern_60j
└── pattern_manager.py       # add_pattern, update_patterns, remove_expired_patterns (max 3, priorité 7j>60j)

src/core/state/simulation_state.py  # patterns_actifs: Dict[mz, List[Pattern]]

tests/core/patterns/
└── test_detection.py        # détection, création, limitation, priorisation, cycle de vie
```

### Flux de Détection

```
Historique 7 jours (agressions par jour : bénin, moyen, grave)
    │
    ├─ Analyse : 1 agression/jour (tout niveau) 4 jours consécutifs ?
    │  └─ OUI → Créer pattern 7j
    │
    └─ Analyse : Aucune agression 7 jours consécutifs ?
       └─ OUI → Créer pattern 60j
           │
           ▼
Patterns actifs (max 3 par microzone)
```

### Dependencies

- Story 2.1.2 (structure simulation) : Stocker patterns dans `SimulationState`
- Story 2.2.1 (génération vecteurs) : Historique nécessaire pour détection
- Story 1.4.4.6 (application patterns) : Utilisera les patterns détectés

### Testing Standards

- Tests unitaires : Vérifier détection, création, cycle de vie
- Tests de validation : Limitation 3 max, priorisation, structure patterns
- Tests d'intégration : Détection + gestion cycle de vie
- Framework : pytest
- Emplacement : `tests/core/patterns/test_detection.py`

---

## Dev Agent Record

### Agent Model Used
_Implémentation via src/core/patterns + SimulationState.patterns_actifs_

### Debug Log References
_Aucun._

### Completion Notes List

- **4j→7j** : 1 agression par jour (n'importe quel niveau) pendant 4 jours consécutifs. `historique[mz]` = liste (n_benin, n_moyen, n_grave) par jour (ancien → récent).
- **60j** : aucune agression pendant 7 jours consécutifs.
- **Structures** : `create_pattern_7j` / `create_pattern_60j` (type, jour_debut, jour_actuel, amplitudes, duree, phase pour 60j).
- **Gestion** : `add_pattern` (max 3, priorité 7j > 60j), `update_patterns` (avance jour_actuel, phase 60j), `remove_expired_patterns` (jour_actuel >= duree).
- **SimulationState** : `patterns_actifs: Dict[mz, List[dict]]`.

### File List

| Fichier | Modifié / Créé |
|---------|----------------|
| `src/core/patterns/__init__.py` | Créé |
| `src/core/patterns/pattern_detector.py` | Créé |
| `src/core/patterns/pattern_manager.py` | Créé |
| `src/core/state/simulation_state.py` | Modifié (patterns_actifs) |
| `tests/core/patterns/test_detection.py` | Créé |

### Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 29 Jan 2026 | 1.0 | Création story suite au découpage 1.4.4 | PM |
| 29 Jan 2026 | 1.1 | Implémentation ; 4j = 1 agression/jour tout niveau | Dev |

---

## Références

- **Documentation découpage** : `story/1.4.4-DECOUPAGE-STORIES.md`
- **Diagramme découpage** : `story/1.4.4-DIAGRAMME-DECOUPAGE.md`
- **Documentation architecture** : `docs/architecture/impact-decoupage-1.4.4.md`
- **Story structure simulation** : `story/2.1.2-simulation-state-structure.md`
- **Story application patterns** : `story/1.4.4.6-application-patterns.md`
