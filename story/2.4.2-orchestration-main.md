# Story 2.4.2 : Orchestration (main.py, config, simulation sans UI)

**Status:** Ready for Review  
**Epic:** Epic 2 - Système de Simulation et Prédiction  
**Story Number:** 2.4.2

---

## Story

**As a** développeur,  
**I want** brancher `main.py` (config, simulation, Streamlit) **après** la structure Streamlit (2.4.1),  
**so that** la simulation est exécutable avec ou sans UI.

---

## Acceptance Criteria

1. **Ordre** : **2.4.1 avant 2.4.2** — d'abord layout Streamlit, puis branchement de `main.py`.
2. `main.py` charge la config (`config/`), lance la boucle de simulation, peut lancer Streamlit. Pas de pré-calculs (Epic 1).
3. **Mode headless** : N jours / N runs sans UI. **Pas d'obligation** de fichiers de sortie supplémentaires (pickles/trace par run suffisent).
4. Tests : pipeline config → simulation OK sans Streamlit.

---

## Integration Verification

IV1: Headless produit sorties conformes (pickles, trace) si implémenté.  
IV2: `streamlit run ...` lance l'app sans erreur une fois orchestré.

---

## Tasks / Subtasks

- [x] Créer `main.py` à la racine du projet
- [x] Implémenter chargement config depuis `config/config.yaml`
- [x] Implémenter validation config (structure, valeurs, chemins)
- [x] Implémenter mode headless (simulation sans UI)
- [x] Implémenter mode UI (lancement Streamlit)
- [x] Implémenter argument CLI pour choisir mode (--headless, --ui, ou défaut)
- [x] Implémenter orchestration boucle simulation (appel SimulationService)
- [x] Implémenter gestion 50 runs (1 affiché + 49 silencieux)
- [x] Tests : pipeline config → simulation headless OK
- [x] Tests : lancement Streamlit depuis main.py OK

---

## Dev Agent Record

### Agent Model Used
Cursor (Auto)

### Completion Notes
- `main.py` créé à la racine : argparse (--ui, --headless, --runs, --days, --config, --no-pickles, --no-trace), chargement/validation config, lancement Streamlit ou simulation headless.
- Config chargée via `PathResolver.config_file` + `load_and_validate_config` (Story 2.1.3).
- Mode headless : `SimulationService.run_headless` (N runs × M jours), sauvegarde optionnelle pickle + trace JSON par run dans `data/intermediate/run_XXX/`.
- Mode UI : `streamlit run src/adapters/ui/streamlit_app.py` (délégation vers `src.ui.web_app`), ou `src/ui/web_app.py` en fallback.
- Défaut sans mode explicite : mode UI.
- `SimulationService` dans `src/services/simulation_service.py` : orchestration `GenerationService` + `SimulationState`, `_get_microzone_ids` via `StaticVectorLoader`, `run_one` pour usage UI futur.
- Adapter `src/adapters/ui/streamlit_app.py` ajouté pour `streamlit run ...` conforme à la story.
- Tests dans `tests/integration/test_main.py` : config load/validate, headless pipeline (2 runs × 3 jours, pickle+trace), CLI headless, lancement UI (timeout après démarrage).
- Correctif `effets_reduction` dans `generation_service.generate_day` (utilisation de `get_effets_reduction_actifs`).

### File List
**Nouveaux :**
- `main.py` — point d'entrée orchestration
- `src/services/simulation_service.py` — SimulationService
- `src/adapters/__init__.py`, `src/adapters/ui/__init__.py`, `src/adapters/ui/streamlit_app.py`
- `tests/integration/__init__.py`, `tests/integration/conftest.py`, `tests/integration/test_main.py`

**Modifiés :**
- `src/core/generation/generation_service.py` — fix `effets_reduction` dans `generate_day`

### Debug Log References
Aucune.

### Status
Ready for Review

---

## Dev Notes

### Architecture Context

- **main.py** : Point d'entrée principal, orchestre config, simulation et UI
- **Config** : Fichier YAML unique partagé entre pré-calculs et application (Story 1.1)
- **Mode headless** : Simulation exécutable sans UI pour 49 runs silencieux (parallélisation)
- **Mode UI** : Lancement Streamlit pour 1 run affiché
- **Ordre** : Story 2.4.1 (layout Streamlit) **avant** Story 2.4.2 (orchestration)
- **Pas de pré-calculs** : Epic 1 gère les pré-calculs séparément

### Source Tree

```
main.py                    # Point d'entrée (orchestration)

config/
└── config.yaml           # Config partagée (Story 1.1)

src/
├── services/
│   └── simulation_service.py
└── adapters/
    └── ui/
        └── streamlit_app.py
```

### Dependencies

- Config : Story 1.1 (fichier config.yaml)
- SimulationService : Story 2.2.x (génération, Golden Hour, etc.)
- Streamlit UI : Story 2.4.1 (layout de base)

### Exemple d'utilisation

```python
# Mode headless
python main.py --headless --runs 50 --days 365

# Mode UI
python main.py --ui
# ou
streamlit run src/adapters/ui/streamlit_app.py
```

### Testing Standards

- Tests unitaires : Chargement config, validation config
- Tests d'intégration : Pipeline config → simulation headless
- Tests manuels : Lancement Streamlit depuis main.py
- Framework : pytest
- Emplacement : `tests/integration/test_main.py`

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 28 Jan 2026 | 1.0 | Création story | PM |
| 29 Jan 2026 | 1.1 | Implémentation 2.4.2 (main, SimulationService, adapters UI, tests intégration) | Dev |
