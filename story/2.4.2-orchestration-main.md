# Story 2.4.2 : Orchestration (main.py, config, simulation sans UI)

**Status:** Draft  
**Epic:** Epic 2 - Système de Simulation et Prédiction  
**Story Number:** 2.4.2

---

## Story

**As a** développeur,  
**I want** brancher `main.py` (config, simulation, Streamlit) **après** la structure Streamlit (2.4.1),  
**so that** la simulation est exécutable avec ou sans UI.

---

## Acceptance Criteria

1. **Ordre** : **2.4.1 avant 2.4.2** — d'abord layout Streamlit, puis branchement de `main.py`.
2. `main.py` charge la config (`config/`), lance la boucle de simulation, peut lancer Streamlit. Pas de pré-calculs (Epic 1).
3. **Mode headless** : N jours / N runs sans UI. **Pas d'obligation** de fichiers de sortie supplémentaires (pickles/trace par run suffisent).
4. Tests : pipeline config → simulation OK sans Streamlit.

---

## Integration Verification

IV1: Headless produit sorties conformes (pickles, trace) si implémenté.  
IV2: `streamlit run ...` lance l'app sans erreur une fois orchestré.

---

## Tasks / Subtasks

- [ ] Créer `main.py` à la racine du projet
- [ ] Implémenter chargement config depuis `config/config.yaml`
- [ ] Implémenter validation config (structure, valeurs, chemins)
- [ ] Implémenter mode headless (simulation sans UI)
- [ ] Implémenter mode UI (lancement Streamlit)
- [ ] Implémenter argument CLI pour choisir mode (--headless, --ui, ou défaut)
- [ ] Implémenter orchestration boucle simulation (appel SimulationService)
- [ ] Implémenter gestion 50 runs (1 affiché + 49 silencieux)
- [ ] Tests : pipeline config → simulation headless OK
- [ ] Tests : lancement Streamlit depuis main.py OK

---

## Dev Notes

### Architecture Context

- **main.py** : Point d'entrée principal, orchestre config, simulation et UI
- **Config** : Fichier YAML unique partagé entre pré-calculs et application (Story 1.1)
- **Mode headless** : Simulation exécutable sans UI pour 49 runs silencieux (parallélisation)
- **Mode UI** : Lancement Streamlit pour 1 run affiché
- **Ordre** : Story 2.4.1 (layout Streamlit) **avant** Story 2.4.2 (orchestration)
- **Pas de pré-calculs** : Epic 1 gère les pré-calculs séparément

### Source Tree

```
main.py                    # Point d'entrée (orchestration)

config/
└── config.yaml           # Config partagée (Story 1.1)

src/
├── services/
│   └── simulation_service.py
└── adapters/
    └── ui/
        └── streamlit_app.py
```

### Dependencies

- Config : Story 1.1 (fichier config.yaml)
- SimulationService : Story 2.2.x (génération, Golden Hour, etc.)
- Streamlit UI : Story 2.4.1 (layout de base)

### Exemple d'utilisation

```python
# Mode headless
python main.py --headless --runs 50 --days 365

# Mode UI
python main.py --ui
# ou
streamlit run src/adapters/ui/streamlit_app.py
```

### Testing Standards

- Tests unitaires : Chargement config, validation config
- Tests d'intégration : Pipeline config → simulation headless
- Tests manuels : Lancement Streamlit depuis main.py
- Framework : pytest
- Emplacement : `tests/integration/test_main.py`

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 28 Jan 2026 | 1.0 | Création story | PM |
