# Story 2.4.5.1 : Affichage des features hebdomadaires au clic sur arrondissement (web_app)

**Status:** Ready for Review  
**Epic:** Epic 2 - Système de Simulation et Prédiction  
**Story Number:** 2.4.5.1

---

## Story

**As a** utilisateur,  
**I want** afficher les features hebdomadaires en cliquant sur les rectangles d'arrondissements (colonne 1 en mode Entraînement, colonnes 2 ou 3 en mode Prédiction),  
**so that** je peux inspecter les données de la semaine en cours (entraînement) ou l'ensemble des 90 features utilisées pour une prédiction.

---

## Acceptance Criteria

### A. Mode Entraînement — Colonne 1 (rectangles arrondissements)

1. **Clic sur rectangle arrondissement** → une **fenêtre** (dialog, modal ou expander) s'ouvre.
2. **Contenu** : les **18 features de la semaine en cours** pour l'arrondissement sélectionné (agrégation microzones → arrondissement, données de la simulation en cours).
3. Features affichées avec **titres compréhensibles** (libellés standardisés : agressions_moyen_grave, agressions_benin, incendies_moyen_grave, etc. — nomenclature Story 2.2.5 / 2.3.1).
4. Fermeture fluide (bouton fermer, clic extérieur ou touche Échap).

### B. Mode Prédiction — Colonnes 2 ou 3 (encarts prédiction / label réel)

5. **Clic sur encart** (rectangle prédiction ou rectangle label réel) d'un arrondissement → ouverture dans un **nouvel onglet** (ou fenêtre dédiée) avec l'**ensemble des 90 features** utilisées pour cet arrondissement et cette période.
6. **Contenu** : les 90 features avec **titres compréhensibles** (nomenclature central_sem_m1_*, central_sem_m2_*, …, voisins_moy_sem_m1_* déjà standardisée — mapping vers libellés lisibles : ex. « Central dernière semaine – Agressions moyen+grave »).
7. Affichage structuré (tableau ou liste) : nom feature → valeur. Regroupement par bloc (central sem_m1, central sem_m2..m4, voisins_moy sem_m1) recommandé pour lisibilité.

### C. Technique et non-régression

8. **Source des données** :
   - Mode Entraînement : `SimulationState` + `StateCalculator` (features semaine courante) ou équivalent disponible en cours de run.
   - Mode Prédiction : `ml_labels_par_periode`, `ml_preds_par_periode` + extraction des 90 features depuis le DataFrame ML (`features_labels.pkl` ou session).
9. **Tests manuels** : ouverture/fermeture fenêtre (mode Entraînement), ouverture nouvel onglet (mode Prédiction), données cohérentes, pas de régression Lancer/Stop.

---

## Integration Verification

IV1: En mode Entraînement, clic sur rectangle arrondissement ouvre une fenêtre avec les 18 features de la semaine en cours.  
IV2: En mode Prédiction, clic sur encart colonne 2 ou 3 ouvre un nouvel onglet avec les 90 features et titres lisibles.  
IV3: Les données affichées correspondent à l'arrondissement et à la période sélectionnés.  
IV4: Pas de régression sur le comportement existant (Lancer, Stop, Prédiction, Entraînement).

---

## Tasks / Subtasks

- [x] Implémenter détection clic sur rectangle arrondissement (colonne 1)
- [x] Implémenter fenêtre/modal/expander pour affichage 18 features (mode Entraînement)
- [x] Implémenter récupération features semaine courante depuis SimulationState (ou StateCalculator)
- [x] Implémenter affichage 18 features avec titres compréhensibles (libellés standardisés)
- [x] Implémenter détection clic sur encart colonne 2 (Prédiction) et colonne 3 (Label réel)
- [x] Implémenter ouverture nouvel onglet / fenêtre avec 90 features
- [x] Implémenter mapping 90 noms techniques → titres lisibles (central_sem_m1_*, voisins_moy_sem_m1_*, etc.)
- [x] Implémenter affichage structuré des 90 features (regroupement par bloc)
- [x] Implémenter récupération des 90 features depuis DataFrame ML / session pour arrondissement + période
- [x] Tests manuels : fenêtre entraînement, nouvel onglet prédiction, cohérence données, non-régression

---

## Dev Notes

### Architecture Context

- **Colonne 1** (Arrondissements) : rectangles avec totaux cumulés par arrondissement (Story 2.4.1, 2.4.3.3). Visible en mode Entraînement et Prédiction.
- **Colonnes 2 et 3** (Prédiction, Label réel) : affichées uniquement en mode Prédiction (Story 2.4.2, 2.4.4).
- **18 features hebdomadaires** : Story 2.2.5 (StateCalculator), nomenclature FEATURE_COLUMNS_18 dans `ml_service.py`.
- **90 features ML** : central_sem_m1 (18) + central_sem_m2..m4 (54) + voisins_moy_sem_m1 (18), nomenclature Story 2.3.1.

### Nomenclature des features (titres compréhensibles)

Les noms techniques (agressions_moyen_grave, accidents_benin, etc.) sont déjà lisibles. Pour les 90 features :
- Préfixes : `central_sem_m1_` → « Central dernière semaine – », `central_sem_m2_` → « Central semaine -2 – », etc.
- `voisins_moy_sem_m1_` → « Voisins (moyenne) dernière semaine – »
- Suffixes : réutilisation des noms FEATURE_COLUMNS_18 (ex. agressions_moyen_grave → « Agressions moyen+grave »).

### Source Tree

```
src/ui/
└── web_app.py               # Détection clics, fenêtre, nouvel onglet

src/services/
├── feature_calculator.py    # Features hebdomadaires (StateCalculator)
└── ml_service.py            # FEATURE_COLUMNS_18, nomenclature 90 features
```

### Dependencies

- UI Streamlit : Story 2.4.1, 2.4.3 (rectangles arrondissements)
- Mode Prédiction : Story 2.4.2, 2.4.4 (colonnes 2, 3)
- Features : Story 2.2.5 (18 features), Story 2.3.1 (90 features ML)
- SimulationState : Story 2.1.x (état simulation)

### Implémentation suggérée

- **Clic colonne 1** : Streamlit ne supporte pas nativement le clic sur HTML. Options : (a) boutons Streamlit par arrondissement au lieu de HTML ; (b) composant custom (streamlit-component) ; (c) selectbox/radio « Sélectionner arrondissement » déclenchant l'affichage dans un expander.
- **Clic colonnes 2/3** : même contrainte. Alternative : selectbox « Inspecter arrondissement » + bouton « Ouvrir features 90 » qui génère une page HTML exportable ou ouvre dans un nouvel onglet via `st.download_button` (HTML) ou lien `target="_blank"` si on génère une page statique.
- **Streamlit multi-page** : possibilité d'utiliser `st.page_link` ou `st.switch_page` (Streamlit 1.30+) pour naviguer vers une page dédiée affichant les 90 features.

### Testing Standards

- Tests manuels : ouverture/fermeture fenêtre, ouverture nouvel onglet, données correctes
- Non-régression : Lancer, Stop, Prédiction, Entraînement fonctionnent comme avant
- Framework : Tests manuels (pas d'automatisation UI Streamlit en MVP)
- Emplacement : Tests manuels documentés

---

## File List

- `src/ui/web_app.py` — modifié (FEATURE_LABELS_18, _get_features_18_current_week, _feature_90_col_to_readable, _get_90_features_data, _build_90_features_html_table, selectbox + expander 18 features, expander 90 features + download HTML)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 03 Feb 2026 | 1.0 | Création story | PM |
| 03 Feb 2026 | 1.1 | Implémentation Story 2.4.5.1 : 18 features (selectbox + expander), 90 features (expander + download HTML) | Dev |
