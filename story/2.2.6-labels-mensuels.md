# Story 2.2.6 : Labels mensuels — LabelCalculator (Étape 6)

**Status:** Draft  
**Epic:** Epic 2 - Système de Simulation et Prédiction  
**Story Number:** 2.2.6

---

## Story

**As a** système de simulation,  
**I want** calculer labels (score et classes) mensuels à partir de morts + blessés graves,  
**so that** les modèles ML sont entraînés en supervision.

---

## Acceptance Criteria

1. Classe `LabelCalculator`. **Agrégation mensuelle** : **exactement 4 semaines** (pas de mois civils). Données Paris : peu de morts/blessés graves par arrondissement et par mois.
2. **Score** : `morts + 0.5 × blessés_graves` (par mois). **Seuils** : **1, 2 ou 3 morts/mois** selon la zone, ou **4 à 6 blessés graves** ; les 18 features prédisent ces labels.
3. **Classes** : Normal / Pre-catastrophique / Catastrophique selon ces seuils (détail dans `modele-j1-et-generation.md` ou implémentation).
4. **Seulement** casualties des événements (éviter double comptage). Sauvegarde labels + features dans DataFrame ML. **Prédiction** puis **réalité** pour comparaison.
5. Tests unitaires : formules, classes, agrégation mensuelle.

---

## Integration Verification

IV1: Labels alignés avec features (même arrondissement, même période).  
IV2: Pas de double comptage ; classes non ambiguës.

---

## Tasks / Subtasks

- [ ] Créer classe `LabelCalculator`
- [ ] Implémenter agrégation mensuelle (exactement 4 semaines)
- [ ] Implémenter calcul score (`morts + 0.5 × blessés_graves`)
- [ ] Implémenter détermination seuils (1, 2 ou 3 morts/mois selon zone, ou 4-6 blessés graves)
- [ ] Implémenter calcul classes (Normal / Pre-catastrophique / Catastrophique)
- [ ] Implémenter filtrage casualties événements uniquement (éviter double comptage)
- [ ] Implémenter sauvegarde labels + features dans DataFrame ML
- [ ] Implémenter prédiction puis réalité pour comparaison
- [ ] Tests : formules, classes, agrégation mensuelle

---

## Dev Notes

### Architecture Context

- **Labels mensuels** : Score et classes par arrondissement par mois (FR6)
- **Agrégation mensuelle** : Exactement 4 semaines (pas de mois civils)
- **Score** : `morts + 0.5 × blessés_graves` (les morts sont rares, les blessés enrichissent la prédiction)
- **Seuils** : 1, 2 ou 3 morts/mois selon zone, ou 4-6 blessés graves
- **Classes** : Normal / Pre-catastrophique / Catastrophique
- **Casualties événements uniquement** : Éviter double comptage avec vecteurs
- **Prédiction vs réalité** : Comparaison pour validation modèles ML

### Source Tree

```
src/services/
└── label_calculator.py      # LabelCalculator - calcul labels mensuels

data/intermediate/
└── run_XXX/
    └── ml/
        └── labels.pkl       # Labels sauvegardés
```

### Dependencies

- Morts/Blessés : Story 2.2.4 (casualties hebdomadaires)
- Features : Story 2.2.5 (18 features hebdomadaires)
- Événements : Story 2.2.7 (pour filtrer casualties événements uniquement)

### Formule score

```python
# Score mensuel par arrondissement
score = morts_mois + 0.5 * blesses_graves_mois

# Seuils (exemples)
if score <= seuil_normal:
    classe = "Normal"
elif score <= seuil_pre_catastrophe:
    classe = "Pre-catastrophique"
else:
    classe = "Catastrophique"
```

### Testing Standards

- Tests unitaires : Formules, classes, agrégation mensuelle
- Tests de validation : Pas de double comptage, classes non ambiguës
- Framework : pytest
- Emplacement : `tests/services/test_label_calculator.py`

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 28 Jan 2026 | 1.0 | Création story | PM |
