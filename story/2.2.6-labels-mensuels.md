# Story 2.2.6 : Labels mensuels — LabelCalculator (Étape 6)

**Status:** Draft  
**Epic:** Epic 2 - Système de Simulation et Prédiction  
**Story Number:** 2.2.6

---

## Story

**As a** système de simulation,  
**I want** calculer labels (score et classes) mensuels à partir de morts + blessés graves,  
**so that** les modèles ML sont entraînés en supervision.

---

## Acceptance Criteria

1. Classe `LabelCalculator`. **Agrégation mensuelle** : **exactement 4 semaines** (pas de mois civils). **Mois glissant** : Chaque fois qu'on passe un mois, on recalcule le label. Ce n'est pas un mois fixe, c'est un mois qui se décale à chaque fois.
2. **Score** : `morts + 0.5 × blessés_graves` (par mois). **Seuils** : **1, 2 ou 3 morts/mois** selon la zone, ou **4 à 6 blessés graves** ; les 144 features prédisent ces labels.
3. **Classes** : Normal / Pre-catastrophique / Catastrophique selon ces seuils (détail dans `modele-j1-et-generation.md` ou implémentation).
4. **Correspondance avec features** : Pour chaque mois, on prend **3 semaines des voisins avant la dernière semaine** (les 4 semaines des voisins sont prises avant la dernière semaine, donc la dernière semaine n'est pas prise en compte pour les voisins dans le label mensuel).
5. **Seulement** casualties des événements (éviter double comptage). Sauvegarde labels + features dans DataFrame ML. **Prédiction** puis **réalité** pour comparaison.
5. Tests unitaires : formules, classes, agrégation mensuelle.

---

## Integration Verification

IV1: Labels alignés avec features (même arrondissement, même période).  
IV2: Pas de double comptage ; classes non ambiguës.

---

## Tasks / Subtasks

- [x] Créer classe `LabelCalculator`
- [x] Implémenter agrégation mensuelle glissante (exactement 4 semaines, mois qui se décale)
- [x] Implémenter calcul score (`morts + 0.5 × blessés_graves`)
- [x] Implémenter détermination seuils (1, 2 ou 3 morts/mois selon zone, ou 4-6 blessés graves)
- [x] Implémenter calcul classes (Normal / Pre-catastrophique / Catastrophique)
- [x] Implémenter correspondance avec features (3 semaines voisins avant dernière semaine)
- [x] Implémenter filtrage casualties événements uniquement (éviter double comptage)
- [x] Implémenter sauvegarde labels + features dans DataFrame ML
- [x] Implémenter prédiction puis réalité pour comparaison
- [x] Tests : formules, classes, agrégation mensuelle

---

## Dev Notes

### Architecture Context

- **Labels mensuels** : Score et classes par arrondissement par mois (FR6)
- **Agrégation mensuelle** : Exactement 4 semaines (pas de mois civils)
- **Score** : `morts + 0.5 × blessés_graves` (les morts sont rares, les blessés enrichissent la prédiction)
- **Seuils** : 1, 2 ou 3 morts/mois selon zone, ou 4-6 blessés graves
- **Classes** : Normal / Pre-catastrophique / Catastrophique
- **Casualties événements uniquement** : Éviter double comptage avec vecteurs
- **Prédiction vs réalité** : Comparaison pour validation modèles ML

### Source Tree

```
src/services/
└── label_calculator.py      # LabelCalculator - calcul labels mensuels

data/intermediate/
└── run_XXX/
    └── ml/
        └── labels.pkl       # Labels sauvegardés
```

### Dependencies

- Morts/Blessés : Story 2.2.4 (casualties hebdomadaires)
- Features : Story 2.2.5 (18 features hebdomadaires)
- Événements : Story 2.2.7 (pour filtrer casualties événements uniquement)

### Formule score

```python
# Score mensuel par arrondissement
score = morts_mois + 0.5 * blesses_graves_mois

# Seuils (exemples)
if score <= seuil_normal:
    classe = "Normal"
elif score <= seuil_pre_catastrophe:
    classe = "Pre-catastrophique"
else:
    classe = "Catastrophique"
```

### Testing Standards

- Tests unitaires : Formules, classes, agrégation mensuelle
- Tests de validation : Pas de double comptage, classes non ambiguës
- Framework : pytest
- Emplacement : `tests/services/test_label_calculator.py`

---

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (via Cursor)

### Completion Notes
- ✅ Classe LabelCalculator : `LabelCalculator` avec agrégation mensuelle glissante (exactement 4 semaines)
- ✅ Agrégation mensuelle glissante : `_calculer_casualties_evenements_mois()` agrège 4 semaines consécutives
- ✅ Calcul score : `_calculer_score()` calcule `morts + 0.5 × blessés_graves`
- ✅ Détermination seuils : `_get_seuils_morts()` et `_get_seuils_blesses()` avec seuils par défaut (1-3 morts, 4-6 blessés) ou personnalisés par arrondissement
- ✅ Calcul classes : `_determiner_classe()` détermine Normal / Pre-catastrophique / Catastrophique selon seuils
- ✅ Correspondance avec features : `combiner_labels_features()` combine labels et features (3 semaines voisins avant dernière semaine)
- ✅ Filtrage casualties événements uniquement : `_calculer_casualties_evenements_mois()` utilise seulement `events_state` (évite double comptage avec vecteurs)
- ✅ Sauvegarde labels : `save_labels()` sauvegarde DataFrame en pickle standardisé dans `data/intermediate/run_XXX/ml/labels.pkl`
- ✅ Combinaison labels + features : `combiner_labels_features()` crée DataFrame ML avec labels et features
- ✅ Tests unitaires complets : Formules, classes, agrégation mensuelle, filtrage événements uniquement

### File List
**Nouveaux fichiers créés :**
- `src/services/label_calculator.py` - LabelCalculator pour calcul labels mensuels
- `tests/services/test_label_calculator.py` - Tests LabelCalculator

**Fichiers modifiés :**
- `src/services/__init__.py` - Ajout export LabelCalculator

### Debug Log References
- Filtrage événements : Utilisation uniquement `events_state.get_grave_events_for_day()` pour éviter double comptage avec vecteurs
- Agrégation mensuelle : Exactement 4 semaines (28 jours) par mois glissant
- Seuils : Par défaut 1-3 morts/mois ou 4-6 blessés graves/mois, personnalisables par arrondissement

### Status
Ready for Review

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 28 Jan 2026 | 1.0 | Création story | PM |
| 28 Jan 2026 | 1.1 | Ajout mois glissant et correspondance features (3 semaines voisins avant dernière semaine) | PM |
| 29 Jan 2026 | 1.2 | Implémentation complète - Calcul labels mensuels (score et classes) | Dev (James) |
