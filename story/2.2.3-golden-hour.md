# Story 2.2.3 : Golden Hour — calculs distances et stress (Étape 3)

**Status:** Draft  
**Epic:** Epic 2 - Système de Simulation et Prédiction  
**Story Number:** 2.2.3

---

## Story

**As a** système de simulation,  
**I want** calculer Golden Hour (temps trajet caserne→microzone→hôpital) avec congestion et stress,  
**so that** morts et blessés graves peuvent être calculés avec réalisme.

---

## Acceptance Criteria

1. **Chargement explicite** des trajets pré-calculés depuis `data/source_data/` (produits par Epic 1, Story 1.2). La story **doit** décrire explicitement ce chargement (pickle).
2. **Chargement table congestion** : Chargement de la **table de taux de ralentissement** pré-calculée depuis `data/intermediate/run_XXX/generation/congestion.pkl` (produite par Story 2.2.2.5). Cette table contient le facteur de congestion pour chaque microzone et chaque jour.
3. `temps_trajet_reel = temps_base × ∏(congestion_microzone_traversee)` où `congestion_microzone_traversee` est lu depuis la table pré-calculée (Story 2.2.2.5).
4. `temps_trajet = temps_base × (1 + stress_caserne × 0.1) × ∏(congestion)` ; `temps_total = temps_trajet + temps_traitement + temps_hopital_retour`.
5. Golden Hour : si `temps_total > 60 min` → `casualties × 1.3`. Stress : 30 pompiers/caserne, +0.4 par intervention.
6. Tests unitaires : distances, temps, Golden Hour, stress, chargement table congestion.

---

## Integration Verification

IV1: Trajets chargés depuis `data/source_data/` ; Golden Hour **avant** morts/blessés (ordre critique).  
IV2: Performances raisonnables pour toutes microzones.

---

## Tasks / Subtasks

- [ ] Implémenter chargement trajets depuis `data/source_data/` (pickle)
- [ ] Implémenter chargement table congestion depuis `data/intermediate/run_XXX/generation/congestion.pkl` (Story 2.2.2.5)
- [ ] Implémenter calcul temps trajet réel (temps_base × ∏(congestion_microzone_traversee)) avec table pré-calculée
- [ ] Implémenter calcul stress caserne (30 pompiers/caserne, +0.4 par intervention)
- [ ] Implémenter calcul temps trajet avec stress
- [ ] Implémenter calcul temps total (trajet + traitement + hôpital retour)
- [ ] Implémenter Golden Hour (si > 60 min → casualties × 1.3)
- [ ] Tests : distances, temps, Golden Hour, stress, chargement table congestion

---

## Dev Notes

### Architecture Context

- **Golden Hour** : Calcul temps trajet caserne→microzone→hôpital avec congestion et stress (FR3)
- **Chargement trajets** : Depuis `data/source_data/` (pré-calculés Epic 1, Story 1.2)
- **Table congestion** : **Pré-calculée** par Story 2.2.2.5 (table taux de ralentissement par microzone et par jour), chargée depuis `data/intermediate/run_XXX/generation/congestion.pkl`
- **Utilisation congestion** : `temps_trajet_reel = temps_base × ∏(congestion_microzone_traversee)` où chaque facteur de congestion est lu depuis la table pré-calculée
- **Stress caserne** : 30 pompiers/caserne, +0.4 par intervention
- **Golden Hour** : Si temps_total > 60 min → casualties × 1.3
- **Ordre critique** : Story 2.2.2.5 (pré-calcul congestion) **avant** Story 2.2.3 (Golden Hour) **avant** morts/blessés (Story 2.2.4)

### Source Tree

```
src/core/golden_hour/
└── golden_hour.py           # Calcul temps trajets (utilise table congestion pré-calculée)

data/source_data/
├── distances_caserne_microzone.pkl
└── distances_microzone_hopital.pkl

data/intermediate/
└── run_XXX/
    └── generation/
        └── congestion.pkl   # Table taux de ralentissement (Story 2.2.2.5)
```

### Dependencies

- Trajets pré-calculés : Epic 1, Story 1.2
- **Table congestion pré-calculée** : Story 2.2.2.5 (table taux de ralentissement par microzone et par jour)

### Testing Standards

- Tests unitaires : Distances, temps, Golden Hour, stress
- Tests de validation cohérence : Séparer **tous les trajets >60min vs <60min**, vérifier que sur grand nombre on a **toujours plus de morts dans >60min**
- Framework : pytest
- Emplacement : `tests/core/golden_hour/`

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 28 Jan 2026 | 1.0 | Création story | PM |
