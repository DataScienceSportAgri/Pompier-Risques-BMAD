# Story 2.2.3 : Golden Hour — calculs distances et stress (Étape 3)

**Status:** Draft  
**Epic:** Epic 2 - Système de Simulation et Prédiction  
**Story Number:** 2.2.3

---

## Story

**As a** système de simulation,  
**I want** calculer Golden Hour (temps trajet caserne→microzone→hôpital) avec congestion et stress,  
**so that** morts et blessés graves peuvent être calculés avec réalisme.

---

## Acceptance Criteria

1. **Chargement explicite** des trajets pré-calculés depuis `data/source_data/` (produits par Epic 1, Story 1.2). La story **doit** décrire explicitement ce chargement (pickle).
2. **Chargement table congestion** : Chargement de la **table de taux de ralentissement** pré-calculée depuis `data/intermediate/run_XXX/generation/congestion.pkl` (produite par Story 2.2.2.5). Cette table contient le facteur de congestion pour chaque microzone et chaque jour.
3. `temps_trajet_reel = temps_base × ∏(congestion_microzone_traversee)` où `congestion_microzone_traversee` est lu depuis la table de congestion (Story 2.2.2.5). **Différenciation nuit/alcool** :
   - **Si nuit** : `temps_trajet_reel = temps_base × ∏(congestion_microzone_traversee) × congestion_nuit` (congestion nuit depuis Story 2.2.2.5)
   - **Si alcool** : `temps_trajet_reel = temps_base × ∏(congestion_microzone_traversee) + 5 min` (ajout 5 minutes)
   - **Si nuit + alcool** : `temps_trajet_reel = temps_base × ∏(congestion_microzone_traversee) × congestion_nuit + 5 min`
   - **Jour (ni nuit ni alcool)** : Calcul classique `temps_trajet_reel = temps_base × ∏(congestion_microzone_traversee)`
4. **Système suivi interventions par caserne** : Table permanente du staff présent par caserne. À chaque intervention, retrait des pompiers, puis remise progressive jour après jour. Calcul de la caserne la plus proche **disponible** (staff suffisant). Si demande effective (staff insuffisant), calcul de la caserne disponible la plus proche.
5. **Hôpital le plus proche** : Systématiquement prendre l'hôpital le plus proche pour calcul Golden Hour.
6. `temps_trajet = temps_base × (1 + stress_caserne × 0.1) × ∏(congestion)` ; `temps_total = temps_trajet + temps_traitement + temps_hopital_retour`.
7. **Golden Hour** : Si `temps_total > 60 min`, **tirage au sort** pour déterminer si mort/blessé grave. Pas de multiplication par 1.3. Le tirage au sort utilise la Golden Hour comme facteur de probabilité (plus la Golden Hour est dépassée, plus la probabilité de mort/blessé grave augmente).
6. Tests unitaires : distances, temps, Golden Hour, stress, chargement table congestion.

---

## Integration Verification

IV1: Trajets chargés depuis `data/source_data/` ; Golden Hour **avant** morts/blessés (ordre critique).  
IV2: Performances raisonnables pour toutes microzones.

---

## Tasks / Subtasks

- [x] Implémenter chargement trajets depuis `data/source_data/` (pickle)
- [x] Implémenter chargement table congestion depuis `data/intermediate/run_XXX/generation/congestion.pkl` (Story 2.2.2.5)
- [x] Implémenter système suivi staff par caserne (table permanente, retrait/remise progressive)
- [x] Implémenter calcul caserne la plus proche disponible (staff suffisant)
- [x] Implémenter gestion demande effective (si staff insuffisant, caserne disponible la plus proche)
- [x] Implémenter calcul hôpital le plus proche
- [x] Implémenter calcul temps trajet réel avec différenciation nuit/alcool :
  - [x] Si nuit : appliquer congestion nuit (×congestion_nuit)
  - [x] Si alcool : ajouter 5 minutes (+5 min)
  - [x] Si nuit + alcool : congestion nuit + 5 min
  - [x] Si jour (ni nuit ni alcool) : calcul classique
- [x] Implémenter calcul stress caserne (30 pompiers/caserne, +0.4 par intervention)
- [x] Implémenter calcul temps trajet avec stress
- [x] Implémenter calcul temps total (trajet + traitement + hôpital retour)
- [x] Implémenter Golden Hour avec tirage au sort (probabilité selon dépassement 60 min)
- [x] Tests : distances, temps, Golden Hour, stress, suivi staff, chargement table congestion
- [x] Tests : différenciation nuit/alcool (congestion nuit, +5 min alcool)

---

## Dev Notes

### Architecture Context

- **Golden Hour** : Calcul temps trajet caserne→microzone→hôpital avec congestion et stress (FR3)
- **Chargement trajets** : Depuis `data/source_data/` (pré-calculés Epic 1, Story 1.2)
- **Table congestion** : **Pré-calculée** par Story 2.2.2.5 (table taux de ralentissement par microzone et par jour), chargée depuis `data/intermediate/run_XXX/generation/congestion.pkl`
- **Utilisation congestion** : `temps_trajet_reel = temps_base × ∏(congestion_microzone_traversee)` où chaque facteur de congestion est lu depuis la table pré-calculée
- **Différenciation nuit/alcool** :
  - **Nuit** : +congestion nuit (×congestion_nuit depuis Story 2.2.2.5)
  - **Alcool** : +5 min
  - **Nuit + alcool** : congestion nuit + 5 min
  - **Jour** : calcul classique
- **Stress caserne** : 30 pompiers/caserne, +0.4 par intervention
- **Golden Hour** : Si temps_total > 60 min, **tirage au sort** pour déterminer mort/blessé grave. Probabilité augmente avec dépassement Golden Hour.
- **Système suivi interventions** : Table permanente staff par caserne, retrait/remise progressive, calcul caserne disponible la plus proche
- **Hôpital** : Systématiquement le plus proche
- **Ordre critique** : Story 2.2.2.5 (congestion) **avant** Story 2.2.3 (Golden Hour) **avant** morts/blessés (Story 2.2.4)

### Source Tree

```
src/core/golden_hour/
├── golden_hour.py           # Calcul temps trajets (utilise table congestion)
└── caserne_manager.py       # Gestion staff casernes, calcul caserne disponible

data/source_data/
├── distances_caserne_microzone.pkl
└── distances_microzone_hopital.pkl

data/intermediate/
└── run_XXX/
    └── generation/
        └── congestion.pkl   # Table taux de ralentissement (Story 2.2.2.5)
```

### Système suivi interventions

```python
# Table permanente staff par caserne
staff_casernes = {
    'caserne_1': {'staff_total': 30, 'staff_disponible': 30, 'interventions_en_cours': []},
    # ...
}

# À chaque intervention
def retirer_pompiers(caserne_id, nb_pompiers):
    staff_casernes[caserne_id]['staff_disponible'] -= nb_pompiers
    staff_casernes[caserne_id]['interventions_en_cours'].append({
        'jour': current_day,
        'nb_pompiers': nb_pompiers,
        'duree_retour': 1  # Retour progressif jour après jour
    })

# Remise progressive
def remettre_pompiers():
    for caserne_id, caserne in staff_casernes.items():
        for intervention in caserne['interventions_en_cours']:
            if current_day >= intervention['jour'] + intervention['duree_retour']:
                caserne['staff_disponible'] += intervention['nb_pompiers']
                caserne['interventions_en_cours'].remove(intervention)

# Calcul caserne disponible la plus proche
def trouver_caserne_disponible(microzone_id):
    casernes_proches = trier_par_distance(microzone_id)
    for caserne in casernes_proches:
        if caserne['staff_disponible'] >= SEUIL_MIN_POMPIERS:
            return caserne
    # Si aucune disponible, prendre la plus proche quand même (demande effective)
    return casernes_proches[0]
```

### Golden Hour avec tirage au sort

```python
# Calcul probabilité selon Golden Hour
if temps_total > 60:
    depassement = temps_total - 60  # Minutes de dépassement
    prob_mort = min(0.9, 0.3 + (depassement / 60) * 0.6)  # Probabilité augmente avec dépassement
    prob_blesse_grave = min(0.8, 0.4 + (depassement / 60) * 0.4)
else:
    prob_mort = 0.1  # Probabilité de base même si Golden Hour respectée
    prob_blesse_grave = 0.2

# Tirage au sort
if random() < prob_mort:
    mort = True
elif random() < prob_blesse_grave:
    blesse_grave = True
```

### Dependencies

- Trajets pré-calculés : Epic 1, Story 1.2
- **Table congestion pré-calculée** : Story 2.2.2.5 (table taux de ralentissement par microzone et par jour)

### Testing Standards

- Tests unitaires : Distances, temps, Golden Hour, stress
- Tests de validation cohérence : Séparer **tous les trajets >60min vs <60min**, vérifier que sur grand nombre on a **toujours plus de morts dans >60min**
- Framework : pytest
- Emplacement : `tests/core/golden_hour/`

---

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (via Cursor)

### Completion Notes
- ✅ Chargement trajets depuis `data/source_data/` : `load_trajets()` charge distances_caserne_microzone.pkl et distances_microzone_hopital.pkl avec extraction distances et temps de base
- ✅ Chargement table congestion : `load_congestion_table()` charge depuis `data/intermediate/run_XXX/generation/congestion.pkl`
- ✅ Système suivi staff par caserne : `CaserneManager` avec table permanente, retrait/remise progressive jour après jour
- ✅ Calcul caserne disponible la plus proche : `trouver_caserne_disponible()` avec staff suffisant, gestion demande effective
- ✅ Calcul hôpital le plus proche : `trouver_hopital_plus_proche()` systématiquement le plus proche
- ✅ Calcul temps trajet réel avec différenciation nuit/alcool :
  - Nuit : congestion nuit déjà dans table (appliquée dans Story 2.2.2.5)
  - Alcool : +5 minutes (`AJOUT_ALCOOL_MINUTES`)
  - Nuit + alcool : congestion nuit + 5 min
  - Jour : calcul classique avec `temps_base × ∏(congestion_microzone_traversee)`
- ✅ Calcul stress caserne : `get_stress_caserne()` = nombre interventions × 0.4
- ✅ Calcul temps trajet avec stress : `temps_trajet × (1 + stress × 0.1)`
- ✅ Calcul temps total : `temps_trajet + temps_traitement + temps_hopital_retour`
- ✅ Golden Hour avec tirage au sort : probabilités selon dépassement 60 min (prob_mort et prob_blesse_grave augmentent avec dépassement)
- ✅ Tests unitaires complets : CaserneManager (retrait/remise, stress, caserne disponible), GoldenHourCalculator (distances, temps, Golden Hour, stress, différenciation nuit/alcool)

### File List
**Nouveaux fichiers créés :**
- `src/core/golden_hour/__init__.py` - Module Golden Hour
- `src/core/golden_hour/caserne_manager.py` - Gestionnaire de casernes et staff
- `src/core/golden_hour/golden_hour_calculator.py` - Calculateur de Golden Hour
- `tests/core/golden_hour/__init__.py` - Tests module
- `tests/core/golden_hour/test_caserne_manager.py` - Tests CaserneManager
- `tests/core/golden_hour/test_golden_hour_calculator.py` - Tests GoldenHourCalculator

### Debug Log References
- Chargement trajets : extraction distances et temps de base depuis pickle avec gestion format variable
- Congestion : utilisation table pré-calculée Story 2.2.2.5 avec facteur multiplicatif par microzone traversée
- Stress : application au temps de trajet avec facteur `(1 + stress × 0.1)`

### Status
Ready for Review

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 28 Jan 2026 | 1.0 | Création story | PM |
| 28 Jan 2026 | 2.0 | Ajout système suivi interventions par caserne, Golden Hour avec tirage au sort (pas ×1.3) | PM |
| 28 Jan 2026 | 2.1 | Ajout différenciation nuit/alcool (congestion nuit, +5 min alcool) | PM |
| 29 Jan 2026 | 2.2 | Implémentation complète - Calcul Golden Hour avec tous les effets | Dev (James) |
