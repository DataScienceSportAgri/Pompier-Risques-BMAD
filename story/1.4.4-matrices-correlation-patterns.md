# Story 1.4.4 : Matrices de corrélation et patterns dynamiques J→J+1

**Status:** Draft  
**Epic:** Epic 4 - Matrices de corrélation et patterns  
**Story Number:** 1.4.4  
**Parent Story:** 1.4

---

## Story

**As a** développeur,  
**I want** matérialiser les matrices de corrélation (intra-type, inter-type, voisins) et les patterns dynamiques (4j, 7j, 60j) pour la prédiction J→J+1,  
**so that** la génération de vecteurs journaliers peut utiliser ces corrélations et patterns pour produire des simulations réalistes.

---

## Acceptance Criteria

1. **Matrices de corrélation intra-type** : Matrices 3×3 (bénin, moyen, grave) pour chaque type d'incident et chaque microzone, modélisant les transitions J→J+1.
2. **Matrices de corrélation inter-type** : Matrices 3×3 pour chaque microzone modélisant l'influence des deux autres types d'incidents sur un type donné (J→J+1).
3. **Matrice voisin** : Matrices pour chaque microzone modélisant l'influence des 8 microzones voisines sur la microzone centrale (J→J+1).
4. **Effet d'augmentation** : Système appliquant +0.1 si délinquance supérieure à la microzone ou si >5 incidents totaux dans les 8 voisins.
5. **Pattern 4 jours → 7 jours** : Détection si 1 agression 4 jours consécutifs → déclenche pattern 7 jours avec +0.1 agressions/jour pendant 7 jours (pic jour 3).
6. **Pattern 60 jours** : Détection si aucune agression pendant 7 jours → déclenche pattern 60 jours avec +0.05/jour (jours 1-20), -0.05/jour (jours 21-40), +0.1/jour (jours 41-60).
7. **Limitation patterns** : Maximum 3 patterns actifs simultanément par microzone.
8. **Format de stockage** : Fichiers pickle standardisés dans `data/source_data/` pour toutes les matrices et patterns.
9. **Documentation** : Schéma de données et exemples d'utilisation.

---

## Integration Verification

IV1: Matrices de corrélation chargées et utilisables par Story 2.2.1 (génération vecteurs journaliers).  
IV2: Patterns détectés et appliqués correctement dans la simulation.  
IV3: Effets d'augmentation calculés et appliqués selon les règles définies.

---

## Tasks / Subtasks

### Epic 4.1 : Matrices de corrélation intra-type
- [ ] Définir structure de données pour matrices intra-type (3×3 par type d'incident × microzone)
- [ ] Créer fonction de calcul des matrices intra-type basée sur le modèle PDF
- [ ] Implémenter stockage pickle pour matrices intra-type
- [ ] Tests : validation structure, calculs corrects

### Epic 4.2 : Matrices de corrélation inter-type
- [ ] Définir structure de données pour matrices inter-type (influence croisée entre types)
- [ ] Créer fonction de calcul des matrices inter-type
- [ ] Implémenter stockage pickle pour matrices inter-type
- [ ] Tests : validation influence croisée

### Epic 4.3 : Matrice voisin (8 microzones)
- [ ] Créer fonction d'identification des 8 voisins pour chaque microzone
- [ ] Définir structure de données pour matrice voisin
- [ ] Créer fonction de calcul de l'influence des voisins
- [ ] Implémenter stockage pickle pour matrices voisin
- [ ] Tests : validation identification voisins, calculs d'influence

### Epic 4.4 : Effet d'augmentation
- [ ] Implémenter détection "délinquance supérieure à microzone"
- [ ] Implémenter détection ">5 incidents totaux dans 8 voisins"
- [ ] Appliquer +0.1 aux probabilités lorsque conditions remplies
- [ ] Tests : validation conditions et application correcte

### Epic 4.5 : Pattern 4 jours → 7 jours
- [ ] Implémenter détection "1 agression 4 jours consécutifs"
- [ ] Créer structure de données pour pattern 7 jours
- [ ] Implémenter application pattern : +0.1 agressions/jour pendant 7 jours (pic jour 3)
- [ ] Gestion cycle de vie pattern (début, pic, fin)
- [ ] Tests : validation détection et application

### Epic 4.6 : Pattern 60 jours
- [ ] Implémenter détection "aucune agression pendant 7 jours"
- [ ] Créer structure de données pour pattern 60 jours
- [ ] Implémenter application pattern : +0.05 (jours 1-20), -0.05 (jours 21-40), +0.1 (jours 41-60)
- [ ] Gestion cycle de vie pattern (3 phases)
- [ ] Tests : validation détection et application

### Epic 4.7 : Gestion patterns multiples
- [ ] Implémenter système de limitation à 3 patterns max par microzone
- [ ] Prioriser patterns actifs (règle de priorité)
- [ ] Gestion conflits entre patterns
- [ ] Tests : validation limitation et priorisation

### Epic 4.8 : Script de pré-calcul
- [ ] Créer script `precompute_matrices_correlation.py`
- [ ] Intégrer calcul de toutes les matrices
- [ ] Intégrer détection et création des patterns
- [ ] Sauvegarde dans `data/source_data/`
- [ ] Tests : validation script complet

---

## Dev Notes

### Architecture Context

- **Inspiration** : Modèle de prédiction J+1 du PDF "Modèle Prédiction Incidents J+1.pdf"
- **Format** : Pickle pour performance, JSON pour documentation
- **Référence** : Story 2.2.1 utilisera ces matrices pour génération vecteurs

### Source Tree

```
data/intermediate/patterns/                  # Fichiers temporaires pour génération patterns
├── pattern_4j_temp.pkl                      # Paramètres 4j (facteurs modulation, usage)
├── pattern_7j_temp.pkl                      # Paramètres 7j (trigger, amplitudes) → génère pattern 7j
└── pattern_60j_temp.pkl                     # Paramètres 60j (trigger, phases) → génère pattern 60j

data/source_data/
├── matrices_correlation_intra_type.pkl      # Matrices 3×3 par type × microzone
├── matrices_correlation_inter_type.pkl      # Matrices inter-type par microzone
├── matrices_voisin.pkl                      # Matrices voisin (8 voisins, seuil 5)
├── matrices_trafic.pkl                      # Engorgement / désengorgement
├── matrices_alcool_nuit.pkl                 # Prob. alcool / nuit par type
├── matrices_saisonnalite.pkl                # Facteurs saison par type
├── regles_effet_augmentation.pkl            # Règles fixes +0.1 (seuils, max 0.2)
├── pattern_7j_transition.pkl                # Matrice de transition 7j (générée depuis temp)
├── pattern_60j_transition.pkl               # Matrice de transition 60j (générée depuis temp)
└── regles_patterns.pkl                      # max 3 patterns actifs, priorité

scripts/
└── precompute_matrices_correlation.py       # Script de pré-calcul

docs/
└── matrices-correlation-reference.md        # Documentation des matrices
```

### Structure des Matrices

#### Matrice Intra-Type (3×3)
```python
# Pour chaque (microzone_id, type_incident)
matrice_intra_type = {
    'microzone_id': 'MZ001',
    'type_incident': 'agressions',
    'matrice': [
        [P(bénin→bénin), P(bénin→moyen), P(bénin→grave)],
        [P(moyen→bénin), P(moyen→moyen), P(moyen→grave)],
        [P(grave→bénin), P(grave→moyen), P(grave→grave)]
    ]
}
```

#### Matrice Inter-Type (3×3)
```python
# Pour chaque microzone_id, influence des autres types sur un type donné
matrice_inter_type = {
    'microzone_id': 'MZ001',
    'type_cible': 'agressions',
    'influence_incendies': [0.1, 0.05, 0.02],  # [bénin, moyen, grave]
    'influence_accidents': [0.08, 0.04, 0.01]
}
```

#### Matrice Voisin
```python
# Pour chaque microzone_id, influence des 8 voisins
matrice_voisin = {
    'microzone_id': 'MZ001',
    'voisins': ['MZ002', 'MZ003', ...],  # 8 voisins
    'poids_influence': [0.15, 0.12, ...],  # Poids par voisin
    'seuil_activation': 5  # Seuil pour effet d'augmentation
}
```

### Structure des Patterns

#### Pattern 7 jours (déclenché par 4 jours consécutifs)
```python
pattern_7j = {
    'pattern_id': 'p7j_MZ001_20260128',
    'microzone_id': 'MZ001',
    'type_incident': 'agressions',
    'type_pattern': '7j',
    'jour_debut': 10,
    'jour_fin': 16,
    'jour_pic': 12,  # Jour 3 du pattern (pic)
    'amplitude_base': 0.1,
    'amplitude_pic': 0.15,  # Pic au jour 3
    'etat': 'actif'  # actif, termine
}
```

#### Pattern 60 jours (déclenché par 7 jours sans agression)
```python
pattern_60j = {
    'pattern_id': 'p60j_MZ001_20260128',
    'microzone_id': 'MZ001',
    'type_incident': 'agressions',
    'type_pattern': '60j',
    'jour_debut': 20,
    'jour_fin': 79,
    'phase': 1,  # 1: +0.05 (jours 1-20), 2: -0.05 (jours 21-40), 3: +0.1 (jours 41-60)
    'amplitude_phase1': 0.05,
    'amplitude_phase2': -0.05,
    'amplitude_phase3': 0.1,
    'etat': 'actif'
}
```

### Algorithme de Détection Patterns

```python
def detecter_patterns(microzone_id, historique_7j, historique_60j):
    """
    Détecte les patterns à déclencher pour une microzone.
    
    Returns:
        Liste de patterns à activer (max 3)
    """
    patterns_actifs = []
    
    # Pattern 4j → 7j : 1 agression 4 jours consécutifs
    if detecter_4j_consecutifs(historique_7j, 'agressions'):
        pattern_7j = creer_pattern_7j(microzone_id, jour_actuel)
        patterns_actifs.append(pattern_7j)
    
    # Pattern 60j : aucune agression pendant 7 jours
    if detecter_7j_sans_agression(historique_7j):
        pattern_60j = creer_pattern_60j(microzone_id, jour_actuel)
        patterns_actifs.append(pattern_60j)
    
    # Limiter à 3 patterns max
    return patterns_actifs[:3]
```

### Fichiers temporaires pour génération des patterns

Les **fichiers temporaires** dans `data/intermediate/patterns/` (config : `paths.data_intermediate`) permettent de générer les patterns qui influencent les probabilités :

1. **`pattern_4j_temp.pkl`** : paramètres 4j (facteurs modulation, usage court terme).
2. **`pattern_7j_temp.pkl`** : trigger (4j consécutifs, 1 agression/jour), amplitudes (base, pic), jour du pic → utilisé pour générer `pattern_7j_transition`.
3. **`pattern_60j_temp.pkl`** : trigger (7j sans agression), amplitudes par phase, bornes des phases → utilisé pour générer `pattern_60j_transition`.

Le precompute **écrit** ces temporaires, puis **lit** 7j/60j pour **générer** les structures de transition sauvegardées dans `source_data`. La simulation utilise ces structures pour appliquer les patterns (influence sur les probabilités).

### Structures fixes pré-calculées (matrices de transition)

Le script `precompute_matrices_correlation.py` produit les structures **fixes** suivantes, en plus des matrices intra/inter/voisin/trafic/alcool/saisonnalité :

#### `regles_effet_augmentation.pkl`
```python
{
    "seuil_voisins_incidents": 5,
    "delta_par_condition": 0.1,
    "max_effet": 0.2,
    "conditions": ["delinquance_voisin_superieure", "voisins_incidents_sup_seuil"],
}
```

#### `pattern_7j_transition.pkl`
```python
{
    "type_pattern": "7j",
    "type_incident": "agressions",
    "vecteur_7j": [0.1, 0.1, 0.15, 0.1, 0.1, 0.1, 0.1],  # pic jour 3
    "amplitude_base": 0.1,
    "amplitude_pic": 0.15,
    "jour_pic": 3,
    "trigger": {"fenetre_jours": 4, "type_incident": "agressions", "min_par_jour": 1, "consecutifs": True},
}
```

#### `pattern_60j_transition.pkl`
```python
{
    "type_pattern": "60j",
    "type_incident": "agressions",
    "vecteur_60j": [0.05]*20 + [-0.05]*20 + [0.1]*20,
    "amplitude_phase1": 0.05, "amplitude_phase2": -0.05, "amplitude_phase3": 0.1,
    "phase1_jours": (1, 20), "phase2_jours": (21, 40), "phase3_jours": (41, 60),
    "trigger": {"fenetre_jours": 7, "type_incident": "agressions", "min_total": 0},
}
```

#### `regles_patterns.pkl`
```python
{"max_patterns_actifs": 3, "ordre_priorite": ["7j", "60j"]}
```

### Effet d'Augmentation (application en simulation)

```python
def calculer_effet_augmentation(microzone_id, voisins_data, delinquance_data):
    """
    Calcule l'effet d'augmentation (+0.1) si conditions remplies.
    
    Conditions:
    1. Délinquance voisin > délinquance microzone
    2. Total incidents dans 8 voisins > 5
    """
    effet = 0.0
    
    # Condition 1: Délinquance supérieure
    delinq_mz = delinquance_data[microzone_id]
    for voisin_id in voisins_data[microzone_id]['voisins']:
        if delinquance_data[voisin_id] > delinq_mz:
            effet += 0.1
            break
    
    # Condition 2: >5 incidents totaux dans voisins
    total_incidents = sum(compter_incidents(voisin_id) for voisin_id in voisins_data[microzone_id]['voisins'])
    if total_incidents > 5:
        effet += 0.1
    
    return min(effet, 0.2)  # Max +0.2
```

### Testing Standards

- Tests unitaires : Calcul matrices, détection patterns, effets d'augmentation
- Tests d'intégration : Chargement matrices, application patterns dans simulation
- Framework : pytest
- Emplacement : `tests/scripts/test_precompute_matrices_correlation.py`

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 28 Jan 2026 | 1.0 | Création Epic 4 - Matrices corrélation et patterns | PM |
| 29 Jan 2026 | 1.1 | Structures fixes précalculées : effet augmentation, pattern 7j/60j, regles patterns | Dev |
| 29 Jan 2026 | 1.2 | Fichiers temporaires data/intermediate/patterns (4j, 7j, 60j) pour génération patterns | Dev |
