# Story 2.4.2.1 : Paramètres de run — Scénario et Variabilité locale

**Status:** Done (implémenté dans cycle 2.4.2 / Architect)  
**Epic:** Epic 2 - Système de Simulation et Prédiction  
**Story Number:** 2.4.2.1

---

## Story

**As a** utilisateur ou opérateur,  
**I want** choisir un **scénario** (Pessimiste / Standard / Optimiste) et une **variabilité locale** (Faible / Moyenne / Forte) pour chaque run de simulation,  
**so that** je peux générer des trajectoires de risque plus ou moins pessimistes et avec plus ou moins de corrélation entre microzones voisines.

---

## Intention produit (comportement attendu)

### Scénario

| Valeur     | Effet sur le run |
|-----------|-------------------|
| **Pessimiste** | Génère **un peu plus** d'accidents, incendies et agressions (facteur d'intensité > 1 ; probabilité régime Crise plus élevée). |
| **Standard**   | Niveau **normal** (facteur 1.0, proba crise de référence). |
| **Optimiste**  | Génère **un peu moins** d'accidents, incendies et agressions (facteur < 1 ; proba crise plus faible). |

### Variabilité locale

| Valeur   | Effet sur les matrices de corrélation entre voisins |
|----------|------------------------------------------------------|
| **Forte**  | **Diminue légèrement** l'effet des matrices de corrélation entre voisins (microzones plus indépendantes). |
| **Moyenne**| Comportement **normal** (matrices voisins inchangées). |
| **Faible** | **Augmente légèrement** l'effet des matrices de corrélation entre voisins (plus de cohérence spatiale). |

---

## Acceptance Criteria

1. **Config** : La config (`config/config.yaml`) expose une section `scenarios` avec `pessimiste`, `moyen`, `optimiste` (ex. `facteur_intensite`, `proba_crise`).
2. **CLI headless** : `main.py --scenario Pessimiste|Standard|Optimiste --variabilite Faible|Moyenne|Forte` transmet les paramètres à chaque run.
3. **UI** : Deux sélecteurs (Scénario, Variabilité) sont disponibles ; les valeurs choisies sont transmises au clic LANCEMENT à `SimulationService.run_one(..., scenario_ui=..., variabilite_ui=...)`.
4. **Propagation** : `SimulationService` résout les paramètres (config + mapping UI → float) et les passe à `GenerationService` ; le **VectorGenerator** applique le facteur d'intensité du scénario ; le **MatrixModulator** utilise la variabilité locale pour la modulation voisins.
5. **Trace** : Chaque run enregistre dans `trace.json` les champs `scenario`, `variabilite`, `variabilite_locale`, `seed`.

---

## Integration Verification

IV1: Un run lancé en Pessimiste produit en moyenne plus d'incidents (accidents, incendies, agressions) qu'un run Standard ; un run Optimiste en produit moins.  
IV2: Un run en Variabilité Forte montre une dispersion spatiale légèrement plus marquée qu'en Faible (effet voisins atténué vs renforcé).

---

## Tasks / Subtasks

- [x] Définir section `scenarios` dans config (pessimiste, moyen, optimiste)
- [x] Implémenter `_resolve_run_params` dans SimulationService (scénario + variabilité UI → config + float)
- [x] Ajouter arguments CLI `--scenario` et `--variabilite` dans main.py
- [x] Passer `scenario_config` et `variabilite_locale` à GenerationService par run
- [x] Appliquer `facteur_intensite` dans VectorGenerator après calcul d'intensité
- [x] Appliquer `proba_crise` dans VectorGenerator (transition de régime Crise)
- [x] Utiliser `variabilite_locale` dans MatrixModulator (modulation voisins)
- [x] Écrire `scenario`, `variabilite`, `variabilite_locale`, `seed` dans trace.json par run
- [x] Exposer sélecteurs Scénario et Variabilité dans l'UI (Story 2.4.3 branche les valeurs au LANCEMENT)

---

## Dev Agent Record

### Completion Notes

- Implémentation réalisée dans le cycle 2.4.2 / document Architect `orchestration-parametres-run-architect.md`.
- Complément Dev : propagation et application de **proba_crise** (scénario) dans la chaîne J→J+1 : `GenerationService.generate_day` passe `proba_crise` à `VectorGenerator.generate_vectors_for_day` ; dans la transition de régime (par microzone), les probabilités de transition vers Crise sont modulées par `proba_crise / PROBA_CRISE_REF` puis renormalisées (avec ou sans modulation prix m²). Ainsi les deux modificateurs de probabilités du scénario agissent sur la génération : facteur_intensite sur les intensités, proba_crise sur le régime Crise.
- Fichiers : `simulation_service.py` (_resolve_run_params, run_headless, run_one), `generation_service.py` (scenario_config, variabilite_locale, passage proba_crise), `vector_generator.py` (facteur_intensite, proba_crise dans transition régime), `matrix_modulator.py` (variabilite_locale), `main.py` (--scenario, --variabilite), `web_app.py` (selectboxes Scénario/Variabilité).
- Story 2.4.3 : branchement des selectboxes au clic LANCEMENT vers `run_one(scenario_ui=..., variabilite_ui=...)`.

### File List

**Modifiés :**
- `src/core/generation/generation_service.py` — passage de `proba_crise` à `generate_vectors_for_day`
- `src/core/generation/vector_generator.py` — paramètre `proba_crise`, application dans transition de régime (Crise)

### Status

Done (implémenté ; cette story formalise l’intention produit et les AC).

---

## Dev Notes

### Dépendances

- Story 2.4.2 (orchestration main, SimulationService)
- Story 2.1.3 (validation config, section scenarios)
- Architecture : Strategy Pattern Scénarios, dataflow § 1.1 Paramètres de run

### Références

- `docs/architecture/dataflow.md` § 1.1 — Paramètres de run : Scénario et Variabilité locale
- `docs/architecture/orchestration-parametres-run-architect.md`
- `docs/naming-conventions.md` — Trace (champs scenario, variabilite, variabilite_locale, seed)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 30 Jan 2026 | 1.0 | Création story (intention produit Scénario + Variabilité) | PM |
| 30 Jan 2026 | 1.1 | Propagation proba_crise : GenerationService → VectorGenerator ; application dans transition de régime (Crise) | Dev |
