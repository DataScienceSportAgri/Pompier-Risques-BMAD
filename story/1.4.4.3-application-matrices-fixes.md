# Story 1.4.4.3 : Application Matrices Fixes aux Probabilités

**Status:** Done  
**Epic:** Epic 2 - Système de Simulation et Prédiction  
**Story Number:** 1.4.4.3

---

## Story

**As a** système de simulation,  
**I want** appliquer les matrices fixes pré-calculées pour moduler les probabilités d'incidents J→J+1,  
**so that** les corrélations spatiales, temporelles et inter-types sont prises en compte dans la génération.

---

## Contexte et Clarifications

Cette story fait partie du découpage de la story 1.4.4 (matrices de corrélation et patterns dynamiques). Suite aux clarifications de l'orchestrator et de l'architecte :

- **Matrices fixes** : Pré-calculées une seule fois (Story 1.4.4.1) et chargées au démarrage.
- **Application séquentielle** : Les matrices sont appliquées dans un ordre spécifique pour moduler les probabilités.
- **Sans variables d'état** : Cette story applique uniquement les matrices fixes, sans intégrer les variables d'état dynamiques (Story 1.4.4.4).

**Cette story se concentre uniquement sur l'application des matrices fixes.**

---

## Acceptance Criteria

1. **Application matrice intra-type** : Transition entre niveaux de gravité (bénin → moyen → grave) :
   - Format : Matrice 3×3 par type d'incident et par microzone
   - Application : Multiplication des probabilités de base par la matrice de transition
   - Validation : Somme de chaque ligne = 1 (probabilités de transition)

2. **Application matrice inter-type** : Influence croisée entre types d'incidents :
   - Format : Facteurs d'influence (ex. incendie → accidents ×1.3)
   - Application : Addition ou multiplication selon le type d'influence
   - Exemple : Si incendie grave → augmentation probabilités accidents

3. **Application matrice voisin** : Effet spatial des 8 microzones voisines :
   - Format : Poids d'influence pour chaque voisin
   - Application : Si >5 incidents voisins → +0.1 aux probabilités
   - Pondération : Grave ×1.0, moyen ×0.5, bénin ×0.2

4. **Application saisonnalité** : Facteurs saisonniers par type d'incident :
   - Format : Facteurs par saison (hiver, été, intersaison)
   - Application : Multiplication des probabilités par facteur saisonnier
   - Exemples : Hiver = +30% incendies, été = +20% agressions

5. **Fonction `calculer_probabilite_incidents_J1()`** : Fonction principale combinant toutes les matrices :
   - Entrée : Probabilités de base (vecteurs statiques), matrices fixes, état actuel
   - Sortie : Probabilités modulées (sans variables d'état dynamiques)
   - Ordre d'application : intra-type → inter-type → voisin → saisonnalité

6. **Tests** : Validation application de chaque matrice, ordre d'application, probabilités finales.

---

## Integration Verification

IV1: Matrices chargées depuis pré-calculs (Story 1.4.4.1) sans erreur.  
IV2: Probabilités modulées restent dans [0, 1] et sont cohérentes.  
IV3: Fonction utilisable par Story 2.2.1 (génération vecteurs).

---

## Tasks / Subtasks

- [x] Implémenter application matrice intra-type (transition gravité)
- [x] Implémenter application matrice inter-type (influence croisée)
- [x] Implémenter application matrice voisin (effet spatial)
- [x] Implémenter application saisonnalité (facteurs par saison)
- [x] Implémenter fonction `calculer_probabilite_incidents_J1()` (combinaison toutes matrices)
- [x] Charger matrices depuis pré-calculs (Story 1.4.4.1)
- [x] Tests : intra-type (transitions gravité correctes)
- [x] Tests : inter-type (influence croisée, ex. incendie → accidents)
- [x] Tests : voisin (effet augmentation si >5 incidents voisins)
- [x] Tests : saisonnalité (facteurs par saison appliqués)
- [x] Tests : combinaison (ordre d'application correct)
- [x] Tests : probabilités finales (valeurs [0, 1], cohérence)

---

## Dev Notes

### Architecture Context

- **Matrices fixes** : Pré-calculées (Story 1.4.4.1) et chargées une seule fois au démarrage
- **Application séquentielle** : Ordre d'application important (intra → inter → voisin → saisonnalité)
- **Probabilités de base** : Vecteurs statiques (Story 1.3) servent de point de départ
- **Sans variables d'état** : Les variables d'état dynamiques seront intégrées dans Story 1.4.4.4

### Source Tree

```
src/core/probability/
├── __init__.py
├── _loader.py               # load_matrices_for_probability (intra, inter, voisin, saison)
├── matrix_applicator.py     # apply_intra_type, apply_inter_type, apply_voisin, apply_saisonnalite
└── probability_calculator.py  # calculer_probabilite_incidents_J1()

tests/core/probability/
└── test_probability.py      # tests intra, inter, voisin, saison, combinaison, loader, IV1–IV2
```

### Flux de Calcul

```
Probabilités de base (vecteurs statiques)
    │
    ├─ Application matrice intra-type
    │  └─ prob_intra = prob_base × matrice_intra_type
    │
    ├─ Application matrice inter-type
    │  └─ prob_inter = prob_intra + matrice_inter_type
    │
    ├─ Application matrice voisin
    │  └─ prob_voisin = prob_inter × (1 + effet_voisin)
    │
    └─ Application saisonnalité
       └─ prob_saison = prob_voisin × facteur_saison
```

### Dependencies

- Story 1.4.4.1 (matrices fixes) : Charge toutes les matrices pré-calculées
- Story 1.3 (vecteurs statiques) : Probabilités de base
- Story 2.2.1 (génération vecteurs) : Utilisera cette fonction

### Testing Standards

- Tests unitaires : Vérifier application de chaque matrice
- Tests de validation : Ordre d'application, probabilités [0, 1], cohérence
- Tests d'intégration : Combinaison toutes matrices
- Framework : pytest
- Emplacement : `tests/core/probability/test_*.py`

---

## Dev Agent Record

### Agent Model Used
_Implémentation via src/core/probability + tests_

### Debug Log References
_Aucun._

### Completion Notes List

- **Intra-type** : `apply_intra_type(prob_base, incidents, matrice)`. Ligne = gravité dominante (bénin/moyen/grave) ; `prob_new = prob_base × ligne`, somme conservée, clamp [0,1].
- **Inter-type** : `apply_inter_type` ajoute des deltas depuis les autres types (influence[type_cible][type_source][g] × min(total_source, 3)), clamp [0,1].
- **Voisin** : `apply_voisin` pondère incidents des 8 voisins (grave×1, moyen×0.5, bénin×0.2) ; si total > seuil (5) → ×(1 + 0.1), clamp [0,1].
- **Saisonnalité** : `apply_saisonnalite` multiplie par facteur (hiver, intersaison, ete) par type.
- **calculer_probabilite_incidents_J1** : enchaîne intra → inter → voisin → saisonnalité. Entrées : `prob_base[mz][type]`, `incidents_J[mz][type]=(n_b,n_m,n_g)`, matrices, `saison`, `microzone_ids`. Sortie : `prob_modulees[mz][type]=(p_b,p_m,p_g)` dans [0,1].
- **Loader** : `load_matrices_for_probability(source_dir)` charge les 4 matrices depuis pickle (Story 1.4.4.1).
- **Sans variables d'état** : pas d’utilisation trafic / incidents nuit / alcool (Story 1.4.4.4).

### File List

| Fichier | Modifié / Créé |
|---------|----------------|
| `src/core/probability/__init__.py` | Créé |
| `src/core/probability/_loader.py` | Créé |
| `src/core/probability/matrix_applicator.py` | Créé |
| `src/core/probability/probability_calculator.py` | Créé |
| `tests/core/probability/test_probability.py` | Créé |

### Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 29 Jan 2026 | 1.0 | Création story suite au découpage 1.4.4 | PM |
| 29 Jan 2026 | 1.1 | Implémentation : applicators, calculator, loader, tests (IV1–IV2) | Dev |

---

## Références

- **Documentation découpage** : `story/1.4.4-DECOUPAGE-STORIES.md`
- **Diagramme découpage** : `story/1.4.4-DIAGRAMME-DECOUPAGE.md`
- **Documentation architecture** : `docs/architecture/impact-decoupage-1.4.4.md`
- **Story matrices fixes** : `story/1.4.4.1-precompute-matrices-correlation.md`
- **Story génération vecteurs** : `story/2.2.1-generation-vecteurs-journaliers.md`
