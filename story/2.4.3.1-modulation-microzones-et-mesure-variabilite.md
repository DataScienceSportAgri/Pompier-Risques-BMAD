# Story 2.4.3.1 : Vecteurs statiques — lissage des différences entre microzones et mesure de la variabilité

**Status:** Draft  
**Epic:** Epic 2 - Système de Simulation et Prédiction  
**Story Number:** 2.4.3.1

---

## Story

**As a** équipe produit / développeur,  
**I want** lisser légèrement les vecteurs statiques après leur chargement pour réduire les différences trop fortes entre microzones, et disposer d’un test de mesure de cette variabilité,  
**so that** la simulation reste réaliste spatialement sans écarts excessifs entre microzones et que la dispersion soit quantifiable et reproductible.

---

## Contexte

- Les **vecteurs statiques** (Story 2.2.10, Story 1.3) sont chargés depuis `vecteurs_statiques.pkl` par `StaticVectorLoader` et servent à calculer les intensités de base λ_base(τ,g) et à influencer les régimes cachés.
- Constat : les **différences entre microzones** sont **trop fortes** ; il faut les **lisser légèrement après chargement** (pas l’effet voisins du MatrixModulator). Le lissage doit réduire l’écart entre les valeurs par microzone sans effacer les disparités.

---

## Acceptance Criteria

1. **Lissage après chargement** : Après le chargement des vecteurs statiques (`StaticVectorLoader.load_static_vectors` ou juste après dans le constructeur), un **lissage léger** est appliqué pour réduire les différences entre microzones (ex. mélange avec la moyenne globale : `v_lissé = α × v_brut + (1 − α) × moyenne_globale` avec α configurable, ou lissage spatial par voisins). Les valeurs stockées dans `self.vecteurs_statiques` sont les valeurs **déjà lissées**.
2. **Config** : Le degré de lissage est piloté par la config (ex. `config/config.yaml` : section `vecteurs_statiques` ou `static_vectors` avec paramètre type `lissage_alpha` ou `smoothing_strength`). Valeur par défaut : lissage léger (ex. α = 0.85 pour garder 85 % de la valeur brute).
3. **Test de mesure de la variabilité** : Un **test automatisé** (ou script reproductible) mesure la **variabilité entre microzones** sur les vecteurs statiques (ex. écart-type des valeurs par type/gravité sur l’ensemble des microzones, avant/après lissage). Le test doit être exécutable en CI ou en local et produire une métrique (ou assertion) exploitable.
4. **Documentation** : Les choix (paramètres de lissage, formule) sont décrits en Dev Notes ; le test est référencé (emplacement, commande).
5. **Non-régression** : L’API `StaticVectorLoader` et les appels existants (GenerationService, SimulationService) restent valides ; seules les valeurs internes des vecteurs statiques sont lissées.

---

## Integration Verification

IV1: Après lissage, l’écart-type des valeurs de vecteurs statiques entre microzones (par type/gravité) est **inférieur** à celui des valeurs brutes (mesure reproductible).  
IV2: Le test de mesure de la variabilité s’exécute sans erreur et produit une métrique (ou passe/échoue selon un seuil documenté).

---

## Tasks / Subtasks

- [ ] Définir la formule de lissage (mélange avec moyenne globale vs lissage spatial voisins) et l’appliquer dans `StaticVectorLoader` après chargement (ou dans une méthode dédiée appelée après `load_static_vectors`).
- [ ] Exposer le paramètre de lissage dans la config (`config.yaml`) et le faire remonter jusqu’au `StaticVectorLoader` (option constructeur ou méthode de post-traitement).
- [ ] Implémenter le test de mesure de la variabilité entre microzones (métrique + script ou test pytest) et documenter la formule / le seuil.
- [ ] Vérifier la non-régression (runs, intensités de base, régimes) et mettre à jour les Dev Notes.

---

## Dev Notes

### Architecture Context

- **Vecteurs statiques** : Story 2.2.10, Story 1.3 — chargés depuis `data/source_data/vecteurs_statiques.pkl` ; format `Dict[microzone_id, Dict[type_incident, tuple(bénin, moyen, grave)]]`.
- **Implémentation actuelle** : `src/core/generation/static_vector_loader.py` — `load_static_vectors()` puis stockage dans `self.vecteurs_statiques` ; pas de lissage aujourd’hui.
- **Objectif** : Appliquer un lissage **après** chargement pour réduire les écarts entre microzones tout en conservant une différenciation (lissage léger).

### Source Tree

```
config/
└── config.yaml              # Section vecteurs_statiques / static_vectors (lissage_alpha ou équivalent)

src/core/generation/
└── static_vector_loader.py  # Lissage après load_static_vectors (ou dans __init__ après chargement)

tests/
└── (test mesure variabilité — ex. test_static_vectors_variabilite.py)
```

### Formule de lissage (suggestion)

- **Option A (moyenne globale)** : Pour chaque microzone, type et gravité :  
  `v_lissé = alpha * v_brut + (1 - alpha) * moyenne_globale_type_gravité`  
  avec `moyenne_globale_type_gravité` = moyenne de cette composante sur toutes les microzones. Alpha ≈ 0.8–0.9 pour un lissage léger.
- **Option B (spatial)** : Pour chaque microzone, mélanger avec la moyenne des microzones voisines (nécessite graphe voisinage). À préciser si données voisins disponibles au chargement.

### Métrique « variabilité entre microzones »

- Pour chaque (type, gravité), calculer l’écart-type des valeurs sur l’ensemble des microzones. Métrique agrégée : moyenne de ces écarts-types, ou max. Comparer avant/après lissage dans le test (assertion : variabilité après lissage < variabilité avant, ou borne supérieure documentée).

### Dependencies

- Story 2.2.10 (utilisation vecteurs statiques, intensités de base, régimes)
- Story 1.3 (pré-calcul vecteurs statiques, vecteurs_statiques.pkl)
- Story 2.4.3 (simulation et visualisation)
- Story 2.4.2 (orchestration)

---

## Change Log

| Date       | Version | Description                    | Author |
|------------|---------|--------------------------------|--------|
| 30 Jan 2026| 1.0     | Création story (après 2.4.3)  | PM     |
| 30 Jan 2026| 1.1     | Recentrage sur vecteurs statiques + lissage après chargement (pas effet voisins) | PM     |
