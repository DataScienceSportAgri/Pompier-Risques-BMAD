# Story 2.4.5.2 : Liste morts et blessés graves sous la carte + détail Golden Hour

**Status:** Draft  
**Epic:** Epic 2 - Système de Simulation et Prédiction  
**Story Number:** 2.4.5.2

---

## Story

**As a** utilisateur,  
**I want** que le process recueille chaque semaine tous les morts et blessés graves calculés (arrondissement > 1), affiche deux listes sous la carte (Morts / Blessés graves), et permette de consulter pour chacun le détail du calcul Golden Hour,  
**so that** je vois en temps réel les cas graves et j’inspecte le raisonnement (trajet, temps, tirage) qui a conduit au statut mort ou blessé grave.

---

## Acceptance Criteria

### A. Collecte en cours de simulation

1. **Chaque semaine** (ou à chaque mise à jour jour par jour), le process **récupère** tous les incidents ayant donné un **mort** ou un **blessé grave**, avec **filtre arrondissement > 1** (exclure l’arrondissement 1).
2. Les incidents sont enregistrés avec : jour (numéro J), microzone, arrondissement, type (accident, incendie, agression), statut (mort / blessé grave), et les données nécessaires pour recalculer ou afficher le Golden Hour (caserne, hôpital, temps trajet, tirage aléatoire, seuil).
3. La liste est **cumulée** sur la durée du run affiché (ou réinitialisée au début d’un nouveau run selon specs).

### B. Affichage sous la carte

4. **Sous la carte** (zone dédiée dans le layout Streamlit), deux **listes** distinctes :
   - **Morts** : chaque ligne = un incident mortel (arrondissement > 1), avec au minimum : jour (J), arrondissement, microzone, type.
   - **Blessés graves** : même format pour chaque blessé grave (arrondissement > 1).
5. Les entrées sont triées par **jour croissant** (optionnel : regroupement par semaine). Chaque entrée est **cliquable** ou **dépliable** (expander / bouton « Détail »).

### C. Détail Golden Hour au clic

6. **Au clic** (ou à l’ouverture de l’expander) sur une entrée « Mort » ou « Blessé grave », afficher le **détail du calcul Golden Hour** pour cet incident :
   - Microzone concernée, caserne mobilisée, hôpital cible ;
   - **Temps de trajet** caserne → microzone puis microzone → hôpital (ou total Golden Hour) ;
   - **Tirage aléatoire** et **seuil** ayant conduit au résultat (mort ou blessé grave) ;
   - Autres paramètres utiles (ex. gravité de base, délai).
7. Affichage dans un **expander**, **modal** ou **panneau** sous l’entrée, sans quitter la page. Référence claire : run, jour J, arrondissement.

### D. Technique et non-régression

8. **Source** : `SimulationState`, `CasualtyCalculator`, `GoldenHourCalculator` ; s’assurer que chaque décision mort/blessé grave (arrondissement > 1) est **traçable** (log ou structure en mémoire) avec les infos Golden Hour.
9. Si le fichier ou les logs ne contiennent pas encore le détail (tirage, seuil), **documenter** et prévoir extension (champ optionnel « N/A » en attendant).
10. **Tests manuels** : lancer un run, vérifier que les listes sous la carte se remplissent (morts, blessés graves, arrondissement > 1), ouvrir le détail Golden Hour pour plusieurs entrées, pas de régression sur la carte et le reste de l’UI.

---

## Integration Verification

IV1: Chaque semaine du run, les morts et blessés graves (arrondissement > 1) sont collectés et apparaissent dans les deux listes sous la carte.  
IV2: Les listes « Morts » et « Blessés graves » sont distinctes et triées (ex. par jour).  
IV3: Au clic sur une entrée, le détail Golden Hour s’affiche (temps trajet, tirage, seuil).  
IV4: Pas de régression sur l’affichage de la carte, de la simulation ou des features hebdo.

---

## Tasks / Subtasks

- [ ] Dans le process (simulation), collecter chaque mort et chaque blessé grave avec arrondissement > 1 et les métadonnées Golden Hour (microzone, caserne, hôpital, temps, tirage, seuil)
- [ ] Exposer ou créer une structure en mémoire / log (run, jour, liste morts, liste blessés graves) consommable par l’UI
- [ ] Ajouter sous la carte deux zones : liste « Morts », liste « Blessés graves » (entrées cliquables / expandables)
- [ ] Implémenter au clic sur une entrée l’affichage du détail Golden Hour (temps trajet, tirage, seuil, caserne, hôpital)
- [ ] Gérer l’absence de données détail (afficher « N/A » ou message explicite)
- [ ] Tests manuels : collecte, listes, détail Golden Hour, non-régression

---

## Dev Notes

### Architecture Context

- **Golden Hour** : Story 2.2.3 — temps caserne → microzone → hôpital ; décision mort/blessé grave selon seuils et tirage (Story 2.2.4).
- **CasualtyCalculator** : produit les morts et blessés graves ; à instrumenter ou à logger pour exposer microzone, caserne, hôpital, temps, random, seuil.
- **Layout** : Story 2.4.1 — la zone « sous la carte » peut être un bloc Streamlit (colonnes ou section) dédié, scrollable si les listes sont longues.

### Filtre arrondissement > 1

- Exclure uniquement l’arrondissement 1 ; tous les autres (2 à 20) sont inclus dans les listes. Raison possible : réduction du bruit ou règle métier à confirmer.

### Source Tree

```
src/ui/web_app.py                # Listes sous la carte, clic → détail Golden Hour
src/services/                    # CasualtyCalculator, log / structure casualties
src/core/golden_hour/            # GoldenHourCalculator (temps trajets)
```

### Implémentation suggérée

- **Collecte** : à chaque fin de jour ou de semaine dans la boucle de simulation, interroger `state.casualties_state` (ou équivalent) pour les incidents « mort » / « blessé grave » dont `arrondissement > 1` ; les ajouter à une liste en session (`st.session_state["liste_morts"]`, `st.session_state["liste_blesses_graves"]`) avec les champs nécessaires au détail.
- **Listes sous la carte** : `st.expander("Morts")` et `st.expander("Blessés graves")` contenant des lignes (jour, arr., microzone, type) ; chaque ligne avec un bouton ou expander enfant « Voir calcul Golden Hour ».
- **Détail** : afficher dans l’expander enfant : microzone, caserne, hôpital, temps trajet (min ou décomposé), tirage aléatoire, seuil, résultat (mort / blessé grave).

### Données nécessaires

- Pour chaque incident mort/blessé grave : `jour`, `microzone_id`, `arrondissement`, `type_incident`, `statut` (mort | blessé_grave), `caserne_id`, `hopital_id`, `temps_trajet_min`, `random_draw`, `seuil` (et éventuellement `gravite_base`). Si certains champs ne sont pas encore persistés, les ajouter dans le calcul (CasualtyCalculator / GoldenHourCalculator) et les passer à la structure d’affichage.

### Testing Standards

- Tests manuels : run avec incidents graves, vérifier listes sous la carte, ouverture détail Golden Hour, cohérence des valeurs.
- Non-régression : carte, simulation, ML, features hebdo.
- Documenter les champs « N/A » si des données ne sont pas encore disponibles.

---

## Change Log

| Date       | Version | Description        | Author |
|------------|---------|--------------------|--------|
| 03 Feb 2026 | 1.0     | Création story     | PM     |
| 03 Feb 2026 | 1.1     | Réécriture : collecte par semaine, listes sous la carte, détail Golden Hour au clic (arrondissement > 1) | PM     |
