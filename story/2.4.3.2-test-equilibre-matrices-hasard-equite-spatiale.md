# Story 2.4.3.2 : Test équilibre matrices/hasard et équité spatiale (toutes microzones actives et vides)

**Status:** Draft  
**Epic:** Epic 2 - Système de Simulation et Prédiction  
**Story Number:** 2.4.3.2

---

## Story

**As a** équipe produit / développeur,  
**I want** vérifier l'intégralité du pattern de correspondance entre les matrices (gravité, croisée, voisins) et le hasard, et m'assurer que toutes les microzones vivent au moins 1 événement et sont vides au moins 10 jours sur 200,  
**so that** le système reste équilibré spatialement (pas de microzones systématiquement surchargées ou vides) et que le hasard intervienne suffisamment pour éviter les effets de surenchère.

---

## Contexte

- **Matrices de modulation** (Story 2.2.9, Story 1.4.4.3) : facteur gravité (historique 7 jours), facteur croisé (corrélations inter-types), facteur voisins (8 zones radius 1). Ces matrices **amplifient** les probabilités selon l'historique et le voisinage.
- **Constat** : le hasard n'intervient **pas assez** ; certaines microzones n'ont **rien** (vides en permanence) alors que d'autres ont **tout** (surchargées) à cause d'**effets de surenchère** (cascading effects) : une microzone avec incidents → facteur voisins augmente → voisins ont plus d'incidents → effet boule de neige.
- **Objectif** : sur **200 jours** de simulation, **toutes les microzones** doivent :
  1. Vivre **au moins 1 événement** (incident bénin, moyen ou grave, n'importe quel type).
  2. Être **vides** (aucun incident) **au moins 10 jours** (pas de surcharge permanente).

---

## Acceptance Criteria

1. **Test de mesure sur 200 jours** : Un **test automatisé** (ou script reproductible) exécute une simulation de **200 jours** (1 run) et mesure pour chaque microzone :
   - **Nombre total de jours avec au moins 1 incident** (benin, moyen ou grave, tous types confondus).
   - **Nombre total de jours vides** (aucun incident).
   - **Nombre total d'incidents** sur les 200 jours.
2. **Critère équité spatiale** : À la fin des 200 jours, **toutes les microzones** (100 microzones Paris) doivent satisfaire :
   - **Au moins 1 jour avec incident** (≥ 1 incident sur 200 jours).
   - **Au moins 10 jours vides** (≥ 10 jours sans aucun incident sur 200 jours).
   Si une microzone ne satisfait pas ces critères, le test **échoue** ou **alerte** (log / assertion).
3. **Métrique influence matrices vs hasard** : Le test calcule une **métrique d'équilibre** (suggestion : variance du nombre d'incidents par microzone, ou coefficient de Gini, ou ratio max/min) pour quantifier la **dispersion spatiale**. Une dispersion trop élevée indique un déséquilibre (effet de surenchère). La métrique doit être **documentée** (formule, seuil acceptable).
4. **Ajustement si nécessaire** : Si le test échoue (microzones vides ou surchargées), la story demande d'**ajuster** les paramètres (ex. augmenter le poids du hasard dans la génération, réduire les caps des facteurs matrices, ajouter un plancher de probabilité minimale par microzone). Les ajustements sont **documentés** en Dev Notes.
5. **Reproductibilité** : Le test utilise un **seed fixe** pour être reproductible ; exécutable en CI ou en local ; produit un rapport (log ou fichier) avec les métriques par microzone et la métrique d'équilibre globale.

---

## Integration Verification

IV1: Le test s'exécute sans erreur sur 200 jours et produit un rapport avec les métriques par microzone.  
IV2: Toutes les microzones satisfont les critères (≥ 1 jour avec incident, ≥ 10 jours vides) ; si non, le test échoue et documente les microzones problématiques.  
IV3: La métrique d'équilibre (variance, Gini, ou équivalent) est calculée et documentée ; si hors seuil, des ajustements sont proposés.

---

## Tasks / Subtasks

- [x] Implémenter le test de mesure sur 200 jours : exécuter une simulation (1 run, seed fixe), collecter par microzone le nombre de jours avec incident, le nombre de jours vides, le total d'incidents.
- [x] Implémenter les assertions : vérifier que toutes les microzones ont ≥ 1 jour avec incident et ≥ 10 jours vides ; si échec, logger les microzones problématiques.
- [x] Calculer la métrique d'équilibre (variance, Gini, ratio max/min) et documenter la formule / le seuil acceptable.
- [x] Si le test échoue : analyser les causes (effet de surenchère, hasard insuffisant) et proposer des ajustements (paramètres matrices, caps, plancher de probabilité, poids du hasard).
- [x] Documenter les ajustements et les résultats dans les Dev Notes ; rendre le test reproductible (seed fixe, exécutable en CI).

---

## Dev Notes

### Architecture Context

- **Matrices de modulation** : Story 2.2.9 (facteur gravité, croisé, voisins), Story 1.4.4.3 (application matrices fixes). Formule : `λ_calibrated = λ_base × facteur_statique × facteur_gravité × facteur_croisé × facteur_voisins × facteur_long`. Caps : Min ×0.1, Max ×3.0.
- **Génération** : Story 2.2.1 (génération vecteurs journaliers), Zero-Inflated Poisson (Story 2.2.1, `zero_inflated_poisson.py`). Le hasard intervient via la loi de Poisson (λ → nombre d'incidents), mais les matrices **modulent** λ, ce qui peut réduire l'effet du hasard.
- **Problème** : effet de surenchère (cascading) : microzone avec incidents → facteur voisins augmente → voisins ont plus d'incidents → boucle de rétroaction positive → certaines microzones surchargées, d'autres vides.
- **Solution possible** : augmenter le poids du hasard (ex. ajouter un terme aléatoire indépendant des matrices), réduire les caps (ex. Max ×2.0 au lieu de ×3.0), ajouter un plancher de probabilité minimale (ex. λ_min = 0.05 même si matrices donnent 0), ou lisser les facteurs voisins (déjà abordé dans Story 2.4.3.1 pour vecteurs statiques, ici pour facteur voisins dynamique).

### Source Tree

```
tests/
└── test_equilibre_matrices_hasard.py   # Test 200 jours, équité spatiale, métrique équilibre

src/core/generation/
└── vector_generator.py                 # Génération vecteurs (Zero-Inflated Poisson, matrices)
└── matrix_modulator.py                 # Calcul facteurs matrices (gravité, croisé, voisins)
└── intensity_calculator.py             # Calcul λ_calibrated
```

### Métrique d'équilibre (suggestion)

- **Variance du nombre d'incidents par microzone** : `Var(total_incidents_par_mz)` ; variance élevée = déséquilibre (certaines microzones ont beaucoup, d'autres peu).
- **Coefficient de Gini** : mesure d'inégalité (0 = parfaite égalité, 1 = inégalité maximale) ; calculé sur la distribution du nombre d'incidents par microzone.
- **Ratio max/min** : `max(total_incidents_par_mz) / min(total_incidents_par_mz)` ; ratio élevé = déséquilibre.
- À choisir et documenter dans le test (avec seuil acceptable, ex. Gini < 0.3 ou Var < X).

### Ajustements possibles (si test échoue)

1. **Augmenter le poids du hasard** : ajouter un terme aléatoire indépendant des matrices dans le calcul de λ (ex. `λ_final = α × λ_calibrated + (1 - α) × λ_base_random` avec α < 1).
2. **Réduire les caps** : Max ×2.0 au lieu de ×3.0 (limite l'amplification par les matrices).
3. **Plancher de probabilité** : `λ_min = 0.05` pour toutes les microzones (même si matrices donnent 0, il y a toujours une probabilité minimale).
4. **Lisser les facteurs voisins** : réduire l'effet du facteur voisins (déjà abordé dans Story 2.4.3.1 pour vecteurs statiques ; ici pour facteur voisins dynamique, ex. `facteur_voisins_lissé = 1.0 + (facteur_voisins - 1.0) × 0.5`).
5. **Réinitialisation périodique** : tous les N jours, réinitialiser les régimes ou les historiques pour éviter les boucles de rétroaction (option plus radicale).

### Dependencies

- Story 2.2.9 (matrices de modulation, facteur voisins)
- Story 1.4.4.3 (application matrices fixes)
- Story 2.2.1 (génération vecteurs journaliers, Zero-Inflated Poisson)
- Story 2.4.3 (simulation et visualisation)
- Story 2.4.3.1 (lissage vecteurs statiques — principe similaire pour lisser facteurs dynamiques)

---

## Dev Agent Record

### Completion Notes

- Test implémenté dans `tests/test_equilibre_matrices_hasard.py` pour **toutes les combinaisons** Scénario (Pessimiste, Standard, Optimiste) × Variabilité Locale (Faible, Moyenne, Forte) — 9 combinaisons au total.
- Chaque combinaison exécute une simulation de 200 jours (seed fixe 42), mesure par microzone : jours avec incident, jours vides, total d'incidents.
- Assertions : toutes les microzones ≥ 1 jour avec incident et ≥ 10 jours vides ; en cas d'échec, message d'assertion liste les microzones problématiques.
- Métrique d'équilibre : coefficient de Gini + variance du nombre d'incidents par microzone + ratio max/min ; seuil alerte Gini > 0,35 (log warning).
- Reproductibilité : seed 42 ; marqueur `@pytest.mark.slow` pour les 9 tests paramétrés ; rapport via logging (Gini, Var, max/min, total_incidents).
- Conftest racine `tests/conftest.py` ajouté pour enregistrer le marqueur `slow`.

### File List

- `tests/test_equilibre_matrices_hasard.py` (nouveau)
- `tests/conftest.py` (nouveau)

---

## Change Log

| Date       | Version | Description                    | Author |
|------------|---------|--------------------------------|--------|
| 30 Jan 2026| 1.0     | Création story (après 2.4.3.1) | PM     |
| 30 Jan 2026| 1.1     | Implémentation test 9 combinaisons Scénario × Variabilité | Dev    |
