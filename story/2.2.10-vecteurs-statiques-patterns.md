# Story 2.2.10 : Utilisation vecteurs statiques pour régimes et intensités de base

**Status:** Draft  
**Epic:** Epic 2 - Système de Simulation et Prédiction  
**Story Number:** 2.2.10

---

## Story

**As a** système de simulation,  
**I want** utiliser les vecteurs statiques pré-calculés pour initialiser les intensités de base λ_base(τ,g) et influencer les probabilités des régimes cachés,  
**so that** chaque microzone démarre avec des caractéristiques réalistes basées sur les patterns Paris et les données socio-économiques.

---

## Contexte et Clarifications

Cette story complète l'intégration des vecteurs statiques dans le moteur de simulation :

- **Phase 1 (Story 1.3)** : Les vecteurs statiques ont été **pré-calculés** et sauvegardés dans `data/source_data/vecteurs_statiques.pkl`
- **Phase 1 (Story 1.4.4.6)** : Les **patterns dynamiques** (7j, 60j) sont appliqués aux probabilités modulées
- **Cette story (2.2.10)** : Utilise les vecteurs statiques comme **point de départ** pour :
  1. Calculer les **intensités de base** λ_base(τ,g) utilisées dans le modèle Zero-Inflated Poisson (Story 2.2.1)
  2. Influencer les **probabilités des régimes cachés** (Stable/Détérioration/Crise) selon les caractéristiques de la microzone

**Distinction importante :**
- Les vecteurs statiques servent de **base initiale** pour λ_base (avant application des matrices, variables d'état, patterns)
- Les patterns dynamiques (Story 1.4.4.6) **modulent** les probabilités déjà calculées (après application des matrices)

---

## Acceptance Criteria

1. **Chargement vecteurs statiques** : Chargement depuis `data/source_data/vecteurs_statiques.pkl` (pré-calculés Epic 1, Story 1.3)
2. **Intensités de base λ_base(τ,g)** : Utilisation des vecteurs statiques pour calculer les intensités de base par type d'incident (τ) et niveau de gravité (g) :
   - `λ_base(τ,g) = vecteur_statique[microzone][type][gravité]` (conversion en intensité Poisson)
   - Ces intensités servent de point de départ avant application des matrices (Story 1.4.4.3), variables d'état (Story 1.4.4.4), et patterns (Story 1.4.4.6)
3. **Influence sur régimes** : Les vecteurs statiques modifient les probabilités initiales des régimes cachés (Stable/Détérioration/Crise) :
   - Microzones avec vecteurs statiques élevés (tous types) → probabilité Crise augmentée
   - Microzones avec vecteurs statiques faibles → probabilité Stable augmentée
   - Formule : `prob_regime[microzone] = prob_regime_base × facteur_vecteurs_statiques(microzone)`
4. **Intégration dans moteur de simulation** : Les intensités de base et probabilités régimes sont utilisées dans Story 2.2.1 (génération vecteurs journaliers)
5. Tests unitaires : chargement vecteurs statiques, calcul intensités de base, influence régimes, intégration moteur.

---

## Integration Verification

IV1: Vecteurs statiques chargés depuis `data/source_data/vecteurs_statiques.pkl` sans erreur.  
IV2: Intensités de base λ_base(τ,g) calculées correctement à partir des vecteurs statiques.  
IV3: Probabilités régimes influencées par les vecteurs statiques (cohérence : zones à risque → plus de Crise).  
IV4: Intensités de base utilisables par Story 2.2.1 (génération vecteurs journaliers).

---

## Tasks / Subtasks

- [x] Implémenter chargement vecteurs statiques depuis `data/source_data/vecteurs_statiques.pkl` (Epic 1, Story 1.3)
- [x] Implémenter conversion vecteurs statiques → intensités de base λ_base(τ,g)
- [x] Implémenter calcul facteur d'influence sur régimes à partir des vecteurs statiques
- [x] Implémenter modification probabilités régimes (Stable/Détérioration/Crise) selon vecteurs statiques
- [x] Intégrer intensités de base dans Story 2.2.1 (génération vecteurs journaliers)
- [x] Intégrer probabilités régimes modifiées dans Story 2.2.1 (gestion régimes cachés)
- [x] Tests : chargement vecteurs statiques (structure, dimensions, valeurs)
- [x] Tests : calcul intensités de base (conversion correcte, valeurs positives)
- [x] Tests : influence régimes (cohérence : zones à risque → plus de Crise)
- [x] Tests : intégration moteur (intensités utilisables par 2.2.1)

---

## Dev Notes

### Architecture Context

- **Vecteurs statiques** : 3 vecteurs (agressions, incendies, accidents) × 3 valeurs (bénin, moyen, grave) par microzone, **pré-calculés** dans Story 1.3
- **Intensités de base** : Point de départ pour le calcul des probabilités d'incidents (avant matrices, variables d'état, patterns)
- **Régimes cachés** : Stable (80%), Détérioration (15%), Crise (5%) - probabilités modifiées selon caractéristiques microzone
- **Ordre d'application** : Vecteurs statiques → λ_base → Matrices (1.4.4.3) → Variables d'état (1.4.4.4) → Patterns (1.4.4.6) → Génération (2.2.1)
- **Chargement** : Depuis `data/source_data/vecteurs_statiques.pkl` (pré-calculés Epic 1, Story 1.3)

### Source Tree

```
src/core/generation/
├── vector_generator.py      # Génération vecteurs J+1 (Story 2.2.1)
└── static_vector_loader.py  # Chargement et utilisation vecteurs statiques (NOUVEAU)

src/core/evolution/
└── regime_manager.py        # Gestion régimes cachés (Story 2.2.1)

data/source_data/
└── vecteurs_statiques.pkl   # Vecteurs statiques pré-calculés (Epic 1, Story 1.3)
```

### Dependencies

- **Vecteurs statiques** : Epic 1, Story 1.3 (pré-calculés) - **DONNÉES**
- **Régimes** : Story 2.2.1 (gestion régimes cachés) - **UTILISATION**
- **Intensités** : Story 2.2.1 (calcul intensités calibrées) - **UTILISATION**
- **Matrices** : Story 1.4.4.3 (application matrices fixes) - **APRÈS** cette story
- **Patterns** : Story 1.4.4.6 (application patterns dynamiques) - **APRÈS** cette story

### Flux de Calcul Complet

```
1. CHARGEMENT (Story 2.2.10)
   └─ Vecteurs statiques depuis data/source_data/vecteurs_statiques.pkl
   
2. CALCUL INTENSITÉS DE BASE (Story 2.2.10)
   └─ λ_base(τ,g) = conversion(vecteur_statique[microzone][type][gravité])
   
3. CALCUL PROBABILITÉS RÉGIMES (Story 2.2.10)
   └─ prob_regime = prob_regime_base × facteur_vecteurs_statiques(microzone)
   
4. APPLICATION MATRICES (Story 1.4.4.3)
   └─ λ_modulé = λ_base × matrices (intra-type, inter-type, voisin, saisonnalité)
   
5. INTÉGRATION VARIABLES D'ÉTAT (Story 1.4.4.4)
   └─ λ_modulé = λ_modulé × facteurs_variables_etat (trafic, incidents nuit, alcool)
   
6. APPLICATION PATTERNS (Story 1.4.4.6)
   └─ prob_finale = prob_modulée + amplitudes_patterns (7j, 60j)
   
7. GÉNÉRATION (Story 2.2.1)
   └─ Vecteurs J+1 générés selon prob_finale et régimes
```

### Utilisation vecteurs statiques

```python
# Chargement (Story 2.2.10)
from src.core.generation.static_vector_loader import load_static_vectors

vecteurs_statiques = load_static_vectors("data/source_data/vecteurs_statiques.pkl")
# Format: Dict[microzone_id, Dict[type_incident, tuple(bénin, moyen, grave)]]

# Calcul intensités de base (Story 2.2.10)
def calculer_intensites_base(microzone_id, type_incident):
    """
    Convertit les vecteurs statiques en intensités de base λ_base(τ,g).
    """
    vecteur = vecteurs_statiques[microzone_id][type_incident]
    # Conversion : vecteur (valeurs 0-1) → intensité Poisson (λ > 0)
    lambda_base = {
        'benin': vecteur[0] * 0.5,   # Intensité bénin
        'moyen': vecteur[1] * 1.0,   # Intensité moyen
        'grave': vecteur[2] * 2.0    # Intensité grave (plus rare mais plus impactant)
    }
    return lambda_base

# Influence sur régimes (Story 2.2.10)
def calculer_facteur_regimes(microzone_id, vecteurs_statiques):
    """
    Calcule le facteur d'influence des vecteurs statiques sur les probabilités régimes.
    """
    # Somme des vecteurs statiques (tous types, toutes gravités)
    somme_totale = sum(
        sum(vecteurs_statiques[microzone_id][type])
        for type in ['agressions', 'incendies', 'accidents']
    )
    
    # Normalisation (moyenne par microzone = 1.0)
    moyenne_globale = 1.0  # À calculer depuis toutes les microzones
    facteur = somme_totale / moyenne_globale
    
    # Influence sur probabilités régimes
    if facteur > 1.5:  # Zone à risque élevé
        return {'Stable': 0.6, 'Deterioration': 0.25, 'Crise': 0.15}  # Plus de Crise
    elif facteur < 0.7:  # Zone calme
        return {'Stable': 0.9, 'Deterioration': 0.08, 'Crise': 0.02}  # Plus de Stable
    else:  # Zone moyenne
        return {'Stable': 0.8, 'Deterioration': 0.15, 'Crise': 0.05}  # Base
```

### Distinction avec Autres Stories

**Story 1.3 (Phase 1)** : **Pré-calcul** des vecteurs statiques → données sauvegardées en pickle  
**Story 2.2.10 (Phase 2)** : **Utilisation** des vecteurs statiques dans le moteur de simulation

**Story 1.4.4.6** : Application des **patterns dynamiques** (7j, 60j) sur les probabilités **déjà modulées**  
**Story 2.2.10** : Utilisation des vecteurs statiques comme **point de départ** pour λ_base (avant toutes les modulations)

**Story 2.2.1** : Génération des vecteurs journaliers avec régimes cachés  
**Story 2.2.10** : Fournit les **intensités de base** et **probabilités régimes initiales** utilisées par 2.2.1

### Testing Standards

- Tests unitaires : Chargement vecteurs statiques, calcul intensités de base, influence régimes
- Tests de validation : Structure correcte (3×3 par microzone), valeurs positives, cohérence (zones à risque → plus de Crise)
- Tests d'intégration : Intensités de base utilisables par Story 2.2.1, probabilités régimes cohérentes
- Framework : pytest
- Emplacement : `tests/core/generation/test_static_vector_loader.py`

---

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (via Cursor)

### Completion Notes
- ✅ StaticVectorLoader : Classe complète pour charger et utiliser vecteurs statiques
- ✅ Chargement vecteurs statiques : Depuis `data/source_data/vecteurs_statiques.pkl` avec gestion formats variés
- ✅ Conversion intensités de base : `λ_base(τ,g)` par gravité (bénin×0.5, moyen×1.0, grave×2.0)
- ✅ Calcul facteur régimes : Normalisation par moyenne globale, facteur >1.5 = zone à risque, <0.7 = zone calme
- ✅ Probabilités régimes modifiées : Zone à risque → 60% Stable, 25% Détérioration, 15% Crise | Zone calme → 90% Stable, 8% Détérioration, 2% Crise
- ✅ Intégration GenerationService : Chargement StaticVectorLoader, utilisation pour intensités de base et probabilités régimes
- ✅ Intégration RegimeManager : Méthode `initialize_regime()` accepte probabilités personnalisées
- ✅ Rétrocompatibilité : `get_base_intensities_dict()` pour compatibilité avec `load_base_intensities()` existant
- ✅ Tests unitaires complets : Chargement, conversion intensités, facteur régimes, probabilités régimes, format rétrocompatibilité

### File List
**Nouveaux fichiers créés :**
- `src/core/generation/static_vector_loader.py` - StaticVectorLoader pour utilisation vecteurs statiques
- `tests/core/generation/test_static_vector_loader.py` - Tests StaticVectorLoader

**Fichiers modifiés :**
- `src/core/generation/generation_service.py` - Intégration StaticVectorLoader, initialisation régimes avec probabilités modifiées
- `src/core/generation/regime_manager.py` - Méthode `initialize_regime()` accepte probabilités personnalisées

### Debug Log References
- Chargement vecteurs statiques : Gestion formats variés (dict, tuple, objet Vector), extraction (bénin, moyen, grave)
- Conversion intensités : Facteurs FACTEUR_BENIN=0.5, FACTEUR_MOYEN=1.0, FACTEUR_GRAVE=2.0
- Facteur régimes : Normalisation par moyenne globale, seuils 1.5 (risque) et 0.7 (calme)
- Probabilités régimes : Normalisation pour somme = 1.0

### Status
Ready for Review

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 28 Jan 2026 | 1.0 | Création story | PM |
| 29 Jan 2026 | 1.1 | Clarification : distinction avec Story 1.3 (pré-calcul) et Story 1.4.4.6 (patterns), focus sur intensités de base et régimes | PM |
| 29 Jan 2026 | 1.2 | Implémentation complète - Utilisation vecteurs statiques pour intensités de base et régimes | Dev (James) |
