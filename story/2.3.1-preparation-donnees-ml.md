# Story 2.3.1 : Préparation données ML — fenêtres glissantes

**Status:** Draft  
**Epic:** Epic 2 - Système de Simulation et Prédiction  
**Story Number:** 2.3.1

---

## Story

**As a** système ML,  
**I want** préparer données ML avec fenêtres glissantes et arrondissements adjacents (1 central + 4 voisins, **dernière semaine** chacun → **90 features**),  
**so that** les modèles peuvent être entraînés sur format correct.

---

## Acceptance Criteria

1. **Features ML** : **1 arrondissement central** (18 features, **dernière semaine**) + **4 voisins** (chacun 18 features, **dernière semaine**) = 18 + 4×18 = **90 features**.
2. Arrondissements adjacents **définis en dur** dans le code (cf. contraintes techniques).
3. DataFrame final pour ML : 90 colonnes (features) + 1 colonne label (score ou classe).
4. **Workflow** : **50 runs** au total. **1 run** (affiché à l'écran) + **49 runs** en calcul seul pour générer les données ML — pas de « 5 runs puis 49 ». Central et voisins : **dernière semaine** pour les features.
5. Tests unitaires : fenêtres glissantes, adjacents, format DataFrame.

---

## Integration Verification

IV1: Vérifier que les fenêtres glissantes sont créées correctement (central + 4 voisins, dernière semaine chacun → 90 features)  
IV2: Vérifier que les arrondissements adjacents sont corrects (géographiquement adjacents)  
IV3: Vérifier que le DataFrame final est dans format utilisable pour scikit-learn (pas de NaN, types numériques)

---

## Tasks / Subtasks

- [ ] Implémenter fenêtres glissantes (1 central + 4 voisins)
- [ ] Implémenter sélection dernière semaine pour chaque arrondissement (central et voisins)
- [ ] Implémenter agrégation 90 features (18 central + 4×18 voisins)
- [ ] Implémenter arrondissements adjacents (définis en dur dans code)
- [ ] Implémenter création DataFrame final (90 colonnes features + 1 colonne label)
- [ ] Implémenter workflow 50 runs (1 affiché + 49 calcul seul)
- [ ] Implémenter agrégation données 50 runs
- [ ] Tests : fenêtres glissantes, adjacents, format DataFrame

---

## Dev Notes

### Architecture Context

- **90 features** : 1 central (18) + 4 voisins (4×18) = 90 (FR7)
- **Dernière semaine** : Features de la dernière semaine pour central et voisins
- **Arrondissements adjacents** : Définis en dur dans le code (contraintes techniques)
- **Workflow** : 50 runs (1 affiché + 49 calcul seul) pour générer données ML
- **Format** : DataFrame utilisable pour scikit-learn (pas de NaN, types numériques)

### Source Tree

```
src/services/
└── ml_service.py            # Préparation données ML

src/data/
└── adjacents.py             # Arrondissements adjacents (en dur)

data/intermediate/
└── run_XXX/
    └── ml/
        └── features_labels.pkl  # DataFrame final ML
```

### Dependencies

- Features : Story 2.2.5 (18 features hebdomadaires)
- Labels : Story 2.2.6 (labels mensuels)
- Adjacents : Définis en dur dans code

### Structure 90 features

- **Central (18)** : 18 features dernière semaine arrondissement central
- **Voisin 1 (18)** : 18 features dernière semaine voisin 1
- **Voisin 2 (18)** : 18 features dernière semaine voisin 2
- **Voisin 3 (18)** : 18 features dernière semaine voisin 3
- **Voisin 4 (18)** : 18 features dernière semaine voisin 4
- **Total** : 90 features

### Testing Standards

- Tests unitaires : Fenêtres glissantes, adjacents, format DataFrame
- Tests de validation : Format utilisable scikit-learn (pas de NaN, types numériques)
- Framework : pytest
- Emplacement : `tests/services/test_ml_service.py`

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 28 Jan 2026 | 1.0 | Création story | PM |
