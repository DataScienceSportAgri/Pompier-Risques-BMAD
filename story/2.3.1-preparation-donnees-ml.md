# Story 2.3.1 : Préparation données ML — fenêtres glissantes

**Status:** Draft  
**Epic:** Epic 2 - Système de Simulation et Prédiction  
**Story Number:** 2.3.1

---

## Story

**As a** système ML,  
**I want** préparer données ML avec fenêtres glissantes et arrondissements adjacents (1 central + **moyenne des 4 voisins** dernière semaine) → **90 features**, **so that** les modèles peuvent être entraînés sur format correct avec nomenclature commune (sem_m1..m4, voisins_moy).

---

## Acceptance Criteria

1. **Features ML** : **90 features** = **central sem_m1** (dernière semaine / week -1, 18) + **central sem_m2, sem_m3, sem_m4** (3 semaines précédentes, 54) + **voisins_moy sem_m1** (moyenne des 4 arrondissements adjacents dernière semaine, 18) = 18 + 54 + 18 = **90 features**. **Nomenclature** : sem_m1 = dernière semaine (week -1), sem_m2..m4 = 3 semaines précédentes ; voisins_moy = moyenne des 4 adjacents (commune à tous les arrondissements, pas de numéro ni côté dans les noms).
2. Arrondissements adjacents **définis en dur** dans le code (cf. contraintes techniques).
3. DataFrame final pour ML : 90 colonnes (features) + 1 colonne label (score ou classe).
4. **Workflow** : **50 runs** au total. **1 run** (affiché à l'écran) + **49 runs** en calcul seul (peuvent être lancés en parallèle pour économiser espace disque). **Agrégation** : DataFrame géant avec les 50 runs (pas d'agrégation statique, concaténation des DataFrames).
5. Tests unitaires : fenêtres glissantes, adjacents, format DataFrame.

---

## Integration Verification

IV1: Vérifier que les fenêtres glissantes sont créées correctement (central sem_m1..m4 + voisins_moy sem_m1 → 90 features)  
IV2: Vérifier que les arrondissements adjacents sont corrects (géographiquement adjacents)  
IV3: Vérifier que le DataFrame final est dans format utilisable pour scikit-learn (pas de NaN, types numériques)

---

## Tasks / Subtasks

- [x] Implémenter fenêtres glissantes (1 central + 4 voisins)
- [x] Implémenter sélection dernière semaine pour central (18 features)
- [x] Implémenter sélection 3 semaines précédentes pour central (18 × 3 = 54 features)
- [x] Implémenter moyenne des 4 voisins dernière semaine (18 features voisins_moy_sem_m1)
- [x] Implémenter agrégation 90 features (18 central sem_m1 + 54 central sem_m2..m4 + 18 voisins_moy sem_m1)
- [x] Implémenter arrondissements adjacents (définis en dur dans code)
- [x] Implémenter création DataFrame final (90 colonnes features + 1 colonne label, nomenclature sem_m1..m4, voisins_moy)
- [x] Implémenter workflow 50 runs (1 affiché + 49 calcul seul, parallélisation possible)
- [x] Implémenter agrégation données 50 runs (DataFrame géant, concaténation, pas d'agrégation statique)
- [x] Tests : fenêtres glissantes, adjacents, format DataFrame

---

## Dev Agent Record

### Agent Model Used
(Cursor / Agent dev)

### Completion Notes
- ✅ MLService : fenêtres glissantes 4 semaines, 90 features (central sem_m1..m4 + voisins_moy sem_m1), nomenclature commune
- ✅ adjacents.py : ADJACENTS_PARIS et get_voisins() pour 20 arrondissements (4 voisins chacun)
- ✅ workflow_50_runs : concaténation des DataFrames par run_id ; save/load features_labels.pkl
- ✅ Tests : adjacents, fenêtres glissantes, format DataFrame (90 + label)

### File List
**Nouveaux fichiers créés :**
- `src/data/__init__.py` - Package data (exports adjacents)
- `src/data/adjacents.py` - Arrondissements adjacents Paris (en dur)
- `src/services/ml_service.py` - MLService préparation données ML 90 features + label (nomenclature sem_m1..m4, voisins_moy)
- `tests/services/test_ml_service.py` - Tests unitaires MLService et adjacents

**Fichiers modifiés :**
- `src/services/__init__.py` - Export MLService
- `story/2.3.1-preparation-donnees-ml.md` - Tasks cochées, Dev Agent Record, correction 144 colonnes

---

## Dev Notes

### Architecture Context

- **90 features** : central sem_m1 (18) + central sem_m2..m4 (54) + voisins_moy sem_m1 (18) = 90
- **Nomenclature** : sem_m1 = dernière semaine (week -1), sem_m2..m4 = 3 semaines précédentes ; voisins_moy = moyenne des 4 adjacents (commune à tous les arrondissements)
- **Arrondissements adjacents** : Définis en dur dans le code (contraintes techniques)
- **Workflow** : 50 runs (1 affiché + 49 calcul seul) pour générer données ML
- **Format** : DataFrame utilisable pour scikit-learn (pas de NaN, types numériques)

### Source Tree

```
src/services/
└── ml_service.py            # Préparation données ML

src/data/
└── adjacents.py             # Arrondissements adjacents (en dur)

data/intermediate/
└── run_XXX/
    └── ml/
        └── features_labels.pkl  # DataFrame final ML
```

### Dependencies

- Features : Story 2.2.5 (18 features hebdomadaires)
- Labels : Story 2.2.6 (labels mensuels)
- Adjacents : Définis en dur dans code

### Structure 90 features

- **Central sem_m1 (18)** : 18 features dernière semaine (week -1) arrondissement central
- **Central sem_m2, sem_m3, sem_m4 (54)** : 18 × 3 semaines précédentes arrondissement central = 54 features
- **Voisins_moy sem_m1 (18)** : moyenne des 4 arrondissements adjacents dernière semaine = 18 features
- **Total** : 18 + 54 + 18 = **90 features** ✓
- **Nomenclature** : commune à tous les arrondissements (pas de numéro ni côté dans les noms)

### Testing Standards

- Tests unitaires : Fenêtres glissantes, adjacents, format DataFrame
- Tests de validation : Format utilisable scikit-learn (pas de NaN, types numériques)
- Framework : pytest
- Emplacement : `tests/services/test_ml_service.py`

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 28 Jan 2026 | 1.0 | Création story | PM |
| 28 Jan 2026 | 2.0 | Modification : 144 features (4 semaines × 4 voisins + 1 central), DataFrame géant 50 runs, parallélisation | PM |
| 29 Jan 2026 | 2.1 | Implémentation : MLService, adjacents, tests, Dev Agent Record | Dev |
| 29 Jan 2026 | 2.2 | 90 features (voisins_moy au lieu de 4×18), nomenclature sem_m1..m4, voisins_moy | Dev |
