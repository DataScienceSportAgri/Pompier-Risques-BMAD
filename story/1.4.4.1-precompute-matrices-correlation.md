# Story 1.4.4.1 : Pré-calcul matrices de corrélation fixes

**Status:** Done  
**Epic:** Epic 1 - Pré-calculs  
**Story Number:** 1.4.4.1

---

## Story

**As a** système de simulation,  
**I want** toutes les matrices de corrélation fixes pré-calculées et sauvegardées,  
**so that** le moteur J+1 (Epic 2) peut utiliser ces matrices pour moduler les probabilités d'incidents sans recalculer à chaque jour.

---

## Contexte et Clarifications

Cette story fait partie du découpage de la story 1.4.4 (matrices de corrélation et patterns dynamiques). Suite aux clarifications de l'orchestrator et de l'architecte, il a été identifié que :

- **Matrices fixes (pré-calculées)** : Ces matrices sont calculées une seule fois et stockées dans `data/source_data/`. Elles ne changent pas pendant la simulation.
- **Variables d'état dynamiques (runtime)** : Les variables d'état (trafic, incidents nuit, incidents alcool) évoluent J→J+1 et sont gérées dans l'Epic 2 (Story 1.4.4.2).
- **Patterns dynamiques (runtime)** : Les patterns sont détectés et appliqués pendant la simulation (Epic 2, Stories 1.4.4.5 et 1.4.4.6).

**Cette story se concentre uniquement sur les matrices fixes pré-calculées.**

---

## Acceptance Criteria

1. Sous-partie du script unique : calcul de toutes les matrices fixes nécessaires pour la prédiction J→J+1.
2. **Matrices intra-type** : Matrices de transition 3×3 par type d'incident (agressions, incendies, accidents) et par microzone. Probabilités de transition entre niveaux de gravité (bénin → moyen → grave).
3. **Matrices inter-type** : Matrices d'influence croisée entre types d'incidents (ex. incendie → accidents ×1.3).
4. **Matrices voisin** : Matrices d'influence spatiale (8 voisins + poids) pour chaque microzone.
5. **Matrices saisonnalité** : Facteurs saisonniers par type d'incident (hiver, été, intersaison).
6. **Matrices trafic** : Règles de transition pour le trafic (utilisées par Story 1.4.4.2 pour l'évolution du trafic).
7. **Matrices alcool/nuit** : Probabilités de base pour incidents alcool et incidents nuit par type.
8. Sorties dans `data/source_data/` (pickle ; format standardisé et documenté).
9. Vérifications : structure des matrices (dimensions, types), valeurs cohérentes (probabilités entre 0-1, sommes = 1 pour intra-type), pas de NaN.

---

## Integration Verification

IV1: Fichiers pickle lisibles par un script Python.  
IV2: Matrices chargées correctement par le DataLoaderAdapter (Epic 2).  
IV3: Coûts mémoire / temps raisonnables sur machine standard.

---

## Tasks / Subtasks

- [x] Implémenter calcul matrices intra-type (3×3 par type × microzone)
- [x] Implémenter calcul matrices inter-type (influence croisée)
- [x] Implémenter calcul matrices voisin (8 voisins + poids)
- [x] Implémenter calcul matrices saisonnalité (facteurs par saison)
- [x] Implémenter calcul matrices trafic (règles de transition)
- [x] Implémenter calcul matrices alcool/nuit (probabilités de base)
- [x] Intégrer dans script unique (`run_precompute.py`)
- [x] Sauvegarder toutes les matrices en pickle (format standardisé)
- [x] Tests : validation structure, valeurs, cohérence, chargement

---

## Dev Notes

### Architecture Context

- **Séparation pré-calculs / runtime** : Ces matrices sont **fixes** et pré-calculées. Elles ne changent pas pendant la simulation.
- **Variables d'état dynamiques** : L'évolution J→J+1 des variables d'état (trafic, incidents nuit, incidents alcool) est gérée dans Epic 2 (Story 1.4.4.2).
- **Application des matrices** : L'application de ces matrices dans le calcul des probabilités est gérée dans Epic 2 (Stories 1.4.4.3 et 1.4.4.4).
- **Format pickle standardisé** : Format documenté pour faciliter chargement/lecture par Epic 2.

### Source Tree

```
scripts/
├── run_precompute.py
└── precompute_matrices_correlation.py  # Module pour cette story

data/
└── source_data/
    ├── matrices_correlation_intra_type.pkl
    ├── matrices_correlation_inter_type.pkl
    ├── matrices_voisin.pkl
    ├── matrices_saisonnalite.pkl
    ├── matrices_trafic.pkl
    └── matrices_alcool_nuit.pkl
```

### Dependencies

- Story 1.2 (distances microzones) : Pour calculer les voisins (8 microzones alentours)
- Story 1.3 (vecteurs statiques) : Pour les probabilités de base utilisées dans certaines matrices
- Pandas : Manipulation données
- NumPy : Calculs matriciels

### Format des Matrices

#### Matrices intra-type
- **Format** : `Dict[microzone_id, Dict[type_incident, np.ndarray(3×3)]]`
- **Structure** : Matrice de transition 3×3 (bénin, moyen, grave)
- **Contrainte** : Somme de chaque ligne = 1 (probabilités de transition)

#### Matrices inter-type
- **Format** : `Dict[type_source, Dict[type_cible, float]]`
- **Structure** : Facteurs d'influence croisée (ex. incendie → accidents = 1.3)

#### Matrices voisin
- **Format** : `Dict[microzone_id, Dict[voisin_id, float]]`
- **Structure** : Poids d'influence pour chaque voisin (8 voisins max)

#### Matrices saisonnalité
- **Format** : `Dict[saison, Dict[type_incident, float]]`
- **Structure** : Facteurs saisonniers par type (hiver, été, intersaison)

#### Matrices trafic
- **Format** : `Dict[etat_trafic, Dict[etat_trafic_suivant, float]]`
- **Structure** : Probabilités de transition entre états de trafic

#### Matrices alcool/nuit
- **Format** : `Dict[type_incident, Dict[alcool|nuit, float]]`
- **Structure** : Probabilités de base pour incidents alcool et incidents nuit

### Testing Standards

- Tests unitaires : Vérifier calcul de chaque type de matrice
- Tests de validation : Structure (dimensions, types), valeurs (probabilités 0-1, sommes = 1), cohérence (voisins existent, pas de cycles)
- Tests de chargement : Vérifier que les matrices peuvent être chargées depuis pickle
- Framework : pytest
- Emplacement : `tests/scripts/test_precompute_matrices_correlation.py`

---

## Dev Agent Record

### Agent Model Used
_Implementation via existant + tests_

### Debug Log References
_Aucun._

### Completion Notes List

- Script `precompute_matrices_correlation.py` existant : calcul des 6 matrices (intra, inter, voisin, saisonnalité, trafic, alcool/nuit), écriture temp patterns, génération pattern 7j/60j, règles effet augmentation et patterns. Toutes sauvegardées en pickle dans `data/source_data/`.
- Intégration dans `run_precompute.py` via `run_matrices_correlation` et `--only-matrices` / `--skip-matrices`.
- Tests dans `tests/scripts/test_precompute_matrices_correlation.py` : structure, valeurs (0–1, sommes = 1, pas de NaN), chargement pickle. Pré-calcul en tmp pour IV1.
- Formats réels : intra `Dict[mz, Dict[type, ndarray 3×3]]` ; inter par microzone ; voisin `voisins` + `poids_influence` ; trafic/alcool/saison par microzone. DataLoaderAdapter (Epic 2) devra charger ces structures.

### File List

| Fichier | Modifié / Créé |
|---------|----------------|
| `scripts/precompute_matrices_correlation.py` | Existant (Story 1.4.4) |
| `scripts/run_precompute.py` | Existant (intégration matrices) |
| `tests/scripts/test_precompute_matrices_correlation.py` | Créé |
| `data/source_data/*.pkl` (matrices) | Créés par precompute |

### Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 29 Jan 2026 | 1.0 | Création story suite au découpage 1.4.4 | PM |
| 29 Jan 2026 | 1.1 | Implémentation story : tests validation structure/valeurs/chargement, tasks complétées | Dev |

---

## Références

- **Documentation découpage** : `story/1.4.4-DECOUPAGE-STORIES.md`
- **Documentation architecture** : `docs/architecture/impact-decoupage-1.4.4.md`
- **Script existant** : `scripts/precompute_matrices_correlation.py` (à compléter)
- **Documentation système** : `docs/architecture/matrices-correlation-system.md`
