# Story 2.5.1 : Validation et tests de cohérence

**Status:** Draft  
**Epic:** Epic 2 - Système de Simulation et Prédiction  
**Story Number:** 2.5.1

---

## Story

**As a** développeur/QA,  
**I want** valider cohérence données et patterns avec tests automatisés,  
**so that** le système génère des données réalistes et cohérentes.

---

## Acceptance Criteria

1. Tests validation cohérence données (par arrondissement, sur **800 jours agrégés sur plusieurs runs**) : **au moins 1 mort**, **moins de 500 morts**. Si 0 mort ou ≥ 500 morts → **alerte (message uniquement, pas d'action automatique)**.
2. Tests validation patterns : vérifier qu'il n'y a pas de **propagation directionnelle** indésirable — un effet d'événement peut se propager dans une direction (bas, gauche, droite) et modifier pendant quelques jours les matrices de création de vecteurs (proportions alcool/nuit ou vecteurs des 3 types d'incidents).
3. Tests unitaires pour chaque composant critique: Vecteurs, Golden Hour, Features, Labels, ML
4. Tests d'intégration: Workflow complet simulation → features → labels → ML (Story 2.5.3)
5. **Tests validation cohérence automatiques** : Exécutés automatiquement **après chaque run** (800 jours agrégés, 1-500 morts).
6. Suivi graphiques: Nombre de morts, évolution temporelle, validation visuelle
7. Documentation tests: README tests, commentaires, exemples
8. Couverture tests: Au minimum composants critiques (vecteurs, Golden Hour, features, ML)

---

## Integration Verification

IV1: Vérifier que les tests de validation détectent bien problèmes (tests avec données invalides)  
IV2: Vérifier que les tests d'intégration passent (workflow complet)  
IV3: Vérifier que la couverture tests est suffisante (composants critiques testés)

---

## Tasks / Subtasks

- [ ] Implémenter tests validation cohérence données (800 jours agrégés, 1-500 morts)
- [ ] Implémenter système alertes (message uniquement, pas d'action automatique)
- [ ] Implémenter tests validation patterns (pas de propagation directionnelle indésirable)
- [ ] Implémenter tests unitaires composants critiques (Vecteurs, Golden Hour, Features, Labels, ML)
- [ ] Implémenter tests validation cohérence automatiques (exécutés après chaque run)
- [ ] Implémenter tests d'intégration (workflow complet - Story 2.5.3)
- [ ] Implémenter suivi graphiques (nombre de morts, évolution temporelle)
- [ ] Créer documentation tests (README tests, commentaires, exemples)
- [ ] Vérifier couverture tests (composants critiques)

---

## Dev Notes

### Architecture Context

- **Validation cohérence** : 800 jours agrégés, 1-500 morts par arrondissement (NFR5)
- **Alertes** : Message uniquement, pas d'action automatique
- **Validation patterns** : Pas de propagation directionnelle indésirable
- **Tests unitaires** : Composants critiques (Vecteurs, Golden Hour, Features, Labels, ML)
- **Tests d'intégration** : Workflow complet
- **Couverture** : Au minimum composants critiques (stratégie tests validée)

### Source Tree

```
tests/
├── core/
│   ├── generation/
│   ├── golden_hour/
│   └── events/
├── services/
│   ├── feature_calculator/
│   ├── label_calculator/
│   └── ml_service/
└── integration/
    └── workflow_complet/

docs/
└── testing-strategy.md      # Stratégie tests (Architecture)
```

### Dependencies

- Tous les composants : Stories 2.2.x, 2.3.x (composants à tester)
- pytest : Framework de tests
- Coverage : Outil couverture tests

### Tests validation cohérence

```python
# Test 800 jours agrégés
def test_coherence_morts_800_jours():
    morts_agreges = agreger_morts_plusieurs_runs(800_jours)
    for arr in arrondissements:
        assert 1 <= morts_agreges[arr] < 500, f"Alerte: {arr} a {morts_agreges[arr]} morts"
```

### Testing Standards

- Tests unitaires : Composants critiques
- Tests d'intégration : Workflow complet
- Tests de validation : Cohérence données, patterns
- Couverture : 70% pour composants critiques (stratégie tests validée)
- Framework : pytest
- Emplacement : `tests/` (structure par composant)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 28 Jan 2026 | 1.0 | Création story | PM |
