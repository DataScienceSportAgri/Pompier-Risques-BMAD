# Story 2.2.8 : Événements positifs et règle prix m²

**Status:** Draft  
**Epic:** Epic 2 - Système de Simulation et Prédiction  
**Story Number:** 2.2.8

---

## Story

**As a** système de simulation,  
**I want** générer événements positifs et appliquer la règle prix m²,  
**so that** travaux, casernes, etc. et corrélations socio-économiques sont reflétés.

---

## Acceptance Criteria

1. Événements positifs (Fin travaux, Nouvelle caserne, Amélioration matériel) ; **génération après les vecteurs** (impact sur vecteurs J+1).
2. **Effets** : **réduction des intensités** et amélioration des transitions (pas d'« annulation » binaire des négatifs ; modulation). Les événements positifs ont un impact sur les vecteurs **J+1** (jour suivant).
3. **Prix m²** : `facteur_prix_m2 = prix_m2_microzone / prix_m2_moyen_paris` ; `prob_agression_modulée = prob_agression_base / facteur_prix_m2` ; diminution des probabilités Détérioration/Crise si prix m² élevé. Données depuis pré-calculs (Epic 1).
4. Tests unitaires : effets positifs, modulation agressions et régimes.

---

## Integration Verification

IV1: Événements positifs réduisent bien les intensités ; règle prix m² appliquée.  
IV2: Données prix m² chargées correctement (depuis `data/source_data/`).

---

## Tasks / Subtasks

- [x] Implémenter événements positifs (Fin travaux, Nouvelle caserne, Amélioration matériel) - Déjà existantes Story 2.1.1
- [x] Implémenter génération événements positifs (après vecteurs, impact sur J+1)
- [x] Implémenter effets événements positifs (réduction intensités, amélioration transitions)
- [x] Implémenter chargement prix m² depuis `data/source_data/` (Epic 1, Story 1.3)
- [x] Implémenter calcul facteur prix m² (`prix_m2_microzone / prix_m2_moyen_paris`)
- [x] Implémenter modulation probabilités agressions (`prob_agression_base / facteur_prix_m2`)
- [x] Implémenter diminution probabilités Détérioration/Crise si prix m² élevé
- [x] Tests : effets positifs, modulation agressions et régimes

---

## Dev Notes

### Architecture Context

- **Événements positifs** : Fin travaux, Nouvelle caserne, Amélioration matériel (FR14)
- **Génération** : Après les vecteurs (impact sur vecteurs J+1)
- **Effets** : Réduction intensités, amélioration transitions (modulation, pas annulation binaire)
- **Règle prix m²** : Modulation probabilités agressions et régimes (FR17)
- **Prix m²** : Données pré-calculées Epic 1, Story 1.3

### Source Tree

```
src/core/events/
├── positive_event.py        # PositiveEvent (ABC)
├── fin_travaux.py          # FinTravaux
├── nouvelle_caserne.py     # NouvelleCaserne
└── amelioration_materiel.py # AmeliorationMateriel

data/source_data/
└── prix_m2.pkl             # Prix m² pré-calculés (Epic 1, Story 1.3)
```

### Dependencies

- PositiveEvent base : Story 2.1.1 (classes de base)
- Prix m² : Epic 1, Story 1.3 (données pré-calculées)
- Régimes : Story 2.2.1 (modification probabilités Détérioration/Crise)
- Intensités : Story 2.2.1 (réduction intensités)

### Formule prix m²

```python
# Facteur prix m²
facteur_prix_m2 = prix_m2_microzone / prix_m2_moyen_paris

# Modulation probabilités agressions
prob_agression_modulée = prob_agression_base / facteur_prix_m2

# Diminution probabilités régimes si prix m² élevé
if facteur_prix_m2 > 1.2:  # Quartier riche
    prob_deterioration *= 0.8
    prob_crise *= 0.7
```

### Testing Standards

- Tests unitaires : Effets positifs, modulation agressions et régimes
- Tests de validation : Règle prix m² appliquée correctement
- Framework : pytest
- Emplacement : `tests/core/events/`

---

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (via Cursor)

### Completion Notes
- ✅ Classes événements positifs : Déjà implémentées Story 2.1.1 (FinTravaux, NouvelleCaserne, AmeliorationMateriel)
- ✅ PositiveEventGenerator : Génération événements positifs avec Poisson 60 jours (moyenne 1 événement tous les 60 jours)
- ✅ Effets événements positifs : Réduction intensités pour J+1 via `get_effets_reduction_actifs()`
- ✅ PrixM2Modulator : Chargement prix m² depuis `data/source_data/prix_m2.pkl`, calcul facteur, modulation probabilités
- ✅ Modulation agressions : `prob_agression_modulée = prob_agression_base / facteur_prix_m2`
- ✅ Modulation régimes : Diminution probabilités Détérioration/Crise si facteur_prix_m2 > 1.2 (quartier riche)
- ✅ Intégration GenerationService : Génération événements positifs après événements graves, application effets J+1
- ✅ Intégration VectorGenerator : Application effets réduction et modulation prix m² dans génération vecteurs
- ✅ Support affichage UI : Méthodes `to_dict()` et `get_positive_events_for_day()` déjà présentes dans EventsState
- ✅ Tests unitaires complets : PositiveEventGenerator, PrixM2Modulator, effets réduction, modulation prix m²

### File List
**Nouveaux fichiers créés :**
- `src/core/events/positive_event_generator.py` - PositiveEventGenerator pour génération événements positifs
- `src/core/events/prix_m2_modulator.py` - PrixM2Modulator pour modulation prix m²
- `tests/core/events/test_positive_event_generator.py` - Tests PositiveEventGenerator et PrixM2Modulator

**Fichiers modifiés :**
- `src/core/generation/generation_service.py` - Intégration PositiveEventGenerator et PrixM2Modulator
- `src/core/generation/vector_generator.py` - Application effets réduction et modulation prix m²

### Debug Log References
- Génération événements positifs : Poisson 60 jours, choix type selon probabilités (40% fin travaux, 35% nouvelle caserne, 25% amélioration matériel)
- Effets réduction : Application sur J+1 (jour suivant déclenchement), cumul par arrondissement
- Modulation prix m² : Facteur = prix_m2_microzone / prix_m2_moyen_paris, modulation agressions et régimes

### Status
Ready for Review

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 28 Jan 2026 | 1.0 | Création story | PM |
| 29 Jan 2026 | 1.1 | Implémentation complète - Événements positifs et règle prix m² | Dev (James) |
