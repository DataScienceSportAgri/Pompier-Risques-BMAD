# DÃ©coupage Intelligent Story 1.4.4 - Recommandations Orchestrator

**Date :** 29 Janvier 2026  
**Auteur :** BMad Orchestrator  
**Contexte :** Story 1.4.4 (Matrices de corrÃ©lation et patterns dynamiques) est trop large et complexe pour Ãªtre implÃ©mentÃ©e en une seule story.

---

## ğŸ¯ Analyse de la ComplexitÃ©

### ProblÃ¨mes IdentifiÃ©s

1. **Story trop large** : 8 Ã©pics diffÃ©rents, trop de responsabilitÃ©s
2. **Couplage fort** : Matrices fixes + Variables d'Ã©tat + Patterns + DÃ©tection
3. **DifficultÃ© de test** : Impossible de tester indÃ©pendamment chaque partie
4. **Risque de rÃ©gression** : Modifications dans une partie affectent tout le systÃ¨me

### Architecture Actuelle (d'aprÃ¨s `matrices-correlation-system.md`)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SYSTÃˆME 1 : MATRICES FIXES (PrÃ©-calculÃ©es)              â”‚
â”‚ - Intra-type (3Ã—3)                                       â”‚
â”‚ - Inter-type (influence croisÃ©e)                         â”‚
â”‚ - Voisin (8 microzones)                                  â”‚
â”‚ - SaisonnalitÃ©                                           â”‚
â”‚ - Trafic (rÃ¨gles de transition)                          â”‚
â”‚ - Alcool/Nuit (probabilitÃ©s de base)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SYSTÃˆME 2 : VARIABLES D'Ã‰TAT DYNAMIQUES (Runtime)       â”‚
â”‚ - Trafic (Ã©volue Jâ†’J+1)                                  â”‚
â”‚ - Incidents nuit (Ã©volue Jâ†’J+1)                          â”‚
â”‚ - Incidents alcool (Ã©volue Jâ†’J+1)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SYSTÃˆME 3 : PATTERNS DYNAMIQUES (Runtime)                â”‚
â”‚ - DÃ©tection (4jâ†’7j, 7j sans agressionâ†’60j)              â”‚
â”‚ - Application (modulation probabilitÃ©s)                   â”‚
â”‚ - Cycle de vie (dÃ©but, pic, fin)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“‹ DÃ©coupage ProposÃ© : 6 Stories Testables

### Principe de DÃ©coupage

1. **SÃ©paration des prÃ©-calculs et du runtime** : Matrices fixes vs Variables d'Ã©tat
2. **SÃ©paration des responsabilitÃ©s** : DÃ©tection vs Application
3. **TestabilitÃ©** : Chaque story peut Ãªtre testÃ©e indÃ©pendamment
4. **DÃ©pendances claires** : Ordre d'implÃ©mentation explicite

---

## Story 1.4.4.1 : Matrices de CorrÃ©lation Fixes (PrÃ©-calcul)

**Status :** Ã€ crÃ©er  
**ComplexitÃ© :** Moyenne  
**DurÃ©e estimÃ©e :** 3-5 jours

### Objectif

PrÃ©-calculer toutes les matrices fixes nÃ©cessaires pour la prÃ©diction Jâ†’J+1.

### Scope

- âœ… Matrices intra-type (3Ã—3 par type Ã— microzone)
- âœ… Matrices inter-type (influence croisÃ©e)
- âœ… Matrices voisin (8 voisins + poids)
- âœ… Matrices saisonnalitÃ©
- âœ… Matrices trafic (rÃ¨gles de transition)
- âœ… Matrices alcool/nuit (probabilitÃ©s de base)

### Livrables

- Script `precompute_matrices_correlation.py` (dÃ©jÃ  existant, Ã  complÃ©ter)
- Fichiers pickle dans `data/source_data/` :
  - `matrices_correlation_intra_type.pkl`
  - `matrices_correlation_inter_type.pkl`
  - `matrices_voisin.pkl`
  - `matrices_saisonnalite.pkl`
  - `matrices_trafic.pkl`
  - `matrices_alcool_nuit.pkl`

### Tests

- âœ… Validation structure des matrices (dimensions, types)
- âœ… Validation valeurs (probabilitÃ©s entre 0-1, sommes = 1 pour intra-type)
- âœ… Validation cohÃ©rence (voisins existent, pas de cycles)
- âœ… Tests de chargement pickle

### DÃ©pendances

- Story 1.2 (distances microzones) pour calcul voisins
- Story 1.3 (vecteurs statiques) pour probabilitÃ©s de base

### CritÃ¨res d'Acceptation

1. Toutes les matrices sont prÃ©-calculÃ©es et sauvegardÃ©es
2. Format pickle standardisÃ© et documentÃ©
3. Tests unitaires passent (100% couverture matrices)
4. Documentation : schÃ©ma de donnÃ©es pour chaque matrice

---

## Story 1.4.4.2 : Variables d'Ã‰tat Dynamiques - Ã‰volution

**Status :** Ã€ crÃ©er  
**ComplexitÃ© :** Moyenne  
**DurÃ©e estimÃ©e :** 3-4 jours

### Objectif

ImplÃ©menter l'Ã©volution Jâ†’J+1 des variables d'Ã©tat dynamiques (trafic, incidents nuit, incidents alcool).

### Scope

- âœ… Fonction `evoluer_trafic_J1()` : MÃ©moire + Influence incidents + AlÃ©atoire
- âœ… Fonction `evoluer_incidents_nuit_J1()` : MÃ©moire + CorrÃ©lations + SaisonnalitÃ©
- âœ… Fonction `evoluer_incidents_alcool_J1()` : MÃ©moire + CorrÃ©lations + SaisonnalitÃ©
- âœ… Structure de donnÃ©es pour variables d'Ã©tat dans Ã©tat de simulation

### Livrables

- Module `scripts/evolution_variables_etat.py`
- IntÃ©gration dans structure de simulation (Story 2.1.2)
- Tests unitaires pour chaque fonction d'Ã©volution

### Tests

- âœ… Test Ã©volution trafic : mÃ©moire, influence accidents, clamp [0,1]
- âœ… Test Ã©volution incidents nuit : mÃ©moire, corrÃ©lations inter-type, saisonnalitÃ©
- âœ… Test Ã©volution incidents alcool : mÃ©moire, corrÃ©lations, saisonnalitÃ© Ã©tÃ©
- âœ… Test cohÃ©rence : variables restent dans bornes attendues
- âœ… Test reproductibilitÃ© : avec seed fixe, rÃ©sultats identiques

### DÃ©pendances

- Story 1.4.4.1 (matrices fixes) : utilise matrices trafic, alcool/nuit
- Story 2.1.2 (structure simulation) : pour stocker variables d'Ã©tat

### CritÃ¨res d'Acceptation

1. Chaque variable Ã©volue selon ses propres rÃ¨gles
2. MÃ©moire et persistance fonctionnent (60-70%)
3. CorrÃ©lations inter-type appliquÃ©es correctement
4. SaisonnalitÃ© prise en compte (Ã©tÃ© = +20% nuit, +50% alcool accidents)
5. Tests unitaires passent avec couverture >90%

---

## Story 1.4.4.3 : Application Matrices Fixes aux ProbabilitÃ©s

**Status :** Ã€ crÃ©er  
**ComplexitÃ© :** Moyenne  
**DurÃ©e estimÃ©e :** 2-3 jours

### Objectif

ImplÃ©menter l'application des matrices fixes pour moduler les probabilitÃ©s d'incidents Jâ†’J+1.

### Scope

- âœ… Application matrice intra-type (transition gravitÃ©)
- âœ… Application matrice inter-type (influence croisÃ©e)
- âœ… Application matrice voisin (effet spatial)
- âœ… Application saisonnalitÃ©
- âœ… Fonction `calculer_probabilite_incidents_J1()` (sans variables d'Ã©tat)

### Livrables

- Module `scripts/application_matrices.py`
- Fonction principale combinant toutes les matrices
- Tests unitaires pour chaque type de matrice

### Tests

- âœ… Test intra-type : transitions gravitÃ© correctes
- âœ… Test inter-type : influence croisÃ©e (incendie â†’ accidents)
- âœ… Test voisin : effet d'augmentation si >5 incidents voisins
- âœ… Test saisonnalitÃ© : facteurs par saison appliquÃ©s
- âœ… Test combinaison : ordre d'application correct

### DÃ©pendances

- Story 1.4.4.1 (matrices fixes) : charge les matrices prÃ©-calculÃ©es
- Story 2.2.1 (gÃ©nÃ©ration vecteurs) : utilisera cette fonction

### CritÃ¨res d'Acceptation

1. Chaque matrice est appliquÃ©e dans le bon ordre
2. ProbabilitÃ©s modulÃ©es correctement (multiplication, addition selon type)
3. Effet d'augmentation voisin fonctionne (+0.1 si conditions)
4. Tests unitaires passent avec cas limites

---

## Story 1.4.4.4 : IntÃ©gration Variables d'Ã‰tat dans Calcul ProbabilitÃ©s

**Status :** Ã€ crÃ©er  
**ComplexitÃ© :** Faible-Moyenne  
**DurÃ©e estimÃ©e :** 2 jours

### Objectif

IntÃ©grer les variables d'Ã©tat dynamiques dans le calcul final des probabilitÃ©s.

### Scope

- âœ… IntÃ©gration trafic : +15% accidents si trafic > 0.7
- âœ… IntÃ©gration incidents nuit : +10% si incidents nuit > seuil
- âœ… IntÃ©gration incidents alcool : +8% si incidents alcool > seuil
- âœ… Mise Ã  jour `calculer_probabilite_incidents_J1()` avec variables d'Ã©tat

### Livrables

- Mise Ã  jour module `scripts/application_matrices.py`
- Tests d'intÃ©gration variables d'Ã©tat

### Tests

- âœ… Test trafic Ã©levÃ© : augmentation probabilitÃ©s accidents/agressions
- âœ… Test incidents nuit : augmentation si seuil dÃ©passÃ©
- âœ… Test incidents alcool : augmentation si seuil dÃ©passÃ©
- âœ… Test combinaison : toutes les variables ensemble

### DÃ©pendances

- Story 1.4.4.2 (Ã©volution variables d'Ã©tat) : variables Ã©voluÃ©es disponibles
- Story 1.4.4.3 (application matrices) : base de calcul probabilitÃ©s

### CritÃ¨res d'Acceptation

1. Variables d'Ã©tat influencent correctement les probabilitÃ©s
2. Seuils d'activation respectÃ©s
3. Combinaison avec matrices fixes fonctionne
4. Tests d'intÃ©gration passent

---

## Story 1.4.4.5 : DÃ©tection et Gestion Patterns Dynamiques

**Status :** Ã€ crÃ©er  
**ComplexitÃ© :** Moyenne  
**DurÃ©e estimÃ©e :** 4-5 jours

### Objectif

ImplÃ©menter la dÃ©tection et la gestion du cycle de vie des patterns (4jâ†’7j, 60j).

### Scope

- âœ… DÃ©tection pattern 4j : 1 agression 4 jours consÃ©cutifs
- âœ… DÃ©tection pattern 60j : aucune agression pendant 7 jours
- âœ… CrÃ©ation structure pattern (7j, 60j)
- âœ… Gestion cycle de vie : dÃ©but, pic (jour 3 pour 7j), fin
- âœ… Limitation Ã  3 patterns max par microzone
- âœ… Priorisation patterns (rÃ¨gle de prioritÃ©)

### Livrables

- Module `scripts/detection_patterns.py`
- Module `scripts/gestion_patterns.py`
- Structure de donnÃ©es patterns dans Ã©tat de simulation
- Tests unitaires dÃ©tection et gestion

### Tests

- âœ… Test dÃ©tection 4j : dÃ©tecte 4 jours consÃ©cutifs
- âœ… Test dÃ©tection 60j : dÃ©tecte 7 jours sans agression
- âœ… Test crÃ©ation pattern 7j : structure correcte, pic jour 3
- âœ… Test crÃ©ation pattern 60j : 3 phases (1-20, 21-40, 41-60)
- âœ… Test limitation : max 3 patterns par microzone
- âœ… Test priorisation : rÃ¨gles de prioritÃ© appliquÃ©es
- âœ… Test cycle de vie : pattern se termine aprÃ¨s durÃ©e

### DÃ©pendances

- Story 2.1.2 (structure simulation) : pour stocker patterns actifs
- Story 2.2.1 (gÃ©nÃ©ration vecteurs) : historique nÃ©cessaire pour dÃ©tection

### CritÃ¨res d'Acceptation

1. DÃ©tection patterns fonctionne correctement
2. Patterns crÃ©Ã©s avec structure correcte
3. Cycle de vie gÃ©rÃ© (dÃ©but, pic, fin)
4. Limitation Ã  3 patterns respectÃ©e
5. Tests unitaires passent avec cas limites

---

## Story 1.4.4.6 : Application Patterns dans Calcul ProbabilitÃ©s

**Status :** Ã€ crÃ©er  
**ComplexitÃ© :** Faible  
**DurÃ©e estimÃ©e :** 2 jours

### Objectif

IntÃ©grer l'application des patterns dynamiques dans le calcul final des probabilitÃ©s.

### Scope

- âœ… Application pattern 7j : +0.1 base, +0.15 pic jour 3
- âœ… Application pattern 60j : +0.05 (jours 1-20), -0.05 (jours 21-40), +0.1 (jours 41-60)
- âœ… IntÃ©gration dans `calculer_probabilite_incidents_J1()`

### Livrables

- Mise Ã  jour module `scripts/application_matrices.py`
- Tests d'intÃ©gration patterns

### Tests

- âœ… Test pattern 7j : amplitude base et pic appliquÃ©s
- âœ… Test pattern 60j : 3 phases appliquÃ©es selon jour
- âœ… Test combinaison : patterns + matrices + variables d'Ã©tat
- âœ… Test plusieurs patterns : combinaison correcte

### DÃ©pendances

- Story 1.4.4.5 (dÃ©tection patterns) : patterns actifs disponibles
- Story 1.4.4.4 (intÃ©gration variables) : calcul probabilitÃ©s complet

### CritÃ¨res d'Acceptation

1. Patterns appliquÃ©s avec amplitudes correctes
2. Pic jour 3 pour pattern 7j fonctionne
3. 3 phases pattern 60j appliquÃ©es selon jour
4. Tests d'intÃ©gration passent

---

## ğŸ“Š Ordre d'ImplÃ©mentation RecommandÃ©

```
1. Story 1.4.4.1 (Matrices fixes)
   â†“
2. Story 1.4.4.2 (Ã‰volution variables d'Ã©tat)
   â†“
3. Story 1.4.4.3 (Application matrices fixes)
   â†“
4. Story 1.4.4.4 (IntÃ©gration variables d'Ã©tat)
   â†“
5. Story 1.4.4.5 (DÃ©tection patterns) [peut Ãªtre en parallÃ¨le avec 1.4.4.3]
   â†“
6. Story 1.4.4.6 (Application patterns)
```

**Note :** Stories 1.4.4.3 et 1.4.4.5 peuvent Ãªtre dÃ©veloppÃ©es en parallÃ¨le car elles sont indÃ©pendantes.

---

## ğŸ§ª StratÃ©gie de Test Globale

### Tests Unitaires (par story)

- Chaque story a ses propres tests unitaires
- Couverture >90% pour chaque module
- Tests de cas limites et erreurs

### Tests d'IntÃ©gration

- **Test 1.4.4.1 â†’ 1.4.4.3** : Chargement matrices + application
- **Test 1.4.4.2 â†’ 1.4.4.4** : Ã‰volution variables + intÃ©gration
- **Test 1.4.4.5 â†’ 1.4.4.6** : DÃ©tection patterns + application
- **Test complet** : Toutes les stories ensemble (simulation Jâ†’J+1)

### Tests de RÃ©gression

- AprÃ¨s chaque story, vÃ©rifier que les stories prÃ©cÃ©dentes fonctionnent toujours
- Tests de non-rÃ©gression automatiques

---

## ğŸ¯ Avantages de ce DÃ©coupage

### 1. TestabilitÃ©

- âœ… Chaque story peut Ãªtre testÃ©e indÃ©pendamment
- âœ… Tests unitaires clairs par responsabilitÃ©
- âœ… Tests d'intÃ©gration progressifs

### 2. MaintenabilitÃ©

- âœ… Code modulaire et sÃ©parÃ© par responsabilitÃ©
- âœ… Modifications isolÃ©es (changer une matrice n'affecte pas les patterns)
- âœ… Documentation claire par story

### 3. Risque RÃ©duit

- âœ… DÃ©ploiement incrÃ©mental (chaque story est fonctionnelle)
- âœ… DÃ©tection d'erreurs tÃ´t (tests Ã  chaque Ã©tape)
- âœ… Rollback facile si problÃ¨me

### 4. ParallÃ©lisation

- âœ… Stories 1.4.4.3 et 1.4.4.5 peuvent Ãªtre dÃ©veloppÃ©es en parallÃ¨le
- âœ… RÃ©duction du temps total de dÃ©veloppement

---

## ğŸ“ Actions RecommandÃ©es

### ImmÃ©diat

1. âœ… **CrÃ©er les 6 nouvelles stories** (1.4.4.1 Ã  1.4.4.6)
2. âœ… **Mettre Ã  jour Story 1.4.4** : Marquer comme "DÃ©coupÃ©e" et rÃ©fÃ©rencer les sous-stories
3. âœ… **CrÃ©er template de story** : RÃ©utiliser structure pour cohÃ©rence

### Court Terme

1. âœ… **Commencer par Story 1.4.4.1** : Matrices fixes (dÃ©jÃ  partiellement implÃ©mentÃ©e)
2. âœ… **Valider dÃ©coupage** : Revue avec Ã©quipe avant implÃ©mentation
3. âœ… **CrÃ©er tests de non-rÃ©gression** : S'assurer que l'existant fonctionne

### Long Terme

1. âœ… **Documentation** : Mettre Ã  jour `matrices-correlation-system.md` avec rÃ©fÃ©rences aux stories
2. âœ… **IntÃ©gration continue** : Tests automatiques aprÃ¨s chaque story
3. âœ… **Monitoring** : VÃ©rifier performance et cohÃ©rence Ã  chaque Ã©tape

---

## ğŸ”— RÃ©fÃ©rences

- **Documentation systÃ¨me** : `docs/architecture/matrices-correlation-system.md`
- **Story actuelle** : `story/1.4.4-matrices-correlation-patterns.md`
- **Script existant** : `scripts/precompute_matrices_correlation.py`
- **Patterns rÃ©fÃ©rence** : `story/1.4-patterns-reference.md`

---

**Document crÃ©Ã© le :** 29 Janvier 2026  
**Version :** 1.0  
**Auteur :** BMad Orchestrator
